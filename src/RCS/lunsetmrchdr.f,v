head	1.20;
access;
symbols;
locks; strict;
comment	@c @;


1.20
date	2025.10.16.19.24.55;	author dean;	state Exp;
branches;
next	1.19;

1.19
date	2025.10.07.13.41.14;	author dean;	state Exp;
branches;
next	1.18;

1.18
date	2025.10.03.14.29.35;	author dean;	state Exp;
branches;
next	1.17;

1.17
date	2025.09.26.17.23.48;	author dean;	state Exp;
branches;
next	1.16;

1.16
date	2025.09.26.15.23.09;	author dean;	state Exp;
branches;
next	1.15;

1.15
date	2025.09.22.18.00.07;	author dean;	state Exp;
branches;
next	1.14;

1.14
date	2025.09.21.14.58.03;	author dean;	state Exp;
branches;
next	1.13;

1.13
date	2020.01.21.18.46.13;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2020.01.21.16.23.10;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2020.01.16.18.33.22;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2020.01.07.19.43.39;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2020.01.02.19.06.46;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2019.12.31.20.02.42;	author leith;	state Exp;
branches;
next	1.7;

1.7
date	2019.12.11.18.33.45;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2019.12.06.18.25.25;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2019.12.03.19.44.22;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2019.11.25.17.37.41;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2019.11.21.18.16.55;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2019.11.15.18.48.23;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2019.11.04.17.35.04;	author leith;	state Exp;
branches;
next	;


desc
@..
@


1.20
log
@changed debug output, added comments
@
text
@C++********************************************************************
C
C LUNSETMRCHDR.F  DERIVED FROM LUNSETHDR.F        JUN 2019 ArDean Leith
C                 NATIVE MRC FILE SUPPORT         JUL 2019 ArDean Leit
C                 NVIDIA COMPILER CHANGES         SEP 2025 Tapu Shaikh
C                 NVIDIA COMPILER CHANGES UNDONE  SEP 2025 ArDean Leith
C                 DEBUG OUTPUT CHANGED,CTIT_LOCAL SEP 2025 ArDean Leith
C                 NBYT, NBYT_PER_VAL CONFUSED     SEP 2025 ArDean Leith
C                 DEBUG OUTPUT ADDED              OCT 2025 ArDean Leith
C
C **********************************************************************
C=*                                                                    *
C=* This file is part of:   SPIDER - Modular Image Processing System.  *
C=* SPIDER System Authors:  Joachim Frank & ArDean Leith               *
C=* Copyright 1985-2025 Health Research Inc.,                          *
C=* Riverview Center, 150 Broadway, Suite 560, Menands, NY 12204.      *
C=* Email:                                                             *
C=*                                                                    *
C=* SPIDER is free software; you can redistribute it and/or            *
C=* modify it under the terms of the GNU General Public License as     *
C=* published by the Free Software Foundation; either version 2 of the *
C=* License, or (at your option) any later version.                    *
C=*                                                                    *
C=* SPIDER is distributed in the hope that it will be useful,          *
C=* but WITHOUT ANY WARRANTY; without even the implied warranty of     *
C=* merchantability or fitness for a particular purpose.  See the GNU  *
C=* General Public License for more details.                           *
C=* You should have received a copy of the GNU General Public License  *
C=* along with this program. If not, see <http://www.gnu.org/licenses> *
C=*                                                                    *
C **********************************************************************
C
C  PURPOSE: HANDLES ALL INTERACTIONS WITH MRC IMAGE FILE HEADERS. 
C           CONTAINS NUMEROUS SUBROUTINES MOST START WITH PREFIX: LUN
C
C  SUBROUTINES:
C     ------------------------- LUNNEWHED_MRC ---------------------- 
C     ------------------------- LUNREDHED_MRC ---------------------- 
C     ------------------------- LUNWRTHED_MRC ---------------------- 
C     ------------------------- LUNGETOBJ_MRC ---------------------- 
C     ------------------------- LUNGETPOSINFO_MRC ------------------ 
C     ------------------------- LUNSETPOS_MRC ---------------------- 
C     ------------------------- LUNGETIS_MRC ----------------------- 
C     ------------------------- LUNGETMAP_MRC ---------------------- 
C     ------------------------- LUNSETHAND_MRC ---------------------
C     ------------------------- LUNGETHAND_MRC ---------------------
C     ------------------------- LUNSETXXX_MRC ----------------------
C     ------------------------- LUNSETMODSIZ_MRC -------------------
C     ------------------------- LUNGETMODSIZ_MRC -------------------
C     ------------------------- LUNGETMOD_MRC -------------------
C     ------------------------- LUNGETVIN_MRC ----------------------
C     ------------------------- LUNSETVIN_MRC ----------------------
C     ------------------------- LUNSETISBARE_MRC -------------------
C     ------------------------- LUNGETISBARE_MRC -------------------
C     ------------------------- LUNSETFILE_MRC ---------------------
C     ------------------------- LUNSETIMGNUM_MRC -------------------
C     ------------------------- LUNSET_STATSIMG_MRC ----------------
C     ------------------------- LUNGET_STATSIMG_MRC ----------------
C     ------------------------- LUNSETSTATS_MRC --------------------
C     ------------------------- LUNGETSTATS_MRC --------------------
C     ------------------------- LUNZEROSTATS_MRC -------------------
C     ------------------------- LUNGETVERSION_MRC ------------------
C     ------------------------- LUNGETPIXSIZ_MRC -------------------
C     ------------------------- LUNSETPIXSIZ_MRC -------------------
C     ------------------------- LUNSETPIXSIZES_MRC -----------------
C     ------------------------- LUNGETSIZE_MRC ---------------------
C     ------------------------- LUNGETVALS_R_MRC -------------------
C     ------------------------- LUNSETVALS_R_MRC -------------------
C     ------------------------- LUNGETTYPE_MRC --------------------- 
C     ------------------------- LUNGETSTK_MRC ---------------------- 
C     ------------------------- LUNSETSTK_MRC ---------------------- 
C     ------------------------- LUNGETNSTACK_MRC ------------------- 
C     ------------------------- LUNSETNSTACK_MRC ------------------- 
C     ------------------------- LUNSETCOMMON_MRC ------------------- 
C     ------------------------- LUNGETLABELS_MRC ------------------- 
C     ------------------------- LUNSAYINFO_MRC --------------------- 
C
C  REAL LOCATIONS:      
C
C      CELLAX   = TRANSFER(MRC_HEADER(11),FVAL)  ! PIXEL SIZE * NX
C      CELLAY   = TRANSFER(MRC_HEADER(12),FVAL)  ! PIXEL SIZE * NY
C      CELLAZ   = TRANSFER(MRC_HEADER(13),FVAL)  ! PIXEL SIZE * NZ
C
C      PIXSIZX  = CELLAX / NX                    ! PIXEL SIZE IN X 
C      PIXSIZY  = CELLAY / NY                    ! PIXEL SIZE IN Y 
C      PIXSIZZ  = CELLAZ / NZ                    ! PIXEL SIZE IN Z  
C
C      CELLBX   = TRANSFER(MRC_HEADER(14),FVAL)
C      CELLBY   = TRANSFER(MRC_HEADER(15),FVAL)
C      CELLBZ   = TRANSFER(MRC_HEADER(16),FVAL)
C
C      DMIN     = TRANSFER(MRC_HEADER(20),FVAL) ! MIN  DENSITY VALUE
C      DMAX     = TRANSFER(MRC_HEADER(21),FVAL) ! MAX  DENSITY VALUE  
C      DMEAN    = TRANSFER(MRC_HEADER(22),FVAL) ! MEAN DENSITY VALUE  
C
C      CAXIS    = TRANSFER(MRC_HEADER(26),CSTR(1:4))
C      EXTTYP   = TRANSFER(MRC_HEADER(27),CSTR(1:4))
C
C      ANG1     = TRANSFER(MRC_HEADER(43),FVAL)
C      ANG2     = TRANSFER(MRC_HEADER(44),FVAL)
C      ANG3     = TRANSFER(MRC_HEADER(45),FVAL)
C      ANG4     = TRANSFER(MRC_HEADER(46),FVAL)
C      ANG5     = TRANSFER(MRC_HEADER(47),FVAL)
C      ANG6     = TRANSFER(MRC_HEADER(48),FVAL)
C
C      ORX      = TRANSFER(MRC_HEADER(50),FVAL)
C      ORY      = TRANSFER(MRC_HEADER(51),FVAL)
C      ORZ      = TRANSFER(MRC_HEADER(52),FVAL)
C
C      MAP      = TRANSFER(MRC_HEADER(53),CSTR(1:4))
C
C      RMS      = TRANSFER(MRC_HEADER(55),FVAL) ! DEVIATION FROM MEAN DENSITY   
C
C
C
C  STATIC LOCATION:   257 -- IDSP
C                     258 -- ISBARE
C                     259 -- IMGNUM (CURRENT)  SPIDER: ISTACK
C                     260 -- NSTACK (CURRENT)  SPIDER: MAXIM
C
C                               MRC!=0        CONTENT
C  COMMON /LUNMRC/ LUNMRCPOS   MRC FILE       I/O OFFSET
C                  LUNMRCNBYT  UNSIGNED       BYTES / DATA VALUE
C  COMMON /LUNARA/ LUNARA      UL    LL       NX VALUE   
C                  LUNSTK                     IMGNUM OFFSET
C                  LUNARB                     DUPLICATE LUN POINTER
C                  LUNFLIP                    O = NOFLIP  1=FLIP BYTES
C
C23456789 123456789 123456789 123456789 123456789 123456789 123456789 12
C--*********************************************************************

      MODULE LUNMRCHDR_INFO
         INTEGER, PARAMETER  :: NUMLUNST = 100
         TYPE INTEGER_POINTER
            INTEGER, POINTER :: IPT(:) 
         END TYPE INTEGER_POINTER

         TYPE(INTEGER_POINTER) :: LUNMRCHDRBUF(NUMLUNST)
      END MODULE LUNMRCHDR_INFO

C     ----------- LUNNEWHED_MRC ---------------------------------------

      SUBROUTINE LUNNEWHED_MRC(LUN,IRTFLG)

C     CREATES STORAGE SPACE FOR A MRC_HEADER OBJECT

#include "LUNHDR.INC"

      INTEGER         :: LUN,IRTFLG
      
      INTEGER * 8     :: LUNMRCPOS 
      INTEGER         :: LUNMRCNBYT
      COMMON /LUNMRC/    LUNMRCPOS(100),LUNMRCNBYT(100)

      MPOINTER => LUNMRCHDRBUF(LUN)%IPT 
      IF (.NOT. ASSOCIATED(MPOINTER)) THEN
C        ALLOCATE SPACE FOR THIS HEADER OBJECT
         ALLOCATE(MPOINTER(LENMRCHDR),STAT=IRTFLG)

         IF (IRTFLG .NE. 0) THEN
            CALL ERRT(46,'LUNNEWHED_MRC, FILE HEADER',LENHDRMRC)
            IRTFLG = 1
            RETURN
         ENDIF
         LUNMRCHDRBUF(LUN)%IPT => MPOINTER
      ENDIF

C     TEMPORARY SETTING TO ENSURE LUN POINTS TO MRC BEFORE LENGTH KNOWN
      LUNMRCPOS(LUN) = 1

      !write(3,*) ' In lunnewhed_mrc: ',lun,LUNMRCHDRBUF(LUN)%ipt 
      IRTFLG = 0
      END

C     ----------- LUNREDHED_MRC ---------------------------------------

      SUBROUTINE LUNREDHED_MRC(LUN,CALLERRT,IRTFLG)

C     READS MRC IMAGE HEADER FROM FILE INTO MRC HEADER OBJECT 

#include "LUNHDR.INC"

      INTEGER      :: LUN,IRTFLG 
      LOGICAL      :: CALLERRT

      INTEGER * 8  :: IPOSMRC

C     INCLUSION FOR OPTIONAL MPI INITIALIZATION.  
      INTEGER      :: MYPID = -1
#include "MPI_INIT.INC"

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     READ 1024 BYTEs LONG HEADER FROM MRC FILE INTO MRC_HEADER OBJECT

      IPOSMRC = 1          ! HEADER START POSITION

C     USING IOSTAT; IRTFLG IS SET TO ZERO ON SUCCESSFUL READ. 
      IF (MYPID <= 0) 
     &    READ(LUN, POS=IPOSMRC,IOSTAT=IRTFLG) MRC_HEADER(1:256)


#ifdef USE_MPI
      IF (ONLYONE_RED) THEN
C       ALWAYS BROADCASTS IF ONLYONE_RED IS .TRUE. WHEN USING MPI
        CALL BCAST_MPI('LUNREDHED_MRC','MRC_HEADER',MRC_HEADER,256,'I',
     &                  ICOMM,MPIERR)
        CALL BCAST_MPI('LUNREDHED_MRC','IRTFLG',IRTFLG, 1,'I',
     &                  ICOMM,MPIERR)
      ENDIF
#endif

      !write(3,*)' In lunredhed_mrc, mrc_header:',mrc_header(1:9)

      IF (MYPID <= 0 .AND. IRTFLG .NE. 0 .AND. CALLERRT) THEN
         CALL ERRT(102,'I/O ERROR ON FILE HEADER',IRTFLG)
         IRTFLG = 1
         RETURN
      ENDIF

      IRTFLG = 0
      END

C     ----------- LUNWRTHED_MRC ---------------------------------------

      SUBROUTINE LUNWRTHED_MRC(LUN,IRTFLG)

C     WRITES HEADER OBJECT INTO FILE'S MRC IMAGE HEADER

#include "LUNHDR.INC"

      INTEGER    :: LUN,IRTFLG

      INTEGER *8 :: IPOSMRC 
      real       :: fval

C     INCLUSION FOR OPTIONAL MPI INITIALIZATION.  
      INTEGER      :: MYPID = -1
#include "MPI_INIT.INC"

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)

      IF (IRTFLG .NE. 0) RETURN

C     WRITE HEADER RECORD FROM MRC_HEADER INTO MRC FILE 
      IPOSMRC = 1

      IF (MYPID <= 0) 
     &    WRITE(LUN, POS=IPOSMRC,IOSTAT=IRTFLG) MRC_HEADER(1:256)

      !write(3,*)' In lunwrthed_mrc; header(25): ',mrc_header(25),lun 

#ifdef USE_MPI

      IF (ONLYONE_RED) THEN
C       ALWAYS BROADCASTS IF ONLYONE_RED IS .TRUE. WHEN USING MPI
        CALL BCAST_MPI('LUNWRTHED_MRC','MRC_HEADER',MRC_HEADER,256,'I',
     &                  ICOMM,MPIERR)
        CALL BCAST_MPI('LUNWRTHED_MRC','IRTFLG',IRTFLG, 1,'I',
     &                  ICOMM,MPIERR)
      ENDIF
#endif
      !fval = transfer(mrc_header(20),fval)

      IF (MYPID <= 0 .AND. IRTFLG .NE. 0) THEN
         CALL ERRT(102,'WRITING TO MRC FILE HEADER',IRTFLG)
         IRTFLG = 1
      ENDIF

      IRTFLG = 0
      END

C     ------------------------- LUNGETOBJ_MRC -------------------------

      SUBROUTINE LUNGETOBJ_MRC(LUN,IPOINTER,IRTFLG)

      USE LUNMRCHDR_INFO

      INTEGER                        :: LUN,IRTFLG
      INTEGER, DIMENSION(:), POINTER :: IPOINTER 

      INTEGER, PARAMETER             :: NUMLUNS = 100

C     POINT TO HEADER OBJECT
 
      IRTFLG = 1
      IF (LUN <= 0 .OR. LUN > NUMLUNS) THEN
         CALL ERRT(102,'PGM ERROR, LUN OUT OF RANGE', LUN)
         RETURN
      ENDIF

      IPOINTER => LUNMRCHDRBUF(LUN)%IPT
      IF (.NOT. ASSOCIATED(IPOINTER)) THEN
         CALL ERRT(101,'UNASSOCIATED MRC_HEADER POINTER', IRTFLG)
         RETURN
      ENDIF

      IRTFLG = 0
      END

C     ------------------ LUNGETPOSINFO_MRC ----------------------------

      SUBROUTINE LUNGETPOSINFO_MRC(LUN,NBYT_PER_VAL,IHEDLEN,IRTFLG)

#include "LUNHDR.INC"
     
      INTEGER         :: LUN,NBYT_PER_VAL,IHEDLEN,IRTFLG

      INTEGER         :: NSYMBT,MRCMODE

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET NSYMBT = HEADER EXTRA LENGTH
      NSYMBT  = MRC_HEADER(24)  ! NO. OF ADDITIONAL HEADER BYTES

C     CALCULATE MRC FILE HEADER LENGTH IN BYTES
      IHEDLEN = 1024 + NSYMBT

C     CALCULATE NUMBER OF BYTES IN AN IMAGE VALUE (<0 == UNSIGNED)

      IRTFLG  = 0
      MRCMODE = MRC_HEADER(4)

      IF     (MRCMODE == 0) THEN
         NBYT_PER_VAL =  1         ! SIGNED    8 BIT INTEGER*1
 
      ELSEIF (MRCMODE == 1) THEN
         NBYT_PER_VAL =  2         ! SIGNED   16 BIT INTEGER*2

      ELSEIF (MRCMODE == 6) THEN
         NBYT_PER_VAL = -2         ! UNSIGNED 16 BIT INTEGER*2

      ELSEIF (MRCMODE == 2) THEN
         NBYT_PER_VAL =  4         ! REAL*4
  
      ELSE
         NBYT_PER_VAL = 0          ! NOT A VALID MRC FILE
         IRTFLG = 1
         RETURN
      ENDIF

      IRTFLG = 0
      END

C     ------------------ LUNSETPOS_MRC ----------------------------

      SUBROUTINE LUNSETPOS_MRC(LUN,IMGNUM,IRTFLG)

      IMPLICIT NONE
     
      INTEGER        :: LUN,IMGNUM,IRTFLG

      INTEGER * 8    :: LUNMRCPOS 
      INTEGER        :: LUNMRCNBYT
      COMMON /LUNMRC/   LUNMRCPOS(100),LUNMRCNBYT(100)

      INTEGER        :: LUNARA,LUNSTK,LUNARB,LUNFLIP
      COMMON /LUNARA/   LUNARA(100),LUNSTK(100),LUNARB(100),LUNFLIP(100)

      INTEGER         :: NBYT,IHEDLEN,NBYT_PER_VAL,NBYT_PER_REC
      INTEGER         :: NX,NY,NZ
      CHARACTER(LEN=4):: CAXIS

C     GET AXIS ORIGIN IN FILE
C     THIS IS NOT A STANDARD MRC DEFINED HEADER POSITION!!
      CALL LUNGETHAND_MRC(LUN,CAXIS,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET NUMBER OF BYTES IN AN IMAGE VALUE AND HEADER LENGTH
      CALL LUNGETPOSINFO_MRC(LUN,NBYT_PER_VAL,IHEDLEN,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     NZ IS ADJUSTED FOR RELION .mrcs FILES IF NEEDED
      CALL LUNGETSIZE_MRC(LUN,NX,NY,NZ,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      LUNMRCNBYT(LUN) = NBYT_PER_VAL  ! PRESERVES NEGATIVE FOR SIGN

      NBYT_PER_VAL    = ABS(NBYT_PER_VAL)   
      NBYT_PER_REC    = NBYT_PER_VAL * NX

 
      IF (CAXIS(1:1) == 'U') THEN   ! NON-DEFAULT
C        ORIGIN AT UPPER LEFT, POSITION AT ONE RECORD BEFORE IMAGE

         LUNARA(LUN) = -NX

         IF (IMGNUM <= 1) THEN
C          NO STACK OFFSET NEEDED
           LUNMRCPOS(LUN) = IHEDLEN - NBYT_PER_REC + 1

         ELSE
C          STACKED FILE OFFSET NEEDED 
           LUNMRCPOS(LUN) = IHEDLEN + 
     &                      (IMGNUM -1) * NZ * NY * NBYT_PER_REC -
     &                                              NBYT_PER_REC + 1
         ENDIF   ! END OF: IF (IMGNUM <= 1)
 
      ELSE  ! DEFAULTS IF THIS POSITION IS BLANK
C        ORIGIN AT LOWER LEFT, POSITION AT END OF CURRENT IMAGE +1

         LUNARA(LUN) = NX

         IF (IMGNUM <= 1) THEN
C          NO STACK OFFSET NEEDED
           LUNMRCPOS(LUN) = IHEDLEN + 
     &                      (NZ - 1) * NY * NBYT_PER_REC + 
     &                                 NY * NBYT_PER_REC + 1
         ELSE
C          STACKED FILE OFFSET NEEDED 
           LUNMRCPOS(LUN) = IHEDLEN + 
     &                      (IMGNUM -1) * NZ * NY * NBYT_PER_REC +
     &                      (NZ - 1)    *      NY * NBYT_PER_REC + 
     &                                         NY * NBYT_PER_REC + 1
         ENDIF   ! END OF: IF (IMGNUM <= 1)
      ENDIF

      !write(3,*)' In lunsetpos_mrc; imgnum,lunmrcpos(lun): ',
      !&                             imgnum,lunmrcpos(lun)
      !write(3,*)' In lunsetpos_mrc; ihedlen,nx,ny,nz,nbyt,imgnum: ',
      !&                             ihedlen,nx,ny,nz,nbyt,imgnum
      !write(3,*)' In lunsetpos_mrc; nbyt_per_rec: ', nbyt_per_rec
      !write(3,*)' In lunsetpos_mrc; lunmrcpos: ',lunmrcpos(lun)

      IRTFLG = 0
      END

C     ------------------------- LUNFLIPORG_MRC ------------------------

      SUBROUTINE LUNFLIPORG_MRC(LUN,NX,NY,NZ,RESET,IRTFLG)

#include "LUNHDR.INC"

      INTEGER        :: LUN,NX,NY,NZ,IRTFLG
      LOGICAL        :: RESET

      INTEGER * 8    :: LUNMRCPOS 
      INTEGER        :: LUNMRCNBYT
      COMMON /LUNMRC/   LUNMRCPOS(100),LUNMRCNBYT(100)

      INTEGER        :: LUNARA,LUNSTK,LUNARB,LUNFLIP
      COMMON /LUNARA/   LUNARA(100),LUNSTK(100),LUNARB(100),LUNFLIP(100)

      CHARACTER(LEN=4)  :: CAXIS
      INTEGER * 8, SAVE :: LUNMRCPOS_SAV = 0 
      INTEGER           :: NBYT_PER_REC

      IF (LUNMRCPOS(LUN) == 0) THEN
C       DIRECT ACCESS SPIDER FILE
        RETURN

      ELSEIF (RESET) THEN
C       RESET TO ORIGINAL AXIS ORIGIN IN FILE
        LUNMRCPOS(LUN) = LUNMRCPOS_SAV 
        IRTFLG = 0
        RETURN

      ELSE
C       DIRECT ACCESS MRC FILE

C       GET AXIS ORIGIN IN FILE NOT A STANDARD MRC DEFINED POSITION!!
        CALL LUNGETHAND_MRC(LUN,CAXIS,IRTFLG)
        IF (IRTFLG .NE. 0) RETURN

        IF (CAXIS(1:1) == 'L') THEN    
C         ORIGIN AT LOWER LEFT, BUT POSITION AT ONE RECORD BEFORE IMAGE
          NBYT_PER_REC   = LUNMRCNBYT(LUN)
          LUNMRCPOS_SAV  = LUNMRCPOS(LUN)
          LUNMRCPOS(LUN) = LUNMRCPOS(LUN) - NZ * NY * NBYT_PER_REC

        ENDIF   ! END OF: IF (CAXIS(1:1) == 'L')
      ENDIF
      IRTFLG = 0

      END

C     ------------------------- LUNGETIS_MRC --------------------------

      SUBROUTINE LUNGETIS_MRC(LUN,IS_MRC,IRTFLG)

C     PURPOSE:  QUERIES HEADER LOCATION THAT SPECIFIES MRC FILE

      IMPLICIT NONE

      INTEGER         :: LUN,IRTFLG
      LOGICAL         :: IS_MRC

      INTEGER * 8     :: LUNMRCPOS 
      INTEGER         :: LUNMRCNBYT
      COMMON /LUNMRC/    LUNMRCPOS(100),LUNMRCNBYT(100)

C     Handle invalid index (LUN=0, etc.)  Sept 2025
      IF (LUN >= LBOUND(LUNMRCPOS, 1) .AND. 
     &    LUN <= UBOUND(LUNMRCPOS, 1)) THEN
          IS_MRC = (LUNMRCPOS(LUN) .NE. 0)
      ELSE
          IS_MRC = .FALSE.
      ENDIF

      IRTFLG = 0
      END

C     ------------------------- LUNGETMAP_MRC -------------------------

      SUBROUTINE LUNGETMAP_MRC(LUN,MAPC,MAPR,MAPS,IRTFLG)

#include "LUNHDR.INC"
      INTEGER         :: LUN,MAPC,MAPR,MAPS,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      MAPC = MRC_HEADER(17)
      MAPR = MRC_HEADER(18)
      MAPS = MRC_HEADER(19)

#if defined(SP_DBUG)
        write(3,*) ' In lungetmap_mrc; mrc_header 17,18,19:  ',
     &        mrc_header(17),' ',mrc_header(18),' ',mrc_header(19)      
        write(3,*) ' In lungetmap_mrc; map c,r,s: ',mapc,mapr,maps
#endif

      IRTFLG = 0
      END

C     ------------------------- WHICH_HAND_MRC ------------------------

      SUBROUTINE WHICH_HAND_MRC(LUN,FILNAM,CAXIS,IRTFLG)

C     PURPOSE:  SET AXIS ORIGIN LOCATION & VOLUME HANDEDNESS 
C               BEFORE LUNSETPOS_MRC

      IMPLICIT NONE

      INCLUDE 'CMBLOCK.INC'

      CHARACTER(LEN=*)    :: FILNAM
      CHARACTER(LEN=4)    :: CAXIS
      INTEGER             :: LUN,IRTFLG

      LOGICAL             :: ISMRCSFILE

C     SET AXIS ORIGIN LOCATION & VOLUME HANDEDNESS BEFORE LUNSETPOS_MRC

C     SEE IF RELION COMPATIBLE IMAGE/STACK (ALWAYS 'UL L')
      ISMRCSFILE = (INDEX(FILNAM,'.MRCS') > 1  .OR.
     &              INDEX(FILNAM,'.mrcs') > 1)

      IF (ISMRCSFILE) THEN
C        RELION COMPATIBLE IMAGE/STACK (ALWAYS 'UL L')
         CAXIS = 'UL L'
         CALL LUNSETHAND_MRC(LUN,CAXIS,IRTFLG)
       
      ELSE
C        SEE IF FILE HEADER ALREADY HAS CAXIS SET
         CALL LUNGETHAND_MRC(LUN,CAXIS,IRTFLG)
         IF (IRTFLG .NE. 0) RETURN

         IF (INDEX(CAXIS,'L') == 0) THEN
C           CAXIS DOES NOT CONTAIN: 'UL L', 'UL R', 'LL L' or 'LL R' (ALWAYS HAS L)
C           SET ORIGIN & HANDEDNESS TO CURRENT DEFAULT MRC_AXIS
            CAXIS = MRC_AXIS
            CALL LUNSETHAND_MRC(LUN,CAXIS,IRTFLG)
         ENDIF       
      ENDIF

      END     

C     ------------------------- LUNSETHAND_MRC ------------------------

      SUBROUTINE LUNSETHAND_MRC(LUN,CAXIS,IRTFLG)

C     SETS  AXIS ORIGIN LOCATION & VOLUME HANDEDNESS (CHARACTERS)
C     THIS IS NOT A STANDARD MRC DEFINED HEADER POSITION!!

#include "LUNHDR.INC"

      INTEGER            :: LUN,IRTFLG
      CHARACTER(LEN=4)   :: CAXIS

      INTEGER            :: I4V

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      MRC_HEADER(26) = TRANSFER(CAXIS(1:4),I4V)

      !write(3,*)' In lunsethand_mrc; caxis: ',mrc_header(26),caxis

      IRTFLG = 0
      END

C     ------------------------- LUNGETHAND_MRC ------------------------

      SUBROUTINE LUNGETHAND_MRC(LUN,CAXIS,IRTFLG)

C     GETS  AXIS ORIGIN LOCATION & VOLUME HANDEDNESS (CHARACTERS)
C     THIS IS NOT A STANDARD MRC DEFINED HEADER POSITION!!

#include "LUNHDR.INC"

      INTEGER            :: LUN,IRTFLG
      CHARACTER(LEN=4)   :: CAXIS

      CHARACTER(LEN=4)   :: CSTR

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      CAXIS(1:4) = TRANSFER(MRC_HEADER(26),CSTR(1:4))

      !write(3,*)' In lungethand_mrc; lun,caxis: ',lun,caxis

      IRTFLG = 0
      END

C     ------------------------- LUNSETXXX_MRC -------------------------

      SUBROUTINE LUNSETXXX_MRC(LUN,IRTFLG)

C     SETS  N?START,CELLANGS,AXES,NSYMBYT,MAP,MACHST,LABELS,ETC.
#include "LUNHDR.INC"

      INTEGER            :: LUN,IRTFLG

      INTEGER            :: I,INOW
      INTEGER            :: NSYMBYT,NLABEL
      CHARACTER(LEN=1)   :: BLANK = CHAR(32)
      CHARACTER(LEN=4)   :: CVAL
      CHARACTER(LEN=12)  :: CDATT
      CHARACTER(LEN=36)  :: LABEL1
      INTEGER            :: I4V

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     SET DEFAULT HEADER POSITIONS

      MRC_HEADER(5)  = 1  ! NXSTART  NUMBER OF FIRST COLUMN  IN MAP
      MRC_HEADER(6)  = 1  ! NYSTART  NUMBER OF FIRST ROW     IN MAP
      MRC_HEADER(7)  = 1  ! NZSTART  NUMBER OF FIRST SECTION IN MAP

C     CELL ANGLES (DEGREES)  (CELLBX..) 
      MRC_HEADER(14) = 90.0
      MRC_HEADER(15) = 90.0
      MRC_HEADER(16) = 90.0

C     STORAGE: FAST, MEDIUM, SLOW AXES 
      MRC_HEADER(17) = 1
      MRC_HEADER(18) = 2
      MRC_HEADER(19) = 3

      NSYMBYT        = 0          ! NO EXTRA BYTES IN HEADER
      MRC_HEADER(24) = NSYMBYT

C     ZERO THE EXTRA POSITIONS  25...49, BUT 27=MRC0, 28=IVERSION
      MRC_HEADER(25:26) = 0
      MRC_HEADER(29:49) = 0

C     PUT IN EXTTYP : 'MRCO'
      CVAL = 'MRCO'
      MRC_HEADER(27) = TRANSFER(CVAL(1:4),I4V)

C     PUT IN 'MAP'
      CVAL = 'MAP '
      MRC_HEADER(53) = TRANSFER(CVAL(1:4),I4V)

C     SET MACHINE STAMP
C     MACHST = 286326784    ! FOR BIG ENDIAN DATA
C     MACHST = 4369         ! FOR LITTLE ENDIAN DATA ??
      MACHST = 16708        ! FOR LITTLE ENDIAN DATA ??
      MRC_HEADER(54) = MACHST

C     SET NUMBER OF LABELS
      NLABEL = 1  
      MRC_HEADER(56) = NLABEL

C     ZERO ALL LABELS WITH BLANKS
      CVAL = BLANK // BLANK // BLANK // BLANK
      DO I = 57,256
         MRC_HEADER(I) = TRANSFER(CVAL(1:4),I4V)
      ENDDO

C     ADD ONE LABEL
      CALL DATE_2K(CDATT)            !12234567890123
C               123456789 123456789 123456789 123456789 
      LABEL1 = 'Created using SPIDER: ' // CDATT
      INOW   = 56
      DO I = 1,36,4
         CVAL = LABEL1(I:I+3)
         INOW = INOW + 1
         MRC_HEADER(INOW) = TRANSFER(CVAL(1:4),I4V)
      ENDDO

      !write(3,*)' In lunsetstk_mrc; iversion: ',mrc_header(23),nstack

      IRTFLG = 0
      END

C     ------------------------- LUNSETMODSIZ_MRC -----------------------

      SUBROUTINE LUNSETMODSIZ_MRC(LUN,MRCMODE,NX,NY,NZMRC,
     &                            MX,MY,MZ,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,MRCMODE,NX,NY,NZMRC,MX,MY,MZ,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      MRC_HEADER(4)  = MRCMODE
      MRC_HEADER(1)  = NX
      MRC_HEADER(2)  = NY
      MRC_HEADER(3)  = NZMRC ! NO. OF IMAGES IN RELION mrcs FILES!
      MRC_HEADER(8)  = MX    ! NO. OF INTERVALS ALONG X
      MRC_HEADER(9)  = MY    ! NO. OF INTERVALS ALONG Y
      MRC_HEADER(10) = MZ    ! NO. OF INTERVALS ALONG Z (>1 = STACK)

      !write(3,*) ' In lunsetmodsiz_mrc: ',mrcmode,nx,ny,nz,mx,my,mz

      IRTFLG = 0
      END

C     ------------------------- LUNSETMODE_MRC ------------------------

      SUBROUTINE LUNSETMODE_MRC(LUN,MRCMODE,IRTFLG)

#include "LUNHDR.INC"

      INTEGER         :: LUN,MRCMODE,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      MRC_HEADER(4) = MRCMODE

      !write(3,*) ' In lunsetmode_mrc; mrcmode: ',mrcmode

      IRTFLG = 0
      END


C     ------------------------- LUNGETMODSIZ_MRC ----------------------

      SUBROUTINE LUNGETMODSIZ_MRC(LUN,MRCMODE,NX,NY,NZMRC,
     &                            MX,MY,MZ,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,MRCMODE,NX,NY,NZMRC,MX,MY,MZ,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      MRCMODE = MRC_HEADER(4)
      NX      = MRC_HEADER(1)
      NY      = MRC_HEADER(2)
      NZMRC   = MRC_HEADER(3)  ! NO. OF IMAGES IN RELION mrcs FILES!
      MX      = MRC_HEADER(8)  ! NO. OF INTERVALS ALONG X
      MY      = MRC_HEADER(9)  ! NO. OF INTERVALS ALONG Y
      MZ      = MRC_HEADER(10) ! NO. OF INTERVALS ALONG Z (>1 = STACK)

      !write(3,*) ' In lungetmodsiz_mrc: ',mrcmode,nx,ny,nz,mx,my,mz

      IRTFLG = 0
      END

C     ------------------------- LUNGETMODE_MRC ----------------------

      SUBROUTINE LUNGETMODE_MRC(LUN,MRCMODE,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,MRCMODE,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      MRCMODE = MRC_HEADER(4)

      !write(3,*) ' In lungetmod_mrc; mrcmode: ',mrcmode

      IRTFLG = 0
      END

C     ------------------------- LUNGETVIN_MRC ----------------------------

      SUBROUTINE LUNGETVIN_MRC(LUN,IVERSION,ISPG,NSYMBT,NLABL,IRTFLG)

#include "LUNHDR.INC"
      INTEGER         :: LUN,IVERSION,ISPG,NSYMBT,NLABL,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
 
C     (23)  ISPG == 0        IMAGE OR IMAGE STACK
C     (23)  ISPG == 1        VOLUMES
C     (23)  ISPG == 401      STACK OF EM VOLUMES

      IVERSION = MRC_HEADER(28)
      ISPG     = MRC_HEADER(23)
      NSYMBT   = MRC_HEADER(24)  ! NO. OF ADDITIONAL HEADER BYTES
      NLABL    = MRC_HEADER(56)  ! NO. OF LABELS

      ! write(3,*) ' In lungetvin_mrc; iversion', iversion

      IRTFLG = 0
      END

C     ------------------------- LUNSETVIN_MRC -------------------------

      SUBROUTINE LUNSETVIN_MRC(LUN,IVERSION,ISPG,NSYMBT,NLABL,IRTFLG)

#include "LUNHDR.INC"
      INTEGER         :: LUN,IVERSION,ISPG,NSYMBT,NLABL,IRTFLG

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
   
C     (23)  ISPG == 0        IMAGE OR IMAGE STACK
C     (23)  ISPG == 1        VOLUMES
C     (23)  ISPG == 401      STACK OF EM VOLUMES

      MRC_HEADER(28) = IVERSION
      MRC_HEADER(23) = ISPG
      MRC_HEADER(24) = NSYMBT ! NUMBER OF ADDITIONAL HEADER BYTES
      MRC_HEADER(56) = NLABL  ! NO. OF LABELS

      !write(3,*) ' In lunsetvin_mrc; iversion', iversion,ispg

      IRTFLG = 0
      END

C     ------------------------- LUNGETISBARE_MRC ----------------------

      SUBROUTINE LUNGETISBARE_MRC(LUN,ISBARE,IRTFLG)

#include "LUNHDR.INC"

      INTEGER   :: LUN,IRTFLG
      LOGICAL   :: ISBARE

 
C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET ISBARE FROM HEADER OBJECT STATIC LOCATION
      ISBARE = (MRC_HEADER(258) == 1)

      IRTFLG = 0
      END

C     --------------------- LUNSETISBARE_MRC -------------------------

      SUBROUTINE LUNSETISBARE_MRC(LUN,ISBARE,IRTFLG)

#include "LUNHDR.INC"

      INTEGER     :: LUN,IRTFLG
      LOGICAL     :: ISBARE

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     SET ISBARE IN MRC HEADER OBJECT (STATIC AREA)
      IF (ISBARE) THEN
         MRC_HEADER(258) = 1 
      ELSE
         MRC_HEADER(258) = 0
      ENDIF

      IRTFLG = 0
      END

C     ------------------------- LUNSETFILE_MRC -----------------------

      SUBROUTINE LUNSETFILE_MRC(LUN,FILNAM,DSP,IRTFLG)

#include "LUNHDR.INC"

      INTEGER                :: LUN,IRTFLG
      CHARACTER(LEN=*)       :: FILNAM
      CHARACTER(LEN=1)       :: DSP

      INTEGER                :: NLET

      IF (FILNAM(1:1) .NE. CHAR(0)) THEN
C        SET CURRENT FILENAME IN HEADER OBJECT 
         NLET           = LNBLNKN(FILNAM)
         LUNFILNAM(LUN) = FILNAM(1:NLET)
      ENDIF

      IF (DSP .NE. CHAR(0)) THEN

C        POINT TO HEADER OBJECT
         CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
         IF (IRTFLG .NE. 0) RETURN

C        SET DSP IN STATIC HEADER OBJECT
         MRC_HEADER(257) = 0
         IF (DSP == 'N') MRC_HEADER(257) = 1

      ENDIF

      IRTFLG = 0
      END

C     ------------------------ LUNGETFILE_MRC -----------------------

      SUBROUTINE LUNGETFILE_MRC(LUN,FILNAM,NLET,DSP,IRTFLG)

#include "LUNHDR.INC"

      INTEGER                :: LUN,NLET,IRTFLG
      CHARACTER(LEN=*)       :: FILNAM
      CHARACTER(LEN=1)       :: DSP

C     RETRIEVE CURRENT FILENAME         ! NOT IN HEADER OBJECT
      FILNAM = LUNFILNAM(LUN)
      NLET   = LNBLNKN(FILNAM)

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET DSP FROM STATIC HEADER OBJECT
      DSP = 'O'
      IF (MRC_HEADER(257) == 1) DSP = 'N'

      IRTFLG = 0
      END

C     ------------------------- LUNSETIMGNUM_MRC ----------------------

      SUBROUTINE LUNSETIMGNUM_MRC(LUN,IMGNUM,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IMGNUM,IRTFLG

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
          
C     SET MRC_HEADER VALUE
      MRC_HEADER(259) = IMGNUM       ! LOCATION: 259  CURRENT IMGNUM
         
      IRTFLG = 0
      END

C     ------------------------- LUNSET_STATSIMG_MRC -------------------

      SUBROUTINE LUNSET_STATSIMG_MRC(LUN,IMGSTATS,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IMGSTATS,IRTFLG

C     IMGSTATS IS THE CURRENT STACKED OR MAIN IMAGE NUMBER IN STATS

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      !write(3,*)' In lunset_statsimg_mrc; imgstats: ',imgstats
          
C     SET MRC_HEADER VALUE
      MRC_HEADER(25) = IMGSTATS ! LOCATION: 25  IMGNUM FOR STATISTICS
         
      IRTFLG = 0
      END

C     ------------------------- LUNGET_STATSIMG_MRC -------------------

      SUBROUTINE LUNGET_STATSIMG_MRC(LUN,IMGSTATS,IMGNUM,NSTACK,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IMGSTATS,IMGNUM,NSTACK,IRTFLG
C     IMGSTATS IS THE CURRENT STACKED OR MAIN IMAGE NUMBER IN STATS

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
   
C     GET MRC_HEADER VALUE
      IMGSTATS = MRC_HEADER(25)  ! LOCATION:  25 IMGNUM FOR STATISTICS
      IMGNUM   = MRC_HEADER(259) ! LOCATION: 259 IMGNUM (<0 != STACK)
      NSTACK   = MRC_HEADER(260) ! LOCATION: 260 NSTACK (<0 != STACK)
         
      IRTFLG = 0
      END

C     ------------------------- LUNSETSTATS_MRC -----------------------

      SUBROUTINE LUNSETSTATS_MRC(LUN,IMAMIT,FMINT,FMAXT,AVT,SIGT,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IMAMIT,IRTFLG
      REAL     :: FMINT,FMAXT,AVT,SIGT,f21

      INTEGER  :: MZ,NSTACK,IMGNUM,IVERSION,IMGSTATS
      INTEGER  :: I4V

C     IMGSTATS IS THE CURRENT STACKED OR MAIN IMAGE NUMBER IN STATS

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      IF (IMAMIT == 0 .OR. (FMAXT < FMINT) ) THEN

C        SET UNDETERMINED FMIN... STATISTICS
         CALL LUNGETVERSION_MRC(LUN,IVERSION,IRTFLG)  ! MUST BE SET FIRST
         IF (IRTFLG .NE. 0) RETURN

         CALL LUNZEROSTATS_MRC(LUN,IVERSION,IRTFLG)
         IF (IRTFLG .NE. 0) RETURN

         IMGSTATS = 0

      ELSE
C        SET MRC_HEADER VALUES
         MRC_HEADER(20) = TRANSFER(FMINT,I4V) ! DMAX   MIN  DENSITY VALUE
         MRC_HEADER(21) = TRANSFER(FMAXT,I4V) ! DMIN   MAX  DENSITY VALUE  
         MRC_HEADER(22) = TRANSFER(AVT,  I4V) ! DMEAN  MEAN DENSITY VALUE  
         MRC_HEADER(55) = TRANSFER(SIGT, I4V) ! RMS    MAP DEVIATION FROM MEAN DENSITY          

C        NEED IMGNUM FOR IMGSTATS
         CALL LUNGETSTK_MRC(LUN,MZ,NSTACK,IMGNUM,IRTFLG)
        
         IMGSTATS = IMGNUM

      ENDIF

C     SET NUMBER OF IMAGE IN STATS
      CALL LUNSET_STATSIMG_MRC(LUN,IMGSTATS,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
       
#if defined (SP_DBUG)
!      f21 = TRANSFER(mrc_header(21),f21)
!      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
C!     &     '  In lunSetstats_mrc; lun,fmaxt,mrc_header(21):',
!     &        lun,fmaxt,f21

!      write(3,'(A,3I7)')
!     &     '  In lunSetstats_mrc;  mrc_header 17,18,19: ',
!     &         mrc_header(17),mrc_header(18),mrc_header(19)

!      write(3,'(A,I5,2X,3(2x,I8))')
!     &     '  In lunSetstats_mrc; nstack,imgnum,imgstats,imamit:',
!     &                            nstack,imgnum,imgstats,imamit

!      write(3,*)'  '
!      write(3,*)' Leaving lunSetstats_mrc ------'
!      write(3,*)'  '
#endif

      IRTFLG = 0
      END

C     ------------------------- LUNGETSTATS_MRC -----------------------

      SUBROUTINE LUNGETSTATS_MRC(LUN,IMAMIT,FMINT,FMAXT,AVT,SIGT,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IMAMIT,IRTFLG
      REAL     :: FMINT,FMAXT,AVT,SIGT,f21

      INTEGER  :: IMGSTATS,IMGNUM,NSTACK

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET MRC_HEADER VALUES
      FMINT = TRANSFER(MRC_HEADER(20),FVAL) ! DMAX:  MIN  DENSITY VALUE
      FMAXT = TRANSFER(MRC_HEADER(21),FVAL) ! DMIN:  MAX  DENSITY VALUE  
      AVT   = TRANSFER(MRC_HEADER(22),FVAL) ! DMEAN: MEAN DENSITY VALUE  
      SIGT  = TRANSFER(MRC_HEADER(55),FVAL) ! RMS: DEVIATION FROM MEAN DENSITY          

C     MRC FILE ENCODES IMAMI IN RELATIVE VALUES FOR MIN/MAX      
      IMAMIT = 1
      IF (FMAXT < FMINT) IMAMIT = 0
      IF (AVT   < FMINT)  IMAMIT = 0
      IF (SIGT  < 0.0)   IMAMIT = 0

C     IF ALL ZERO STATISTICS ARE PROBABLY NOT SET!! 
      IF (FMINT == 0.0 .AND. FMAXT == 0.0 .AND. SIGT == 0.0) IMAMIT = 0 
  
C     ARE STATS FOR THE CURRENT MRC IMAGE?
      CALL LUNGET_STATSIMG_MRC(LUN,IMGSTATS,IMGNUM,NSTACK,IRTFLG)

      IF (IMGNUM > 0 .AND. (IMGSTATS .NE. IMGNUM)) THEN
C        THIS IS A MRC STACKED IMAGE BUT IMG NOT = IMG IN STATISTICS
         IMAMIT = 0
         !FMAXT  = FMINT - 1

#if defined(SP_DBUG)
!      f21 = TRANSFER(mrc_header(21),f21)

!      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
!     &     '  In lunGetstats_mrc; lun,fmaxt,mrc_header(21):',
!     &        lun,fmaxt,f21

!      write(3,'(A,I5,2X,3(2x,I8))')
!     &     '  In lunGetstats_mrc; nstack,imgnum,imgstats,imamit:',
!     &                            nstack,imgnum,imgstats,imamit
C      write(3,*)'  '
#endif

         CALL LUNSETSTATS_MRC(LUN,IMAMIT,FMINT,FMAXT,AVT,SIGT,IRTFLG)

      ELSEIF (NSTACK > 1 .AND. IMGNUM < 0 ) THEN
C        THIS IS A MRC STACK BUT NO IMAGE SPECIFIED
         IMAMIT = 0
         FMAXT  = FMINT - 1
      ENDIF

#if  defined(SP_DBUG)

!      f21 = TRANSFER(mrc_header(21),f21)
!      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
!     &     '  In lunGetstats_mrc; lun,fmaxt,mrc_header(21):',
!     &        lun,fmaxt,f21

!      write(3,'(A,3I7)')
!     &     '  In lunGetstats_mrc;  mrc_header 17,18,19: ',
!     &         mrc_header(17),mrc_header(18),mrc_header(19)

!      write(3,'(A,I5,2X,3(2x,I8))')
!     &     '  In lunGetstats_mrc; nstack,imgnum,imgstats,imamit:',
!     &                            nstack,imgnum,imgstats,imamit

!      write(3,*)' Leaving lunGetstats_mrc ------'
!      write(3,*)'  '
#endif

      IRTFLG = 0
      END

C     ------------------------- LUNZEROSTATS_MRC ----------------------

      SUBROUTINE LUNZEROSTATS_MRC(LUN,IVERSION,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IVERSION,IRTFLG
 
      REAL     :: FMINT,FMAXT,FAVT,FSIGT
      INTEGER  :: I4V

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     SET UNDETERMINED IMAGE STATISTICS (FASTER)
      IF (IVERSION >= 20140) THEN
         FMINT =  0    ! UNDETERMINED SHUD BE: FMINT =  0 FOR MRC 2014
         FMAXT = -1    ! UNDETERMINED SHUD BE: FMAXT = -1
         FAVT  = -2    ! UNDETERMINED SHUD BE: FAVT  = -2
         FSIGT = -1    ! UNDETERMINED SHUD BE: FSIGT = -1
      ELSE
         FMINT =  0     
         FMAXT =  0     
         FAVT  =  0    
         FSIGT = -1     
      ENDIF
          
C     SET MRC_HEADER VALUES
      MRC_HEADER(20) = TRANSFER(FMINT,I4V) ! DMAX   MIN  DENSITY VALUE
      MRC_HEADER(21) = TRANSFER(FMAXT,I4V) ! DMIN   MAX  DENSITY VALUE  
      MRC_HEADER(22) = TRANSFER(FAVT, I4V) ! DMEAN  MEAN DENSITY VALUE  
      MRC_HEADER(55) = TRANSFER(FSIGT,I4V) ! RMS    MAP DEVIATION FROM MEAN DENSITY          

C     PUT UNKNOWN STAT'S IMAGE NUMBER IN FILE HEADER         
      CALL LUNSET_STATSIMG_MRC(LUN,0,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

#if defined(SP_BACK)
      CALL BACKTRACE 
#endif
 
#if  defined(SP_DBUG)
      f21 = TRANSFER(mrc_header(21),f21)
!      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
!     &     '  In lunZerostats_mrc; lun,fmax,mrc_header(21):',
!     &        lun,fmax,f21

!      write(3,'(A,3I7)')
!     &     '  In lunZerostats_mrc;  mrc_header 17,18,19: ',
!     &         mrc_header(17),mrc_header(18),mrc_header(19)

!      write(3,*)' Leaving lunZerostats_mrc ------'
!      write(3,*)'  '
#endif



      IRTFLG = 0
      END

C     ------------------------- LUNGETVERSION_MRC ---------------------

       SUBROUTINE LUNGETVERSION_MRC(LUN,IVERSION,IRTFLG)

#include "LUNHDR.INC"

      INTEGER   :: LUN,IVERSION,IRTFLG 

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET RETURN VALUE (MUST ALREADY BE SET, USUALLY BY: LUNZEROSTATS_MRC)
      IVERSION = MRC_HEADER(28)

      IRTFLG = 0
      END

C     ------------------------- LUNGETPIXSIZ_MRC ----------------------

      SUBROUTINE LUNGETPIXSIZ_MRC(LUN,PIXSIZ,IRTFLG)

C     PURPOSE:  GET PIXEL SIZE, NOTE THAT MRC HAS 3 SIZES BUT NOT SPIDER
C     LOCATIONS 11-13 CELLA       CELL DIMENSIONS IN ANGSTROMS

#include "LUNHDR.INC"

      REAL              :: PIXSIZ,FVAL
      INTEGER           :: LUN,IRTFLG

      INTEGER           :: NX,NY,NZ

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      CALL LUNGETSIZE_MRC(LUN,NX,NY,NZ,IRTFLG)

C     GET RETURN VALUE
      PIXSIZ = TRANSFER(MRC_HEADER(11),FVAL) 
      PIXSIZ = PIXSIZ / FLOAT(NX) 

      IRTFLG = 0
      END

C     ------------------------- LUNSETPIXSIZE_MRC ---------------------

      SUBROUTINE LUNSETPIXSIZ_MRC(LUN,PIXSIZ,IRTFLG)

C     PURPOSE:  SET PIXEL SIZE, NOTE MRC HAS 3 SIZES BUT NOT SPIDER!
C     LOCATIONS 11-13 CELLAX,CELLAY,CELLAZ   CELL DIMENSIONS IN ANG.

#include "LUNHDR.INC"

      REAL              :: PIXSIZ
      INTEGER           :: LUN,IRTFLG

      INTEGER           :: NX,NY,NZ,IV4
      REAL              :: CELLAX,CELLAY,CELLAZ 
   
C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      CALL LUNGETSIZE_MRC(LUN,NX,NY,NZ,IRTFLG)

      CELLAX = PIXSIZ * NX
      CELLAY = PIXSIZ * NY
      CELLAZ = PIXSIZ * NZ

!      write(3,*) ' In lunsetpixsiz_mrc, nx...: ',nx,ny,nz
!      write(3,*) ' In lunsetpixsiz_mrc, sizex...: ',
!     &                                  sizex,sizey,sizez
!      write(3,*) ' In lunsetpixsiz_mrc, cellax...: ',
!     &                                  cellax,cellay,cellaz


C     SET HEADER VALUES FOR PIXEL SIZE * NO. PIXELS IN CELL
      MRC_HEADER(11) = TRANSFER(CELLAX, IV4)
      MRC_HEADER(12) = TRANSFER(CELLAY, IV4)
      MRC_HEADER(13) = TRANSFER(CELLAZ, IV4)

      IRTFLG = 0
      END

C     ------------------------- LUNSETPIXSIZES_MRC --------------------

      SUBROUTINE LUNSETPIXSIZES_MRC(LUN,SIZEX,SIZEY,SIZEZ,IRTFLG)

C     PURPOSE:  SET PIXEL SIZE, NOTE MRC HAS 3 SIZES BUT NOT SPIDER!
C     LOCATIONS 11-13 CELLAX,CELLAY,CELLAZ   CELL DIMENSIONS IN ANG.

#include "LUNHDR.INC"

      REAL              :: SIZEX,SIZEY,SIZEZ
      INTEGER           :: LUN,IRTFLG

      INTEGER           :: NX,NY,NZ,IV4
      REAL              :: CELLAX,CELLAY,CELLAZ 
   
C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      CALL LUNGETSIZE_MRC(LUN,NX,NY,NZ,IRTFLG)

      CELLAX = SIZEX * NX
      CELLAY = SIZEY * NY
      CELLAZ = SIZEZ * NZ

!      write(3,*) ' In lunsetpixsiz_mrc; nx...: ',nx,ny,nz
!      write(3,*) ' In lunsetpixsiz_mrc; sizex...: ',
!     &                                  sizex,sizey,sizez
!      write(3,*) ' In lunsetpixsiz_mrc; cellax...: ',
!     &                                  cellax,cellay,cellaz


!     SET HEADER VALUES FOR PIXEL SIZE * NO. PIXELS IN CELL
      MRC_HEADER(11) = TRANSFER(CELLAX, IV4)
      MRC_HEADER(12) = TRANSFER(CELLAY, IV4)
      MRC_HEADER(13) = TRANSFER(CELLAZ, IV4)

      IRTFLG = 0
      END


!     ------------------------- LUNSETANGS_MRC ------------------------

      SUBROUTINE LUNSETANGS_MRC(LUN,NANG,ANGS,IRTFLG)   !UNUSED??

C     PURPOSE:  SET ANGLES, NOTE THAT MRC HAS 6, SPIDER HAS 9
C     LOCATIONS 43-48 ANG1...ANG6  USING SPIDER ANGLE CONVENTIONS

#include "LUNHDR.INC"

      INTEGER           :: LUN,NANG,IRTFLG
      REAL              :: ANGS(6)

      INTEGER           :: IV4
   
C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     SET HEADER VALUES FOR ANGLES
      MRC_HEADER(42) = NANG
      MRC_HEADER(43) = TRANSFER(ANGS(1), I4V)
      MRC_HEADER(44) = TRANSFER(ANGS(2), I4V)
      MRC_HEADER(45) = TRANSFER(ANGS(3), I4V)
      MRC_HEADER(46) = TRANSFER(ANGS(4), I4V)
      MRC_HEADER(47) = TRANSFER(ANGS(5), I4V)
      MRC_HEADER(48) = TRANSFER(ANGS(6), I4V)

      IRTFLG = 0
      END

C     ------------------------- LUNGETANGS_MRC ------------------------

      SUBROUTINE LUNGETANGS_MRC(LUN,NANG,ANGS,IRTFLG)  !! UNUSED

C     PURPOSE:  RETRIEVE ANGLES, NOTE THAT MRC HAS 6 SPIDER HAS 9
C     LOCATIONS 43-48 ANG1...ANG6  USING SPIDER ANGLE CONVENTIONS

#include "LUNHDR.INC"

      REAL              :: ANGS(6)
      INTEGER           :: LUN,NANG,IRTFLG

      REAL              :: FVAL

C     POINT TO HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     RETRIEVE HEADER VALUES FOR ANGLES
      NANG    = MRC_HEADER(42)
      ANGS(1) = TRANSFER(MRC_HEADER(43),FVAL)
      ANGS(2) = TRANSFER(MRC_HEADER(44),FVAL)
      ANGS(3) = TRANSFER(MRC_HEADER(45),FVAL)
      ANGS(4) = TRANSFER(MRC_HEADER(46),FVAL)
      ANGS(5) = TRANSFER(MRC_HEADER(47),FVAL)
      ANGS(6) = TRANSFER(MRC_HEADER(48),FVAL)

      IRTFLG = 0
      END

C     ------------------------- LUNGETSIZE_MRC ------------------------

      SUBROUTINE LUNGETSIZE_MRC(LUN,NX,NY,NZ,IRTFLG)

#include "LUNHDR.INC"

      INCLUDE 'CMLIMIT.INC'

      INTEGER   :: LUN,NX,NY,NZ,IRTFLG 

      CHARACTER (LEN=MAXNAM)  :: FILNAM
      CHARACTER (LEN=1)       :: DSP
      INTEGER                 :: NLET 

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET RETURN VALUES
      NX = MRC_HEADER(1)
      NY = MRC_HEADER(2)
      NZ = MRC_HEADER(3)

      IF (NZ < 0) NZ = -NZ

C     HACK TO HANDLE RELION'S MRCS/mrcs STACK FILE WITHOUT MZ VALUE

C     RETRIEVE CURRENT FILENAME (INCLUDES IMGNUM IF STACKED IMAGE)
      CALL LUNGETFILE_MRC(LUN,FILNAM,NLET,DSP,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
       
      IF (INDEX(FILNAM(1:NLET),'.mrcs') > 0 .OR.
     &    INDEX(FILNAM(1:NLET),'.MRCS') > 0) THEN 
         NZ = 1    ! RELION MRC IMAGE STACK
      ENDIF
      !write(3,*) ' In lunsetmrchdr; filnam: ',filnam(1:nlet), nz

      IRTFLG = 0
      END

C     ------------------------- LUNGETVALS_R_MRC ----------------------

      SUBROUTINE LUNGETVALS_R_MRC(LUN,IGO,NVAL,BUFOUT,IRTFLG)

C     GET RETURN VALUES, ONLY WORKS FOR REALS STORED AS I*4

#include "LUNHDR.INC"

      INCLUDE 'CMLIMIT.INC'    ! PROVIDES IAPLOC
      INTEGER,PARAMETER :: IAPLOC_MRC  = 29

      REAL              :: BUFOUT(NVAL)
      INTEGER           :: LUN,IGO,NVAL,IRTFLG

      REAL              :: FVAL
      INTEGER           :: IEND,I,IGOMRC

      INTEGER           :: JENIS(56)  ! INTEGER=1,REAL=2,CHAR=3

C                1,2,3, 4, 5,6,7, 8,9,10, 11,12,13, 14,15,16,
      JENIS = (/ 1,1,1, 1, 1,1,1, 1,1, 1,  2, 2, 2,  2, 2, 2,   

C                17,18,19, 20,21,22, 23, 24 25,26, 27,28,
     &            1, 1, 1,  2, 2, 2,  1,  1, 1, 3,  3, 1, 

C                29,30,31,32,33,34,35,36,37,38,39,40,41, 42,
     &            2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  1,

C                43,44,45,46,47,48,49, 50,51,52, 53,54, 55, 56
     &            2, 2, 2, 2, 2, 2, 2,  2, 2, 2,  3, 1,  2,  1 /)


C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     HACK FOR TRANSLATING MRC IAPLOC INSTEAD OF SPIDER LOCATIONS
      IGOMRC = IGO
      IF (IGO == (IAPLOC + 1)) THEN
         IGOMRC = IAPLOC_MRC
      ENDIF
 
      IEND = IGOMRC + NVAL - 1
      IF (IGOMRC < 1 .OR. IEND > 256) THEN
         CALL ERRT(102,'HEADER LOCATION MUST BE 1...256',IEND)
         IRTFLG = 1
         RETURN
      ENDIF

C     GET REAL RETURN VALUES
      DO I = IGOMRC,IEND
         IF (JENIS(I) == 2) THEN
            BUFOUT(I-IGOMRC+1) = TRANSFER(MRC_HEADER(I),FVAL)
         ELSEIF (JENIS(I) == 1) THEN
            BUFOUT(I-IGOMRC+1) = MRC_HEADER(I)
         ELSE
           CALL ERRT(102,'CHARACTER HEADER LOCATION',I)
           IRTFLG = 1
           RETURN
         ENDIF
      ENDDO

      IRTFLG = 0
      END

C     ------------------------- LUNSETVALS_R_MRC ----------------------

      SUBROUTINE LUNSETVALS_R_MRC(LUN,IGO,NVAL,BUFVALS,IRTFLG)

C     SET HEADER VALUES ONLY WORKS FOR REALS STORED AS I*4
#include "LUNHDR.INC"

      INCLUDE 'CMLIMIT.INC'    ! PROVIDES IAPLOC
      INTEGER,PARAMETER :: IAPLOC_MRC  = 29

      REAL              :: BUFVALS(NVAL)
      INTEGER           :: LUN,IGO,NVAL,IRTFLG

      INTEGER           :: IEND,I,IGOMRC
      INTEGER           :: I4V

      INTEGER           :: JENIS(56)
      REAL              :: FVAL

C                1,2,3, 4, 5,6,7, 8,9,10, 11,12,13, 14,15,16,
      JENIS = (/ 1,1,1, 1, 1,1,1, 1,1, 1,  2, 2, 2,  2, 2, 2,   

C                17,18,19, 20,21,22, 23, 24 25,26, 27,28,
     &            1, 1, 1,  2, 2, 2,  2,  2, 2, 2,  2, 2, 

C                29,30,31,32,33,34,35,36,37,38,39,40,41, 42,
     &            2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  1,

C                43,44,45,46,47,48,49, 50,51,52, 53,54, 55, 56
     &            2, 2, 2, 2, 2, 2, 2,  2, 2, 2,  3, 1,  2,  1 /)


C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     HACK FOR TRANSLATING MRC IAPLOC INSTEAD OF SPIDER LOCATIONS
      IGOMRC = IGO
      IF (IGO == (IAPLOC + 1)) THEN
         IGOMRC = IAPLOC_MRC
      ENDIF
 
      IEND = IGOMRC + NVAL - 1
      IF (IGOMRC < 1 .OR. IEND > 56) THEN
         CALL ERRT(102,'HEADER LOCATION MUST BE 1...56',IEND)
         IRTFLG = 1
         RETURN
      ENDIF

C     SET HEADER VALUES WRITTEN AS I*4
      DO I = IGOMRC,IEND
         !write(3,*) ' Bufvals: ',jenis(i),bufvals(i-igomrc+1)

         IF (JENIS(I) == 2) THEN
            MRC_HEADER(I) = TRANSFER(BUFVALS(I-IGOMRC+1),I4V)   

         ELSEIF (JENIS(I) == 1) THEN
C           CONVERT REAL VALUE TO INTEGER
            MRC_HEADER(I) = BUFVALS(I-IGOMRC+1)   

         ELSE
           CALL ERRT(102,'CHARACTER HEADER LOCATION',I)
           IRTFLG = 1
           RETURN
         ENDIF
      ENDDO

      IRTFLG = 0
      END

C     ------------------------- LUNGETTYPE_MRC ------------------------

      SUBROUTINE LUNGETTYPE_MRC(LUN,ITYPE,IRTFLG)

      IMPLICIT NONE

      INTEGER   :: LUN,ITYPE,IRTFLG
 
      INTEGER   :: NX,NY,NZ

C     NZ IS ADJUSTED FOR RELION .mrcs FILES IF NEEDED
      CALL LUNGETSIZE_MRC(LUN,NX,NY,NZ,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
      
C     RETURN FILE TYPE USING SPIDER'S CONVENTION 
      ITYPE = 1
      IF (NZ > 1) ITYPE = 3   ! MRC FOURIER NOT SUPPORTED

      IRTFLG = 0
      END

C     ------------------------- LUNGETSTK_MRC -------------------------

       SUBROUTINE LUNGETSTK_MRC(LUN,MZ,NSTACK,IMGNUM,IRTFLG)

#include "LUNHDR.INC"

      INTEGER   :: LUN,MZ,NSTACK,IMGNUM,IRTFLG

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET RETURN VALUES
      MZ     = MRC_HEADER(10)    ! CAN BE NSTACK 
      IMGNUM = MRC_HEADER(259)   ! CURRENT IMAGE IN HEADER
      NSTACK = MRC_HEADER(260)   ! NUMBER OF IMAGES/VOLUMES IN STACK

      IRTFLG = 0
      END

C     ------------------------- LUNSETSTK_MRC--------------------------

      SUBROUTINE LUNSETSTK_MRC(LUN,IMGNUM,NSTACK,IRTFLG)

#include "LUNHDR.INC"

      INTEGER  :: LUN,IMGNUM,NSTACK,IRTFLG

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     SET STACK RELATED STATIC HEADER VALUES
      MRC_HEADER(259) = IMGNUM  ! CURRENT IMAGE IN HEADER
      MRC_HEADER(260) = NSTACK  ! NUMBER OF IMAGES/VOLUMES IN STACK
 
      ! write(3,*)' In lunsetstk_mrc; nstack: ',nstack

      IRTFLG = 0
      END

C     ------------------------- LUNGETNSTACK_MRC ----------------------

       SUBROUTINE LUNGETNSTACK_MRC(LUN, NX,NY,NZ,MZ,NSTACK,IRTFLG)

C      PURPOSE: GET SPIDER'S NSTACK FROM MRC HEADER INFO 
C               MRC FILES LACK STANDARD ENCODING FOR STACK SIZE
C               AND SOME VOLUMES LOOK LIKE STACKS SO THIS IS COMPLEX!!
C
C      RETURNS:   NZ   MZ    NSTACK 

#include "LUNHDR.INC"
      INCLUDE 'CMLIMIT.INC'

      INTEGER                :: LUN,NX,NY,NZ,MZ,NSTACK,IRTFLG

      CHARACTER (LEN=MAXNAM) :: FILNAM     
      CHARACTER (LEN=1)      :: DSP
      INTEGER                :: NZMRC,NLET,IVERSION,ISPG

      INTEGER                :: lnblnkn   ! FUNCTION

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     GET HEADER VALUES
      NX       = MRC_HEADER(1) 
      NY       = MRC_HEADER(2) 
      NZMRC    = MRC_HEADER(3)   ! NO. OF IMAGES IN RELION mrcs FILES!
      MZ       = MRC_HEADER(10)  ! CAN BE EITHER NSTACK OR NZ 
      IVERSION = MRC_HEADER(28)
      ISPG     = MRC_HEADER(23)

      !write(3,*)' In lungetnstack; iversion,ispg :', iversion,ispg
      !write(3,*)' In lungetnstack; nzmrc,mz,nz,nstack:', nzmrc,mz,nz,nstack

C     GET CURRENT FILE NAME FROM LUNFILNAM COMMON
      CALL LUNGETFILE_MRC(LUN,FILNAM,NLET,DSP,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
      !write(3,*)' In lungetnstack; nlet,filnam:', nlet,filnam(1:nlet)

      IF (INDEX(FILNAM(1:NLET),'.mrcs') > 0 .OR.
     &    INDEX(FILNAM(1:NLET),'.MRCS') > 0) THEN
C        HACK FOR RELION mrcs IMAGE STACKS HAVING NZ > 1
C        IN RELION  THIS WAS A STACK OF IMAGES NOT A VOLUME
         NZ     = 1        ! DO NOT WANT TO OVERWRITE THIS??
         NSTACK = NZMRC    ! WAS NZ IN FILE

C      elseif (index(filnam(1:nlet),'.mrc') > 0 .or.
c     &        index(filnam(1:nlet),'.mrc') > 0) then
c        cp from mrcv will be required to read volumes as volumes
c        not sure if this will break things  Tapu Sept 2025
c        this  broke things  dean sept 2025
c        nz     = 1        ! do not want to overwrite this??
c        nstack = nzmrc    ! was nz in file

      ELSEIF (INDEX(FILNAM(1:NLET),'.map') > 0 .OR.
     &        INDEX(FILNAM(1:NLET),'.MAP') > 0) THEN
C        HACK FOR EMD VOLUME 
         NZ     = NZMRC    ! DO NOT WANT TO OVERWRITE THIS??
         NSTACK = -2       ! WAS NZ IN FILE
         !write(3,*)' In lungetnstack 1, :', nz,nstack

      ELSEIF (INDEX(FILNAM(1:NLET),'@@') > 0 .AND. 
     &        NZMRC == 1 .AND. MZ == 1) THEN
C        HACK FOR IMAGE STACKS CONTAINING ONLY ONE IMAGE
         NZ     = 1        ! 
         NSTACK = 1        !  
         !write(3,*)' In lungetnstack 2, :', nz,nstack

      ELSEIF (ISPG == 0 .AND. MZ > 1 .AND. IVERSION == 20140) THEN
C        STACK OF IMAGES IN NEW MRC FORMAT VERSION
         NZ     = 1
         NSTACK = MZ
         !write(3,*)' In lungetnstack 3, :', nz,nstack

      ELSEIF (ISPG >= 410) THEN
C        STACK OF VOLUMES IN NEW MRC FORMAT VERSION
         NZ     = NZMRC
         NSTACK = MZ
         !write(3,*)' In lungetnstack 4, :', nz,nstack

      ELSEIF (MZ > 1 .AND. NZMRC == MZ) THEN
C        VOLUME 
         NZ     = NZMRC
         NSTACK = -2
         !write(3,*)' In lungetnstack 5, :', nz,nstack

      ELSE
C        VOLUME/IMAGE.  NOT A STACK
         NZ     = NZMRC
         NSTACK = -2     ! NOT STACK, RETURN NEGATIVE (-2)
         !write(3,*)' In lungetnstack 6, :', nz,nstack
      ENDIF

      !write(3,*)' In lungetnstack, ispg,nz,nstack:',ispg,nz,nstack
      IRTFLG = 0
      END

C     ------------------------- LUNSETNSTACK_MRC-----------------------

       SUBROUTINE LUNSETNSTACK_MRC(LUN, NZ,NSTACK,IRTFLG)

C      PURPOSE: UPDATE NSTACK RELATED LOCATIONS IN MRC HEADER. 
C               MRC FILES LACK STANDARD ENCODING FOR STACK SIZE
C               SO THIS IS COMPLEX!!

#include "LUNHDR.INC"
      INCLUDE 'CMLIMIT.INC'    ! FOR MAXNAM

      INTEGER                :: LUN,NZ,NSTACK,IRTFLG

      CHARACTER (LEN=MAXNAM) :: FILNAM     
      CHARACTER (LEN=1)      :: DSP
      INTEGER                :: NZMRC,MZ,NLET,IVERSION,ISPG

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      IVERSION = MRC_HEADER(28)
      ISPG     = MRC_HEADER(23)

C     GET CURRENT FILE NAME FROM LUNFILNAM COMMON
      CALL LUNGETFILE_MRC(LUN,FILNAM,NLET,DSP,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN
      !write(3,*)' In lunsetnstack, nlet,filnam:', nlet,filnam(1:nlet)
      !write(3,*)' In lunsetnstack, :', iversion,ispg,nz,nstack

      IF (( (INDEX(FILNAM,'MRCS') > 1  .OR.
     &       INDEX(FILNAM,'mrcs') > 1) .OR.
     &      (NSTACK >= 1 .AND. NZ > 1 ))) THEN
C        A RELION COMPATIBLE IMAGE STACK
         NZMRC  = NSTACK         
         MZ     = 1

      ELSEIF (NSTACK >= 1 .AND. NZ == 1 .AND.
     &        IVERSION == 20140 .AND. ISPG == 0) THEN
C        A 2014 STANDARD STACK OF IMAGES
         NZMRC  = NZ                     
         MZ     = NSTACK

      ELSEIF (NSTACK >= 1 .AND. NZ == 1 .AND.
     &        IVERSION == 20140 .AND. ISPG == 0) THEN
C        A 2014 STANDARD STACK OF IMAGES
         NZMRC  = NZ                     
         MZ     = NSTACK

      ELSEIF (NSTACK >= 1  .AND.NZ > 1  .AND.
     &        IVERSION == 20140 .AND. ISPG == 401) THEN
C        A 2014 STANDARD STACK OF EM VOLUMES
         NZMRC  = NZ          
         MZ     = NZ * NSTACK

      ELSEIF (NSTACK < 0 .AND. NZ == 1) THEN
C        A SINGLE IMAGE
         NZMRC  = 1                      
         MZ     = 1
      ELSEIF (NSTACK < 0 .AND. NZ > 1 ) THEN
C        A SINGLE VOLUME
         NZMRC  = NZ        
         MZ     = NZ
      ELSE 
         CALL ERRT(102,'BAD STACK OR VOLUME PARAMETERS',NSTACK)
         IRTFLG = 1
         RETURN
      ENDIF

C     UPDATE HEADER VALUES
      MRC_HEADER(3)  = NZMRC  
      MRC_HEADER(10) = MZ     
 
      IRTFLG = 0
      END

C     ------------------- LUNSETCOMMON_MRC ----------------------------

      SUBROUTINE LUNSETCOMMON_MRC(LUN,IRTFLG)

C     PURPOSE: SET SPIDER COMMON BLOCK AND REGISTER VALUES 

      IMPLICIT NONE
      INCLUDE 'CMBLOCK.INC'

      INTEGER           :: LUN,IRTFLG

      CHARACTER(LEN=12) :: CDUM
      CHARACTER(LEN=1)  :: NULL = CHAR(0)
      INTEGER           :: IVERSION,ISPG,NSYMBT,NLABL
      INTEGER           :: NSTACK,NSLICE,IMGNUM,MZ,NANG
      REAL              :: ANGS(9)

C     INCLUDE 'LABLOCK.INC'
C     LABLOCK HAS BEEN INLINED 
C     LABNEW   COMMON BLOCK FOR FILE HEADER VARIABLES
C              USED IN OPENF, FILGEN, FSTACK, FSTADD, ETC.
C     LABLEN             NUMBER OF FLOATING POINT VARIABLES IN LABEL
C     IANGLE             NUMBER OF ANGLES PRESENT
C     PHI,THETA,PSI      ROTATION
C     XOFF,YOFF,ZOFF     X,Y,Z TRANSLATION
C     SCALE,FLAG
C     KANGLE             NUMBER OF SECONDARY ANGLES PRESENT
C     PHI2,THETA2,PSI2   SECONDARY ANGLES
C     PHI1,THETA1,PSI1   SECONDARY ANGLES
C     HDR_VALS           HEADER LOCATIONS 37...101

      INTEGER    :: LABLEN,IANGLE,KANGLE
      REAL       :: PHI,THETA,PSI,XOFF,YOFF,ZOFF,SCALE,FLAG
      REAL       :: PHI2,THETA2,PSI2,PHI1,THETA1,PSI1
      REAL       :: HDR_VALS(64)

      COMMON/LABNEW/LABLEN,IANGLE,PHI,THETA,PSI,XOFF,YOFF,ZOFF,
     &              SCALE,FLAG,KANGLE,PHI2,THETA2,PSI2,PHI1,
     &              THETA1,PSI1,HDR_VALS


C     RARE ANGLE HEADER VALUES NOT AVAILABLE IN MRC FILES
      CALL LUNGETANGS_MRC(LUN,NANG,ANGS,IRTFLG)  ! UNUSED??
      IANGLE   = 0
      KANGLE   = 0

      PHI      = 0.0
      THETA    = 0.0
      PSI      = 0.0

      PHI1     = 0.0
      THETA1   = 0.0
      PSI1     = 0.0


      PHI2      = 0.0
      THETA2    = 0.0
      PSI2      = 0.0

      IF (NANG > 0) THEN
         IANGLE = 1
         PHI    = ANGS(1)
         THETA  = ANGS(2)
         PSI    = ANGS(3)
      ENDIF

      IF (NANG > 3) THEN
         KANGLE = 1
         PHI1   = ANGS(4)
         THETA1 = ANGS(5)
         PSI1   = ANGS(6)
      ENDIF

C     GET HEADER EXTRA LENGTH = NSYMBT 
      CALL LUNGETVIN_MRC(LUN,IVERSION,ISPG,NSYMBT,NLABL,IRTFLG)
      LABLEN = 1024 + NSYMBT

C     RETRIEVE NSTACK & CURRENT IMGNUM
      CALL LUNGETSTK_MRC(LUN,MZ,NSTACK,IMGNUM,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     RETRIEVE VOLUME/IMAGE SIZE  
      CALL LUNGETSIZE_MRC(LUN,NSAMC,NROWC,NSLICE,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     SET VOLUME/IMAGE STATISTICS: FMIN... IN CMBLOCK COMMON 
      CALL LUNGETSTATS_MRC(LUN,IMAMI,FMIN,FMAX,AV,SIG,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     RECOVER FILE DATE, TIME & TITLE FROM HEADER
C     DATE NOT PASSED IN COMMON ANY MORE AS COMMON IS ONLY 10 CHAR.
      CTIM = ' '
      CTIT = ' '
      CDAT = ' '
 
C     SET RESERVED REGISTER VALUES AS NEEDED (SELDOM USED NOW??)
      CALL REG_SET(1,FLOAT(NSAMC),  NULL, IRTFLG)
      CALL REG_SET(2,FLOAT(NROWC),  NULL, IRTFLG)
      CALL REG_SET(3,FMAX,          NULL, IRTFLG)
      CALL REG_SET(4,FMIN,          NULL, IRTFLG)
      CALL REG_SET(5,AV,            NULL, IRTFLG)
      CALL REG_SET(6,SIG,           NULL, IRTFLG)
      CALL REG_SET(7,FLOAT(NSLICE), NULL, IRTFLG) 
      CALL REG_SET(8,FLOAT(NSTACK), NULL, IRTFLG) 

      IRTFLG = 0
      END

C     ------------------------- LUNGETLABELS_MRC -----------------------

      SUBROUTINE LUNGETLABELS_MRC(LUN,NLABL,LABELS,IRTFLG)

#include "LUNHDR.INC"

      INTEGER            :: LUN,NLABL,IRTFLG 
C     CHARACTER(LEN=800) :: LABELS    ; GFORT COMPILER ERROR SEPT 2025
      CHARACTER(LEN=*)   :: LABELS

      INTEGER            :: INOW,I,IGO,IEND,IFLIP
      INTEGER            :: IGOL,IENDL,IGOH,IENDH,IL

      CHARACTER(LEN=4)   :: CSTR

C     POINT TO MRC HEADER OBJECT
      CALL LUNGETOBJ_MRC(LUN,MRC_HEADER,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      IRTFLG = 1    ! Default error return Sept 2025

      !write(3,*)' In lungetlabels_mrc, nlabl:',nlabl

      IF (NLABL < 0 .OR. NLABL > 80) THEN
          write(3,*) ' In lungetlabels_mrc, Bad nlabl: ',nlabl
          RETURN  ! Stop if we would overflow
      ENDIF

C     GET THE EXISTING NLABL LABELS

      IGOL  = 1
      IENDL = NLABL * 20

      IGOH  = 57
      IENDH = 56 + NLABL * 20

      IL    = -3

      !write(3,*)' In lungetlabels_mrc, len(labels):',len(labels)
      !write(3,*)' In lungetlabels_mrc, nlabl,igoh,iendh,il: ',
      !&                                 nlabl,igoh,iendh,il 
 
      DO IH = IGOH,IENDH      ! 57...57+2*20

        IL = IL + 4

        !write(3,*)' In lungetlabels_mrc, ih,il:',ih,il
 
        LABELS(IL:IL+3) = TRANSFER(MRC_HEADER(IH),CSTR(1:4))

        !write(3,*)' In lungetlabels_mrc, ih,il,labels: ',
        !&                                ih,il,labels(il:il+3) 
      ENDDO
      IGOL  = 1

      !write(3,*)' In lungetlabels_mrc, labels(1:80): ',
      !&                                labels(1:80) 

      CALL LUNGETFLIP(LUN,IFLIP,IRTFLG)

      IF (IFLIP == 1 ) THEN
c        write(3,*) ' In lungetlabels, iflip: ',iflip

         IEND = NLABL * 80
         CALL REVERSEBYTES(LABELS,IEND,IRTFLG)
      ENDIF

C     STRIP LEADING BLANKS FROM LABELS (UNTIDY HACK)
      DO ILAB = 1,NLABL
         IGO  = (ILAB - 1) * 80 + 1
         IEND = IGO + 80 - 1
         IF (IEND > LEN(LABELS)) RETURN   ! Stop if overflow

         DO I = IGO,IEND
            IF (LABELS(I:I) .NE. ' ') THEN
                LABELS(IGO:IEND) = LABELS(I:IEND)
                EXIT
            ENDIF
         ENDDO
      ENDDO

      IRTFLG = 0
      END

C     ------------------------- LUNSAYINFO_MRC ------------------------

      SUBROUTINE LUNSAYINFO_MRC(LUN,SAYIT,IRTFLG)

      INCLUDE 'CMLIMIT.INC'
      INCLUDE 'CMBLOCK.INC'

      INTEGER              :: LUN,IRTFLG
      LOGICAL              :: SAYIT

      INTEGER              :: ITYPE,NSTACK,NX,NY,NZ,IMGNUM
      INTEGER              :: LENLABEL1,HEDBYT
      INTEGER              :: IVERSION,ISPG,NSYMBT,NLABL
      INTEGER              :: MAXIM,LENT,NLET,LT,MZ,MRCMODE
      INTEGER              :: ICOMM,MYPID,MPIERR

      CHARACTER(LEN=1)     :: NULL = CHAR(0)
      CHARACTER(LEN=MAXNAM):: FILNAM
      CHARACTER(LEN=1)     :: DSP
      CHARACTER(LEN=5)     :: DTP
      CHARACTER(LEN=104)   :: CSTRING
      CHARACTER(LEN=11)    :: TYPEF
      CHARACTER(LEN=80)    :: LABEL1
      CHARACTER(LEN=4)     :: CAXIS
      CHARACTER(LEN=1)     :: MODE_STR

      IRTFLG = 0
      IF (.NOT. SAYIT) RETURN

C     SET ICOMM AND MYPID
      CALL SET_MPI(ICOMM,MYPID,MPIERR) 

C     RETRIEVE SPIDER'S ITYPE  
      CALL LUNGETTYPE_MRC(LUN,ITYPE,IRTFLG)
      !write(3,*) 'In lunsayinfo_mrc,  type:',itype

C     RETRIEVE MRC MODE 
      CALL LUNGETMODE_MRC(LUN,MRCMODE,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

      IF     (MRCMODE == 0) THEN
         MODE_STR = '0'
      ELSEIF (MRCMODE == 1) THEN
         MODE_STR = '1'
      ELSEIF (MRCMODE == 6) THEN
         MODE_STR = '6'
      ELSEIF (MRCMODE == 2) THEN
         MODE_STR = '2'
      ENDIF


C     RETRIEVE CURRENT HEADER NSTACK & IMGNUM
      CALL LUNGETSTK_MRC(LUN,MZ,NSTACK,IMGNUM,IRTFLG)
      !write(3,*)' In lunsayinfo_mrc,  mz,nstack,imgnum 1:',
c    &                                 mz,nstack,imgnum

C     RETRIEVE SIZE
      CALL LUNGETNSTACK_MRC(LUN, NX,NY,NZ,MZ,NSTACK,IRTFLG)
      !write(3,*)' In lunsayinfo_mrc, mz,nstack,imgnum 2:',
c    &                                mz,nstack,imgnum

      IF     (ITYPE == 1 .AND. NSTACK > 0) THEN
          TYPEF = 'MRC-' // MODE_STR // ' S2'
      ELSEIF (ITYPE == 3 .AND. NSTACK > 0) THEN
          TYPEF = 'MRC-' // MODE_STR // ' S3'
      ELSEIF (ITYPE == 1) THEN
          TYPEF = 'MRC-' // MODE_STR // ' 2'
      ELSEIF (ITYPE == 3) THEN
          TYPEF = 'MRC-' // MODE_STR // ' 3'
      ENDIF
      LT = lnblnkn(TYPEF)

C     GET DATA ORIGIN & HANDEDNES
      CALL LUNGETHAND_MRC(LUN,CAXIS,IRTFLG)
      IF (IRTFLG .NE. 0) RETURN

C     RETRIEVE CURRENT FILENAME (INCLUDES IMGNUM IF STACKED IMAGE)
      CALL LUNGETFILE_MRC(LUN,FILNAM,NLET,DSP,IRTFLG)
      !write(3,*)' After lungetfile, nlet,filnam:', nlet,filnam(1:nlet)
      
C     GET HEADER EXTRA LENGTH = NSYMBT 
      CALL LUNGETVIN_MRC(LUN,IVERSION,ISPG,NSYMBT,NLABL,IRTFLG)
      HEDBYT = 1024 + NSYMBT

C     NO FILE DATE, TIME OR TITLE IN MRC FILE HEADER
C     RECOVER LABEL #1 TO USE FOR  TITLE FROM HEADER INSTEAD
      CALL LUNGETLABELS_MRC(LUN,1,LABEL1,IRTFLG)
      LENLABEL1 = lnblnkn(LABEL1)
     
      DTP = '(OLD)'
      IF (DSP == 'N') DTP = '(NEW)'

C     FOR SPIRE OUTPUT
      IF (USE_SPIRE .AND. DSP == 'N' .AND. FILNAM(1:1) .NE. '_') THEN
         CALL SPIREOUT(FILNAM(:NLET),IRTFLG)

         IF (NSTACK .NE. 0 .AND. IMGNUM == 0 .AND. NZ > 1) THEN
C           OVERALL STACKED VOLUME 
            WRITE(CSTRING,890)TYPEF(:LT),NX,NY,NZ,NSTACK, DTP,HEDBYT

         ELSEIF (NSTACK .NE. 0 .AND. IMGNUM == 0) THEN
C           OVERALL STACKED IMAGE 
            WRITE(CSTRING,900)TYPEF(:LT),NX,NY,   NSTACK,DTP,HEDBYT

         ELSEIF (NSTACK .NE. 0 .AND. IMGNUM > 0 .AND. NZ > 1) THEN
C           STACKED VOLUME 
            WRITE(CSTRING,910)TYPEF(:LT),NX,NY,NZ,IMGNUM, DTP,HEDBYT

         ELSE IF (IMGNUM > 0) THEN
C           STACKED IMAGE
            WRITE(CSTRING,920)TYPEF(:LT),NX,NY,   IMGNUM,DTP

        ELSE IF (NZ > 1) THEN
C           SIMPLE VOLUME
            WRITE(CSTRING,930)TYPEF(:LT),NX,NY,NZ,DTP,HEDBYT

         ELSE
C           SIMPLE IMAGE
            WRITE(CSTRING,940)TYPEF(:LT),NX,NY,   DTP,HEDBYT
         ENDIF

         CALL SPIREOUT(CSTRING,IRTFLG)
      ENDIF     ! END OF USE_SPIRE


      !write(3,*)' In lunsayinfo_mrc - imgnum,nstack,mz:',
      !&                                imgnum,nstack,mz

      IF (VERBOSE .AND. IFOUND .NE. -4) THEN
C         PRINT FILE OPENING INFORMATION

         LENT = LENLABEL1 + NLET   ! LENGTH OF FILENAME AND LABEL1

         IF (NLET > 0 .AND. LENLABEL1 <= 0) THEN
C           HAS FILENAME BUT NO LABEL1
            IF (MYPID <= 0) THEN
               WRITE(NOUT,*) ' ',FILNAM(:NLET)
            ENDIF

         ELSEIF (LENT > 0 .AND. LENT < 70) THEN
C           HAS FILENAME AND LABEL1 THAT FIT ON ONE LINE
            IF (MYPID <= 0) THEN
               WRITE(NOUT,*) ' ',FILNAM(:NLET),'     /',
     &                       LABEL1(1:LENLABEL1)
            ENDIF

         ELSEIF (LENT > 0) THEN
C           HAS FILENAME AND LABEL1 THAT DO NOT FIT ON SINGLE LINE
            IF (MYPID <= 0 .AND. NLET > 0 ) THEN
               WRITE(NOUT,'(2X,A)') FILNAM(:NLET)
               WRITE(NOUT,88) LABEL1(1:LENLABEL1)
88             FORMAT('     ',A)
            ENDIF
         ENDIF

         !write(3,*)' In lunsayinfo_mrc; imgnum,nstack,mz:',
         !&                              imgnum,nstack,mz

         IF (NSTACK >= 0 .AND. IMGNUM == 0 .AND. NZ > 1) THEN
C           OVERALL STACKED VOLUME FILE
            IF (MYPID <= 0) THEN
               WRITE(NOUT,890)TYPEF(:LT),NX,NY,NZ, NSTACK, DTP,
     &                        HEDBYT,CAXIS
890            FORMAT('  (',A,') ',3(I0,1X),' (.. ',I0,')',2X,A,
     &                ' HEADER BYTES: ',I0,'  AXIS:(',A,')')
            ENDIF
            
         ELSEIF (NSTACK >= 0 .AND. IMGNUM <= 0) THEN
C           OVERALL STACKED IMAGE FILE 
            IF (MYPID <= 0) THEN
               WRITE(NOUT,900)TYPEF(:LT),NX,NY ,NSTACK, DTP,
     &                        HEDBYT,CAXIS(:2)
900            FORMAT('  (',A,') ',2(I0,1X),' (.. ',I0,')',2X,A,
     &                ' HEADER BYTES: ',I0,'  AXIS:(',A,')')
            ENDIF

         ELSEIF (IMGNUM > 0 .AND. NZ > 1) THEN
C           STACKED VOLUME
            IF (MYPID <= 0) THEN
               WRITE(NOUT,910) TYPEF(:LT),NX,NY,NZ,IMGNUM, DTP,
     &                         HEDBYT,CAXIS
910            FORMAT('  (',A,') ',3(I0,1X),' (@@',I0,')',2X,A,
     &                ' HEADER BYTES: ',I0,'  AXIS:(',A,')')
            ENDIF

         ELSE IF (IMGNUM > 0) THEN
C           STACKED IMAGE
            IF (MYPID <= 0) THEN
               WRITE(NOUT,920)TYPEF(:LT),NX,NY, IMGNUM, DTP,
     &                        HEDBYT,CAXIS(:2)
920            FORMAT('  (',A,') ',2(I0,1X),' (@@',I0,')'2X,A,
     &                ' HEADER BYTES: ',I0,'  AXIS:(',A,')')
            ENDIF

         ELSE IF (NZ > 1) THEN
C           SIMPLE VOLUME
            IF (MYPID <= 0) THEN
               WRITE(NOUT,930)TYPEF(:LT),NX,NY,NZ, DTP,HEDBYT,CAXIS
930            FORMAT('  (',A,') ',3(I0,1X),2X,A, 
     &                ' HEADER BYTES: ',I0,'  AXIS:(',A,')')
            ENDIF

         ELSE
C           SIMPLE IMAGE
            IF (MYPID <= 0) THEN
               WRITE(NOUT,940)TYPEF(:LT),NX,NY,   DTP,HEDBYT,CAXIS(:2)
940            FORMAT('  (',A,') ',2(I0,1X),2X,A,
     &                ' HEADER BYTES: ',I0,'  AXIS:(',A,')')
            ENDIF
         ENDIF
      ENDIF

      IRTFLG = 0
      END
@


1.19
log
@DEBUG OUTPUT ADDED
@
text
@d4 1
a4 1
C                 NATIVE MRC FILE SUPPORT         JUL 2019 ArDean Leith
d9 1
a9 1
C                 DEBUG OUTPUT ADDED              oct 2025 ArDean Leith
d171 1
a171 1
      !write(6,*) ' In lunnewhed_mrc: ',lun,LUNMRCHDRBUF(LUN)%ipt 
d215 1
a215 1
      !write(6,*)' In lunredhed_mrc, mrc_header:',mrc_header(1:9)
d254 1
a254 1
      !write(6,*)' In lunwrthed_mrc; header(25): ',mrc_header(25),lun 
d423 1
a423 1
      !write(6,*)' In lunsetpos_mrc; imgnum,lunmrcpos(lun): ',
d425 1
a425 1
      !write(6,*)' In lunsetpos_mrc; ihedlen,nx,ny,nz,nbyt,imgnum: ',
d427 2
a428 2
      !write(6,*)' In lunsetpos_mrc; nbyt_per_rec: ', nbyt_per_rec
      !write(6,*)' In lunsetpos_mrc; lunmrcpos: ',lunmrcpos(lun)
d524 1
a524 1
        write(6,*) ' In lungetmap_mrc; mrc_header 17,18,19:  ',
a525 1
        write(6,*) ' In lungetmap_mrc; map c,r,s: ',mapc,mapr,maps
d595 1
a595 1
      !write(6,*)' In lunsethand_mrc; caxis: ',mrc_header(26),caxis
d620 1
a620 1
      !write(6,*)' In lungethand_mrc; lun,caxis: ',lun,caxis
d704 1
a704 1
      !write(6,*)' In lunsetstk_mrc; iversion: ',mrc_header(23),nstack
d730 1
a730 1
      !write(6,*) ' In lunsetmodsiz_mrc: ',mrcmode,nx,ny,nz,mx,my,mz
d749 1
a749 1
      !write(6,*) ' In lunsetmode_mrc; mrcmode: ',mrcmode
d776 1
a776 1
      !write(6,*) ' In lungetmodsiz_mrc: ',mrcmode,nx,ny,nz,mx,my,mz
d795 1
a795 1
      !write(6,*) ' In lungetmod_mrc; mrcmode: ',mrcmode
d820 1
a820 1
      ! write(6,*) ' In lungetvin_mrc; iversion', iversion
d845 1
a845 1
      !write(6,*) ' In lunsetvin_mrc; iversion', iversion,ispg
d983 1
a983 1
      !write(6,*)' In lunset_statsimg_mrc; imgstats: ',imgstats
d1060 16
a1075 16
      f21 = TRANSFER(mrc_header(21),f21)
      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
     &     '  In lunSetstats_mrc; lun,fmaxt,mrc_header(21):',
     &        lun,fmaxt,f21

      write(3,'(A,3I7)')
     &     '  In lunSetstats_mrc;  mrc_header 17,18,19: ',
     &         mrc_header(17),mrc_header(18),mrc_header(19)

      write(3,'(A,I5,2X,3(2x,I8))')
     &     '  In lunSetstats_mrc; nstack,imgnum,imgstats,imamit:',
     &                            nstack,imgnum,imgstats,imamit

      write(3,*)'  '
      write(3,*)' Leaving lunSetstats_mrc ------'
      write(3,*)'  '
d1105 1
a1105 1
      IF (AVT   < FMINT) IMAMIT = 0
d1120 1
a1120 1
      f21 = TRANSFER(mrc_header(21),f21)
d1122 8
a1129 8
      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
     &     '  In lunGetstats_mrc; lun,fmaxt,mrc_header(21):',
     &        lun,fmaxt,f21

      write(3,'(A,I5,2X,3(2x,I8))')
     &     '  In lunGetstats_mrc; nstack,imgnum,imgstats,imamit:',
     &                            nstack,imgnum,imgstats,imamit
      write(3,*)'  '
d1142 12
a1153 12
      f21 = TRANSFER(mrc_header(21),f21)
      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
     &     '  In lunGetstats_mrc; lun,fmaxt,mrc_header(21):',
     &        lun,fmaxt,f21

      write(3,'(A,3I7)')
     &     '  In lunGetstats_mrc;  mrc_header 17,18,19: ',
     &         mrc_header(17),mrc_header(18),mrc_header(19)

      write(3,'(A,I5,2X,3(2x,I8))')
     &     '  In lunGetstats_mrc; nstack,imgnum,imgstats,imamit:',
     &                            nstack,imgnum,imgstats,imamit
d1155 2
a1156 2
      write(3,*)' Leaving lunGetstats_mrc ------'
      write(3,*)'  '
d1206 7
a1212 7
      write(3,'(A,I5,2X,F8.1,2X,F8.2)')
     &     '  In lunZerostats_mrc; lun,fmax,mrc_header(21):',
     &        lun,fmax,f21

      write(3,'(A,3I7)')
     &     '  In lunZerostats_mrc;  mrc_header 17,18,19: ',
     &         mrc_header(17),mrc_header(18),mrc_header(19)
d1214 2
a1215 2
      write(3,*)' Leaving lunZerostats_mrc ------'
      write(3,*)'  '
d1293 5
a1297 5
c      write(6,*) ' In lunsetpixsiz_mrc, nx...: ',nx,ny,nz
c      write(6,*) ' In lunsetpixsiz_mrc, sizex...: ',
c     &                                  sizex,sizey,sizez
c      write(6,*) ' In lunsetpixsiz_mrc, cellax...: ',
c     &                                  cellax,cellay,cellaz
d1333 5
a1337 5
c      write(6,*) ' In lunsetpixsiz_mrc; nx...: ',nx,ny,nz
c      write(6,*) ' In lunsetpixsiz_mrc; sizex...: ',
c     &                                  sizex,sizey,sizez
c      write(6,*) ' In lunsetpixsiz_mrc; cellax...: ',
c     &                                  cellax,cellay,cellaz
d1340 1
a1340 1
C     SET HEADER VALUES FOR PIXEL SIZE * NO. PIXELS IN CELL
d1349 1
a1349 1
C     ------------------------- LUNSETANGS_MRC ------------------------
d1444 1
a1444 1
      !write(6,*) ' In lunsetmrchdr; filnam: ',filnam(1:nlet), nz
d1565 1
a1565 1
         !write(6,*) ' Bufvals: ',jenis(i),bufvals(i-igomrc+1)
d1641 1
a1641 1
      ! write(6,*)' In lunsetstk_mrc; nstack: ',nstack
d1678 3
a1680 2
      !write(6,*)' In lungetnstack; iversion,ispg :', iversion,ispg
      !write(6,*)' In lungetnstack; nzmrc,mz,nz,nstack:', nzmrc,mz,nz,nstack
d1685 1
a1685 1
      !write(6,*)' In lungetnstack; nlet,filnam:', nlet,filnam(1:nlet)
d1707 1
a1707 1
         !write(6,*)' In lungetnstack 1, :', nz,nstack
d1714 1
a1714 1
         !write(6,*)' In lungetnstack 2, :', nz,nstack
d1720 1
a1720 1
         !write(6,*)' In lungetnstack 3, :', nz,nstack
d1726 1
a1726 1
         !write(6,*)' In lungetnstack 4, :', nz,nstack
d1732 1
a1732 1
         !write(6,*)' In lungetnstack 5, :', nz,nstack
d1738 1
a1738 1
         !write(6,*)' In lungetnstack 6, :', nz,nstack
d1741 1
a1741 1
      !write(6,*)' In lungetnstack, ispg,nz,nstack:',ispg,nz,nstack
d1772 2
a1773 2
      !write(6,*)' In lunsetnstack, nlet,filnam:', nlet,filnam(1:nlet)
      !write(6,*)' In lunsetnstack, :', iversion,ispg,nz,nstack
d1950 1
a1950 1
      !write(6,*)' In lungetlabels_mrc, nlabl:',nlabl
d1953 1
a1953 1
          write(6,*) ' In lungetlabels_mrc, Bad nlabl: ',nlabl
d1967 2
a1968 2
      !write(6,*)' In lungetlabels_mrc, len(labels):',len(labels)
      !write(6,*)' In lungetlabels_mrc, nlabl,igoh,iendh,il: ',
d1975 1
a1975 1
        !write(6,*)' In lungetlabels_mrc, ih,il:',ih,il
d1979 1
a1979 1
        !write(6,*)' In lungetlabels_mrc, ih,il,labels: ',
d1984 1
a1984 1
      !write(6,*)' In lungetlabels_mrc, labels(1:80): ',
d1990 1
a1990 1
c        write(6,*) ' In lungetlabels, iflip: ',iflip
d2047 1
a2047 1
      !write(6,*) 'In lunsayinfo_mrc,  type:',itype
d2066 1
a2066 1
      !write(6,*)' In lunsayinfo_mrc,  mz,nstack,imgnum 1:',
d2071 1
a2071 1
      !write(6,*)' In lunsayinfo_mrc, mz,nstack,imgnum 2:',
d2091 1
a2091 1
      !write(6,*)' After lungetfile, nlet,filnam:', nlet,filnam(1:nlet)
d2138 1
a2138 1
      !write(6,*)' In lunsayinfo_mrc - imgnum,nstack,mz:',
d2168 1
a2168 1
         !write(6,*)' In lunsayinfo_mrc; imgnum,nstack,mz:',
@


1.18
log
@NBYT, NBYT_PER_VAL CONFUSED in some routines
@
text
@d9 1
d245 1
d254 1
a254 1
      !write(6,*)' In lunwrthed_mrc; header(25): ',mrc_header(25),lun   
d522 7
a528 1
      ! write(6,*) ' In lungetmap_mrc; map c,r,s: ',mapc,mapr,maps
d978 2
d999 1
d1020 1
a1020 1
      REAL     :: FMINT,FMAXT,AVT,SIGT
d1025 2
a1055 3
      !write(6,*)' In lunsetstats_mrc; imgnum,stats: ',imgnum,imgstats


d1060 19
d1089 1
a1089 1
      REAL     :: FMINT,FMAXT,AVT,SIGT
d1119 14
d1141 18
a1158 4
      !write(6,*)' In lungetstats_mrc; stats:',fmint,fmaxt,avt,sigt
      !write(6,*)' In lungetstats_mrc; fmint,fmaxt,imamit: ',
      !&                               fmint,fmaxt,imamit
      !write(6,*)' In lungetstats_mrc; imgstats,imgnum:',imgstats,imgnum
d1200 20
@


1.17
log
@removed debug msg
@
text
@d8 1
d304 1
a304 1
      SUBROUTINE LUNGETPOSINFO_MRC(LUN,NBYT,IHEDLEN,IRTFLG)
d308 1
a308 1
      INTEGER         :: LUN,NBYT,IHEDLEN,IRTFLG
d328 2
a329 1
         NBYT =  1           ! SIGNED    8 BIT INTEGER*1 
d331 2
a332 1
         NBYT =  2           ! SIGNED   16 BIT INTEGER*2
d334 2
a335 1
         NBYT = -2           ! UNSIGNED 16 BIT INTEGER*2
d337 2
a338 1
         NBYT =  4           ! REAL*4  
d340 1
a340 1
         NBYT   = 0          ! NOT A VALID MRC FILE
d342 1
d354 5
a358 1
      INTEGER         :: LUN,IMGNUM,IRTFLG
d360 1
a360 4
      INTEGER * 8     :: LUNMRCPOS 
      INTEGER         :: LUNMRCNBYT
      COMMON /LUNMRC/    LUNMRCPOS(100),LUNMRCNBYT(100)
      INTEGER         :: LUNARA,LUNSTK,LUNARB,LUNFLIP
d373 1
a373 1
      CALL LUNGETPOSINFO_MRC(LUN,NBYT,IHEDLEN,IRTFLG)
d380 1
a380 1
      LUNMRCNBYT(LUN) = NBYT       ! PRESERVES NEGATIVE FOR SIGN
d382 1
a382 1
      NBYT_PER_VAL    = ABS(NBYT)   
d394 1
d437 6
a442 2
      INTEGER         :: LUN,NX,NY,NZ,IRTFLG
      LOGICAL         :: RESET
d444 1
a444 4
      INTEGER * 8     :: LUNMRCPOS 
      INTEGER         :: LUNMRCNBYT
      COMMON /LUNMRC/    LUNMRCPOS(100),LUNMRCNBYT(100)
      INTEGER         :: LUNARA,LUNSTK,LUNARB,LUNFLIP
d470 1
a470 1

a734 5

      INTEGER * 8     :: LUNMRCPOS 
      INTEGER         :: LUNMRCNBYT
      COMMON /LUNMRC/    LUNMRCPOS(100),LUNMRCNBYT(100)

@


1.16
log
@LUNGETLABELS_MRC changed,  debug output added, lungetnstack changes reversed
Handle invalid index (LUN=0, etc.)  Sept 2025
IS_MRC = (LUNMRCPOS(LUN) .NE. 0)
other bugs fixed
@
text
@d2087 2
a2088 2
         write(6,*)' In lunsayinfo_mrc; imgnum,nstack,mz:',
     &                                   imgnum,nstack,mz
@


1.15
log
@label overflow trap
@
text
@d1 7
a7 1
C++*********************************************************************
a8 3
C LUNSETMRCHDR.F    DERIVED FROM LUNSETHDR.F    JUN 2019  ArDean Leith
C                   NATIVE MRC FILE SUPPORT     JUL 2019  ArDean Leith
C                    
d15 1
d110 1
a110 1
C      RMS      = TRANSFER(MRC_HEADER(55),FVAL) ! DEVIATION FROM MEAN DENSITY          
d169 1
a169 1
      !write(3,*) ' In lunnewhed_mrc: ',lun,LUNMRCHDRBUF(LUN)%ipt 
d213 1
a213 1
      !write(3,*)' In lunredhed_mrc, mrc_header:',mrc_header(1:9)
d250 2
a251 1
      !write(3,*)' In lunwrthed_mrc, header(25): ',mrc_header(25),lun   
d413 6
a418 7
      !write(3,*) ' In lunsetpos_mrc, imgnum,lunmrcpos(lun): ',
      !&                               imgnum,lunmrcpos(lun)

      !write(3,*)' In lunsetpos_mrc, ihedlen,nx,ny,nz,nbyt,imgnum:',
      !&                              ihedlen,nx,ny,nz,nbyt,imgnum
      !write(3,*)' In lunsetpos_mrc, nbyt_per_rec:', nbyt_per_rec
      !write(3,*)' In lunsetpos_mrc lunmrcpos:',lunmrcpos(lun)
d486 7
a492 1
      IS_MRC = (LUNMRCPOS(LUN) .NE. 0)
d511 1
a511 1
      ! write(6,*) ' In lungetmap_mrc, map c,r,s: ',mapc,mapr,maps
d516 1
a516 1
C     ------------------------- WHICH_HAND_MRC ----------------------------
d579 1
a579 1
      !write(3,*)' In lunsethand_mrc, caxis: ',mrc_header(26),caxis
d603 2
a604 1
      !write(3,*)' In lungethand_mrc, lun,caxis: ',lun,caxis
d688 1
a688 1
      !write(3,*)' In lunsetstk_mrc, iversion: ',mrc_header(23),nstack
d693 1
a693 1
C     ------------------------- LUNSETMODSIZ_MRC ----------------------------
d719 1
a719 1
C     ------------------------- LUNSETMODE_MRC ----------------------------
d738 1
a738 1
      !write(3,*) ' In lunsetmode_mrc: ',mrcmode
d784 1
a784 1
      !write(6,*) ' In lungetmod_mrc: ',mrcmode
d809 1
a809 1
      ! write(6,*) ' In lungetvin_mrc, iversion', iversion
d834 1
a834 1
      !write(3,*) ' In lunsetvin_mrc, iversion', iversion,ispg
a858 1

d970 1
a970 1
      !write(3,*)' In lunset_statsimg_mrc, imgstats: ',imgstats
d998 1
a998 1
C     ------------------------- LUNSETSTATS_MRC ----------------------------
d1039 1
a1039 1
      !write(3,*)' In lunsetstats_mrc, imgnum,stats:',imgnum,imgstats
d1049 1
a1049 1
C     ------------------------- LUNGETSTATS_MRC ----------------------------
d1094 4
a1097 3
      !write(3,*)' In lungetstats_mrc stats:',fmint,fmaxt,avt,sigt
      !write(3,*)' In lungetstats_mrc fmin,fmax,imami:',fmint,fmaxt,imamit
      !write(3,*)' In lungetstats_mrc imgstats,imgnum: ',imgstats,imgnum
d1213 5
a1217 5
c      write(3,*) ' In lunsetpixsiz_mrc, nx...: ',nx,ny,nz
c      write(3,*) ' In lunsetpixsiz_mrc, sizex...: ',
c     &                                   sizex,sizey,sizez
c      write(3,*) ' In lunsetpixsiz_mrc, cellax...: ',
c     &                                   cellax,cellay,cellaz
d1253 5
a1257 5
c      write(3,*) ' In lunsetpixsiz_mrc, nx...: ',nx,ny,nz
c      write(3,*) ' In lunsetpixsiz_mrc, sizex...: ',
c     &                                   sizex,sizey,sizez
c      write(3,*) ' In lunsetpixsiz_mrc, cellax...: ',
c     &                                   cellax,cellay,cellaz
d1269 1
a1269 2

C     ------------------------- LUNSETANGS_MRC ----------------------------
d1299 1
a1299 1
C     ------------------------- LUNGETANGS_MRC ----------------------------
d1329 1
a1329 1
C     ------------------------- LUNGETSIZE_MRC ----------------------------
d1364 1
a1364 1
      !write(3,*) ' In lunsetmrchdr, filnam:',filnam(1:nlet), nz
d1369 1
a1369 1
C     ------------------------- LUNGETVALS_R_MRC ------------------------
d1434 1
a1434 1
C     ------------------------- LUNSETVALS_R_MRC ------------------------
d1485 1
a1485 1
         !write(6,*) ' bufvals: ',jenis(i),bufvals(i-igomrc+1)
d1504 1
a1504 1
C     ------------------------- LUNGETTYPE_MRC ----------------------------
d1525 1
a1525 1
C     ------------------------- LUNGETSTK_MRC----------------------------
d1545 1
a1545 1
C     ------------------------- LUNSETSTK_MRC----------------------------
d1561 1
a1561 1
      ! write(3,*)' In lunsetstk_mrc, nstack: ',nstack
d1566 1
a1566 1
C     ------------------------- LUNGETNSTACK_MRC----------------------------
d1573 1
a1573 1

d1598 2
a1599 2
      !write(3,*)' In lungetnstack, :', iversion,ispg
      !write(3,*)' In lungetnstack, :', nzmrc,mz,nz,nstack
d1604 1
a1604 1
      !write(3,*)' In lungetnstack, nlet,filnam:', nlet,filnam(1:nlet)
d1613 8
d1626 1
a1626 1
         !write(3,*)' In lungetnstack 1, :', nz,nstack
d1633 1
a1633 1
         !write(3,*)' In lungetnstack 2, :', nz,nstack
d1639 1
a1639 1
         !write(3,*)' In lungetnstack 3, :', nz,nstack
d1645 1
a1645 1
         !write(3,*)' In lungetnstack 4, :', nz,nstack
d1651 1
a1651 1
         !write(3,*)' In lungetnstack 5, :', nz,nstack
d1657 1
a1657 1
         !write(3,*)' In lungetnstack 6, :', nz,nstack
d1660 1
a1660 1
      !write(3,*)' In lungetnstack, ispg,nz,nstack:',ispg,nz,nstack
d1664 1
a1664 1
C     ------------------------- LUNSETNSTACK_MRC----------------------------
d1691 2
a1692 2
      !write(3,*)' In lunsetnstack, nlet,filnam:', nlet,filnam(1:nlet)
      !write(3,*)' In lunsetnstack, :', iversion,ispg,nz,nstack
d1848 1
a1848 1
C     ------------------------- LUNGETLABELS_MRC ----------------------------
d1855 2
a1856 2
C     CHARACTER(LEN=800) :: LABELS
      CHARACTER(LEN=*) :: LABELS
d1859 2
d1867 1
a1867 1
      write(3,*) ' nlabl: ',nlabl
d1869 1
a1869 2
      IF (NLABL > 0) THEN
C        GET LABELS
d1871 6
a1876 2
         INOW = 1
         DO I = 57,56 + NLABL * 20      ! 57...57+2*20
d1878 2
a1879 1
      write(3,*) ' nlabl,inow,i: ',nlabl,inow,i,MRC_HEADER(I)
d1881 2
d1884 7
a1890 3
           LABELS(INOW:INOW+3) = TRANSFER(MRC_HEADER(I),CSTR(1:4))
            INOW = INOW + 4
         ENDDO
d1892 1
a1892 5
         CALL LUNGETFLIP(LUN,IFLIP,IRTFLG)
         IF (IFLIP == 1 ) THEN
            IEND = NLABL * 80
            CALL REVERSEBYTES(LABELS,IEND,IRTFLG)
         ENDIF
d1894 1
a1894 11
C        STRIP LEADING BLANKS FROM LABELS (UNTIDY HACK)
         DO ILAB=1,NLABL
            IGO  = (ILAB - 1) * 80 + 1
            IEND = IGO + 80 - 1
            DO I = IGO,IEND
               IF (LABELS(I:I) .NE. ' ') THEN
                   LABELS(IGO:IEND) = LABELS(I:IEND)
                  EXIT
               ENDIF
            ENDDO
         ENDDO
d1896 17
d1915 14
d1985 2
a1986 1
      !write(3,*)' In lunsayinfo,  mz,nstack,imgnum 1:',mz,nstack,imgnum
d1990 2
a1991 1
      !write(3,*)' In lunsayinfo,  mz,nstack,imgnum 2:',mz,nstack,imgnum
d2010 1
a2010 1
      !write(3,*) ' In lungetfile, nlet,filnam:', nlet,filnam(1:nlet)
d2057 3
a2059 1
      !write(3,*) ' In lunsayinfo - imgnum,nstack,mz:',imgnum,nstack,mz
d2074 2
a2075 1
             WRITE(NOUT,*) ' ',FILNAM(:NLET),'     /',LABEL1(:LENLABEL1)
d2087 2
a2088 1
      !write(3,*)' In lunsayinfo - imgnum,nstack,mz:',imgnum,nstack,mz
@


1.14
log
@LOGICAL              :: SAYI  not Integer
@
text
@d10 1
a10 1
C=* Copyright 1985-2020 Health Research Inc.,                          *
d1837 2
a1838 1
      CHARACTER(LEN=800) :: LABELS
d1847 2
d1854 5
a1858 1
            LABELS(INOW:INOW+3) = TRANSFER(MRC_HEADER(I),CSTR(1:4))
@


1.13
log
@added: CALL LUNSETSTATS_MRC
@
text
@a11 1
C=* Email: spider@@health.ny.gov                                        *
d1885 2
a1886 1
      INTEGER              :: LUN,SAYIT,IRTFLG
@


1.12
log
@changes for fmin....
@
text
@d247 1
a247 1
      write(3,*)' In lunwrthed_mrc, header(25): ',mrc_header(25),lun   
d1076 2
a1077 1
         FMAXT  = FMINT - 1
@


1.11
log
@*** empty log message ***
@
text
@d247 1
a259 1
      !write(3,*)' In lunwrthed_mrc - header(13): ',mrc_header(13),lun    
d960 2
d1030 1
a1030 1
      !write(6,*)' In lunsetstats_mrc, imgnum,stats:',imgnum,imgstats
d1042 1
a1042 1
      SUBROUTINE LUNGETSTATS_MRC(LUN,IMAMI,FMINT,FMAXT,AVT,SIGT,IRTFLG)
d1046 1
a1046 1
      INTEGER  :: LUN,IMAMI,IRTFLG
a1060 2
      !write(3,*)' In lungetstats_mrc , stat:',fmint,fmaxt,avt,sigt

d1062 4
a1065 4
      IMAMI = 1
      IF (FMAXT < FMINT) IMAMI = 0
      IF (AVT   < FMINT) IMAMI = 0
      IF (SIGT  < 0.0)   IMAMI = 0
d1068 1
a1068 1
      IF (FMINT == 0.0 .AND. FMAXT == 0.0 .AND. SIGT == 0.0) IMAMI = 0 
a1069 2
      !write(6,*)' In lungetstats_mrc 1:',fmint,fmaxt,avt,sigt,imami

d1073 1
a1073 3
      !write(3,*)' In lungetstats_mrc imgstats:',imgstats,imgnum,nstack

      IF (NSTACK > 1 .AND. IMGNUM > 0 .AND. (IMGSTATS .NE. IMGNUM)) THEN
d1075 2
a1076 2
         IMAMI = 0
         FMAXT = FMINT - 1
d1080 2
a1081 2
         IMAMI = 0
         FMAXT = FMINT - 1
d1084 3
a1086 2
      !write(3,*)' In lungetstats_mrc45, stat:',min,max,av,sig,imami
      !write(6,*)' In lungetstats_mrc 3:',fmint,fmaxt,avt,sigt,imami
d1124 2
a1125 1
         
d1172 1
a1172 1
      PIXSIZ = PIXSIZ / NX 
a1721 2
  
 
d1739 1
a1740 1
C     INCLUDE 'LABLOCK.INC'
d1807 1
a1807 1
C     RETRIEVE VOLUME/IMAGE STATISTICS
d1817 1
a1817 1
C     SET REGISTER VALUES AS NEEDED
@


1.10
log
@typef output now same as spider
@
text
@d108 3
a110 4




d409 3
a411 2
      !write(3,*) ' In lunsetpos_mrc, imgnum,caxis,lunmrcpos(lun): ',
      !&                               imgnum,caxis,lunmrcpos(lun)
@


1.9
log
@TYPEF = 'MRC-' // MODE_STR // ' 3D'
@
text
@d1941 1
a1941 1
          TYPEF = 'MRC-' // MODE_STR // ' S2D'
d1943 1
a1943 1
          TYPEF = 'MRC-' // MODE_STR // ' S3D'
d1945 1
a1945 1
          TYPEF = 'MRC-' // MODE_STR // ' 2D'
d1947 1
a1947 1
          TYPEF = 'MRC-' // MODE_STR // ' 3D'
@


1.8
log
@misc bug fixes especially for stack and vol handling
@
text
@d45 1
d760 19
a1567 2


d1894 1
a1894 1
      INTEGER              :: MAXIM,LENT,NLET,LT,MZ
d1902 1
a1902 1
      CHARACTER(LEN=7)     :: TYPEF
d1905 1
d1913 1
a1913 1
C     RETRIEVE ITYPE  
d1917 15
d1941 1
a1941 1
          TYPEF = 'MRC S2D'
d1943 1
a1943 1
          TYPEF = 'MRC S3D'
d1945 1
a1945 1
          TYPEF = 'MRC 2D'
d1947 1
a1947 1
          TYPEF = 'MRC 3D'
d1958 1
a1958 1

@


1.7
log
@lunsetnstack changes,  file opening axis added to sayinfo
@
text
@d4 1
a4 1
C                   MRC FILE SUPPORT            JUL 2019  ArDean Leith
d10 1
a10 1
C=* Copyright 1985-2019 Health Research Inc.,                          *
d59 1
d61 2
a62 2
C     ------------------------- LUNGETVALS_R_MRC ---------------------
C     ------------------------- LUNSETVALS_R_MRC ---------------------
d136 1
a136 1
C     ----------- LUNNEWHED_MRC -----------------------------------------
d221 1
a221 1
C     ----------- LUNWRTHED_MRC -----------------------------------------
d259 1
a259 1
      !write(6,*)' In lunwrthed_mrc - header(25): ',mrc_header(25),lun    
d323 1
a323 1
         NBYT =  1           ! UNSIGNED BYTE 
d325 1
a325 1
         NBYT =  2           ! SIGNED   INTEGER*2
d327 1
a327 1
         NBYT = -2           ! UNSIGNED INTEGER*2
d419 1
a419 1
C     ------------------------- LUNFLIPORG_MRC ----------------------------
d467 1
a467 1
C     ------------------------- LUNGETIS_MRC ----------------------------
d487 1
a487 1
C     ------------------------- LUNGETMAP_MRC ----------------------------
d549 1
a549 2

C     ------------------------- LUNSETHAND_MRC ----------------------------
d574 1
a574 1
C     ------------------------- LUNGETHAND_MRC ----------------------------
d593 1
d598 1
a598 1
C     ------------------------- LUNSETXXX_MRC ----------------------------
d703 25
a727 1
      !write(6,*) ' In lunsetmodsiz_mrc: ',MRCMODE,nx,ny,nz,mx,my,mz
d732 2
a733 1
C     ------------------------- LUNGETMODSIZ_MRC ----------------------------
d754 1
a754 1
      !write(6,*) ' in lungetmodsiz_mrc: ',mrcmode,nx,ny,nz,mx,my,mz
d784 1
a784 1
C     ------------------------- LUNSETVIN_MRC ----------------------------
d809 1
a809 1
C     ------------------------- LUNGETISBARE_MRC -------------------------
d929 1
a929 1
C     ------------------------- LUNSET_STATSIMG_MRC ----------------------------
d947 1
a947 1
C     ------------------------- LUNGET_STATSIMG_MRC ----------------------------
d1074 1
a1074 1
C     ------------------------- LUNZEROSTATS_MRC ----------------------------
d1114 1
a1114 1
C     ------------------------- LUNGETVERSION_MRC ----------------------------
d1132 1
a1132 1
C     ------------------------- LUNGETPIXSIZ_MRC ----------------------------
d1159 1
a1159 1
C     ------------------------- LUNSETPIXSIZE_MRC ----------------------------
d1171 1
a1171 1
      INTEGER           :: NX,NY,NZ
a1172 1
      REAL              :: FVAL 
d1185 2
d1188 1
a1188 1
c     &                                   cellax,cellax,cellax
d1192 3
a1194 3
      MRC_HEADER(11) = TRANSFER(CELLAX, FVAL)
      MRC_HEADER(12) = TRANSFER(CELLAY, FVAL)
      MRC_HEADER(13) = TRANSFER(CELLAZ, FVAL)
d1199 42
d1484 1
a1484 1
      INTEGER   :: NX,NY,NZ,MZ,NSTACK
d1486 2
a1487 1
      CALL LUNGETNSTACK_MRC(LUN, NX,NY,NZ, MZ,NSTACK,IRTFLG)
d1489 1
a1489 1

d1544 5
a1548 1
C               SO THIS IS COMPLEX!!
d1572 2
a1573 1
      !write(3,*)' In lungetnstack, :', iversion,ispg,nz,nstack
d1592 1
d1599 1
d1601 1
a1601 1
      ELSEIF (ISPG == 0 .AND. MZ > 1 ) THEN
d1605 1
d1611 1
d1617 1
d1623 1
d1884 1
a1884 1
      CHARACTER(LEN=6)     :: TYPEF
d1894 1
a1894 1
C     RETRIEVE ITYPE (WORKS FOR MRC ALSO)
d1907 1
a1907 1
          TYPEF = 'MRC S2'
d1909 1
a1909 1
          TYPEF = 'MRC S3'
d1911 1
a1911 1
          TYPEF = 'MRC 2'
d1913 1
a1913 1
          TYPEF = 'MRC 3'
@


1.6
log
@nstack definition altered
@
text
@d418 48
d651 2
a652 2
C     MACHST = 4369         ! FOR LITTLE ENDIAN DATA
      MACHST = 16708        ! FOR LITTLE ENDIAN DATA
d1535 1
a1535 1
C        STACK OF IMAGES  SOMETIMES
d1537 1
a1537 1
         NSTACK = MZ
d1545 1
a1545 1
      !write(3,*)' In lungetnstack, nz,nstack:', nz,nstack
d1625 2
d1819 1
a1819 1
      !write(6,*)' In lunsayinfo,  mz,nstack,imgnum:',mz,nstack,imgnum
d1823 1
d1924 1
a1924 1
     &                ' HEADER BYTES: ',I0,'  (',A,')')
d1933 1
a1933 1
     &                ' HEADER BYTES: ',I0,'  (',A,')')
d1942 1
a1942 1
     &                ' HEADER BYTES: ',I0,'  (',A,')')
d1951 1
a1951 1
     &                ' HEADER BYTES: ',I0,'  (',A,')')
d1957 1
a1957 1
               WRITE(NOUT,930)TYPEF(:LT),NX,NY,NZ,  DTP,HEDBYT,CAXIS
d1959 1
a1959 1
     &                ' HEADER BYTES: ',I0,'  (',A,')')
d1965 1
a1965 1
               WRITE(NOUT,940)TYPEF(:LT),NX,NY,    DTP,HEDBYT,CAXIS(:2)
d1967 1
a1967 1
     &                ' HEADER BYTES: ',I0,'  (',A,')')
@


1.5
log
@bad jenis values fixed
@
text
@d1447 1
a1447 1
      MZ       = MRC_HEADER(10)  ! CAN BE NSTACK 
d1457 2
a1458 2
      IF (INDEX(FILNAM(1:NLET),'mrcs') > 0 .OR.
     &    INDEX(FILNAM(1:NLET),'MRCS') > 0) THEN
d1464 6
d1487 1
a1487 1
C        STACK OF IMAGES  (?)
d1537 1
d1549 1
d1555 1
d1840 1
a1840 1
C         PRINT STACK OPENING INFORMATION
d1865 1
d1867 1
a1867 1
         IF (NSTACK .NE. 0 .AND. IMGNUM == 0 .AND. NZ > 1) THEN
d1876 2
a1877 2
         ELSEIF (NSTACK .NE. 0 .AND. IMGNUM <= 0) THEN
C           OVERALL STACKED IMAGE 
@


1.4
log
@MRC STACK BUT NO IMAGE SPECIFIED
MRC STACK BUT NO IMAGE SPECIFIED
@
text
@d1241 1
a1241 1
      INTEGER           :: JENIS(56)
d1247 1
a1247 1
     &            1, 1, 1,  2, 2, 2,  2,  2, 2, 2,  2, 2, 
d1338 1
a1338 1
C     SET HEADER VALUES WRITEN AS I*4
@


1.3
log
@LUNSETHAND_MRC uses which_hand
@
text
@d965 1
a965 1
      !write(6,*)' In lungetstats_mrc 0, stat:',fmint,fmaxt,avt,sigt
a979 1
      !write(6,*)' In lungetstats_mrc 2 imgstats:',imgstats,imgnum,nstack
d981 3
a983 2
      IF (NSTACK >  1 .AND. IMGNUM > 0 .AND. 
     &   (IMGSTATS .NE. IMGNUM)) THEN
d987 5
d993 1
d1829 1
d1866 1
a1866 1
         ELSEIF (NSTACK .NE. 0 .AND. IMGNUM == 0) THEN
@


1.2
log
@lunsethand check
@
text
@d457 44
d503 1
a503 1
      SUBROUTINE LUNSETHAND_MRC(LUN,CORIG,CHANDED,IRTFLG)
d511 1
a511 2
      CHARACTER(LEN=2)   :: CORIG
      CHARACTER(LEN=1)   :: CHANDED
a512 2
      CHARACTER(LEN=1)   :: BLANK = CHAR(32)
      CHARACTER(LEN=4)   :: CAXIS
a518 3
      CAXIS(1:2)     = CORIG
      CAXIS(3:3)     = BLANK
      CAXIS(4:4)     = CHANDED
d934 1
a934 1
      write(6,*)' In lunsetstats_mrc, imgnum,stats:',imgnum,imgstats
@


1.1
log
@mrc_support
@
text
@d483 1
a483 1
      !write(3,*)' In lunsethand_mrc, iversion: ',mrc_header(26),CAXIS
@

head	1.20;
access;
symbols
	pre_mrcs:1.19
	healthdept_2018:1.19;
locks; strict;
comment	@c @;


1.20
date	2025.11.10.22.32.37;	author dean;	state Exp;
branches;
next	1.19;

1.19
date	2018.10.03.14.34.06;	author leith;	state Exp;
branches;
next	1.18;

1.18
date	2018.02.22.16.18.09;	author leith;	state Exp;
branches;
next	1.17;

1.17
date	2018.01.31.20.34.11;	author leith;	state Exp;
branches;
next	1.16;

1.16
date	2018.01.30.20.50.45;	author leith;	state Exp;
branches;
next	1.15;

1.15
date	2018.01.23.16.48.08;	author leith;	state Exp;
branches;
next	1.14;

1.14
date	2018.01.22.17.55.52;	author leith;	state Exp;
branches;
next	1.13;

1.13
date	2017.05.26.16.44.25;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2016.11.15.15.26.50;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2015.06.05.15.44.27;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2014.12.12.16.37.37;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2014.12.12.16.08.08;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2014.12.03.15.33.50;	author leith;	state Exp;
branches;
next	1.7;

1.7
date	2014.12.02.18.24.36;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2014.11.25.14.33.44;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2014.11.25.14.11.40;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2014.11.18.19.49.14;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2014.11.18.19.41.13;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2014.11.18.19.41.00;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2014.11.18.18.50.35;	author leith;	state Exp;
branches;
next	;


desc
@@


1.20
log
@*** empty log message ***
@
text
@C++*********************************************************************
C
C  FOUR_FQ.F
C             OPFILEC                              FEB 03 ARDEAN LEITH    
C             COS                                  JUL 12 G. KISHCHENKO    
C             FQ Q PARAMS                          OCT 12 ARDEAN LEITH    
C             RAISED SINC                          OCT 13 ARDEAN LEITH    
C             CREATED FROM FOUR1A                  NOV 14 ARDEAN LEITH    
C             VOLUME IOPT 12 & 13 TRAP for ifort   JUN 15 ARDEAN LEITH    
C             VOLUME FILTER BUG                    MAY 17 ARDEAN LEITH    
C             SIMPLIFIED                           JAN 18 ARDEAN LEITH    
C             SQRT2M1 in BUTTERWORTH               JAN 18 ARDEAN LEITH
C             HIDDEN PLOT OPTION                   JAN 18 ARDEAN LEITH
C       
C **********************************************************************
C=*                                                                    *
C=* This file is part of:   SPIDER - Modular Image Processing System.  *
C=* SPIDER System Authors:  Joachim Frank & ArDean Leith               *
C=* Copyright 1985-2018  Health Research Inc.,                         *
C=* Riverview Center, 150 Broadway, Suite 560, Menands, NY 12204.      *
C=* Email: spider@@wadsworth.org                                        *
C=*                                                                    *
C=* SPIDER is free software; you can redistribute it and/or            *
C=* modify it under the terms of the GNU General Public License as     *
C=* published by the Free Software Foundation; either version 2 of the *
C=* License, or (at your option) any later version.                    *
C=*                                                                    *
C=* SPIDER is distributed in the hope that it will be useful,          *
C=* but WITHOUT ANY WARRANTY; without even the implied warranty of     *
C=* merchantability or fitness for a particular purpose.  See the GNU  *
C=* General Public License for more details.                           *
C=* You should have received a copy of the GNU General Public License  *
C=* along with this program. If not, see <http://www.gnu.org/licenses> *
C=*                                                                    *
C **********************************************************************
C
C FOUR_FQ 
c
C PURPOSE: APPLIES FOURIER FILTERS TO 2-D OR 3-D REAL PICTURES
C            'FQ'    : QUICK FILTERING (IN CORE, 2-D OR 3-D)
C            'FQ NP' : QUICK FILTERING (IN CORE, 2-D OR 3-D) NO PAD
C
C NOTE:  BUTTERWORTH FILTERS APPEAR TO BE OFFSET FROM MY EXPECTED
C        CENTRAL LINE BETWEEN PASS BAND AND STOP BAND BUT THIS GOES
C        WAY BACK BEFOR SPIDER 17.0 AND MAYBE FOREVER.  FIXED IN
C        JAN 2018
C
C NOTE:  APPEARS TO HAVE UNDOCUMENTED AND UNTESTED ELLIPTICAL 
C        FILTRATION FOR OPTIONS: 1,2,3,4.   THIS WILL GIVE BAD 
C        ERRORS IF USER ENTERS MORE THAN ONE VALUE ON THE INPUT
C        PARAMETER LINE AS IT IS USED FOR ELLIPSES. al nov 2014
C
C        SUBSTITUTION OF PRECALCULATED INTERMEDIATE VARIABLES NOT
C        USEFULL FOR SPEED SINCE TIME IS DOMINATED BY FFT. SEE RCS
C        VERSIONS FOR TESTING THIS
C
C        'FF' (ffilts.f)     SETS XD2SQ TO: (NX  / 2)**2 BUT
C        'FQ' (four_fq.f)    SETS XD2SQ TO: (NXF / 2)**2 WHERE
C             NX  IS X DIMENSION OF POSSIBLY PADDED IMAGE
C             NXF IS SLIGHTLY LARGER DUE TO MIXED RADIX FOURIER PAD
C        SO THEY GIVE SLIGHTLY DIFFERENT RESULTS.  I SUSPECT THAT
C        'FF' IS ACTUALLY CORRECT?
C
C NOTE:  PADDING OPTIONS (OTHER THAN NO_PAD) HAVE NO VISABLE EFFECT
C        WITH MOST INPUTS al
C 
C23456789012345678901234567890123456789012345678901234567890123456789012
C--*********************************************************************

        SUBROUTINE FOUR_FQ

        IMPLICIT NONE
        INCLUDE 'CMBLOCK.INC' 
        INCLUDE 'CMLIMIT.INC'

        CHARACTER (LEN=MAXNAM) :: FILNAM

        REAL, ALLOCATABLE      :: BB(:,:,:)
       
        INTEGER                :: N2X,N2Y,N2Z,LSD
        INTEGER                :: NX,NY,NZ
        INTEGER                :: MAXIM,IOPT,IRTFLG,NOT_USED
        INTEGER                :: IDUM,NE,IPADTYPE
        INTEGER                :: NMAX,NGOT,INV,I,J,K,IRECT
        REAL                   :: ORD,FP,FS,PARM1T,PARM2T,AVET
        REAL                   :: PARM1,PARM2,PARM3,PADVAL
        REAL                   :: BFPS(4)
        INTEGER                :: IWANTETC,NLETF,ITYPE
        LOGICAL                :: WANTFOU,WANTPLOT,WANTMAGS
        CHARACTER (LEN=1)      :: NULL = CHAR(0)

        REAL, PARAMETER        :: EPS = 0.882
        REAL, PARAMETER        :: AA  = 10.624

        INTEGER, PARAMETER     :: LUN1 = 21
        INTEGER, PARAMETER     :: LUN2 = 22

C       OPEN REAL OR FOURIER SPACE INPUT FILE
        MAXIM = 0
        CALL OPFILEC(0,.TRUE.,FILNAM,LUN1,'O',IFORM,NX,NY,NZ,
     &             MAXIM,'INPUT',.TRUE.,IRTFLG)
        IF (IRTFLG .NE. 0) RETURN
        AVET = AV      ! FROM CMBLOCK

        IF (IFORM .NE. 1 .AND. IFORM .NE. 3) THEN
           WRITE(NOUT,*) '  OPERATION PROCESSING FOURIER INPUT'
           CALL ERRT(101,'OPERATION DOES NOT ACCEPT FOURIER INPUT',IDUM)
           GOTO 999

        ELSEIF (IFORM == 1 .AND. NY == 1) THEN
           CALL ERRT(101,'OPERATION DOES NOT WORK ON 1D INPUT',IDUM)
           GOTO 999
        ENDIF
        
        CALL FILERD(FILNAM,NLETF,NULL,'OUTPUT',IRTFLG)
        IF (IRTFLG. NE. 0) GOTO 999
 
 1000   WRITE(NOUT,90)
 90     FORMAT
     &  ('  1 - LOW-PASS,                2 - HIGH-PASS'         ,/,
     &   '  3 - GAUSS.  LOW-PASS,        4 - GAUSS.  HIGH-PASS' ,/,
     &   '  5 - FERMI   LOW-PASS         6 - FERMI   HIGH-PASS' ,/,
     &   '  7 - BUTTER. LOW-PASS,        8 - BUTTER. HIGH-PASS' ,/,
     &   '  9 - RAISED COS. LOW-PASS,   10 - RAISED COS. HIGH-PASS' ,/,
     &   ' 13 - RAISED SINC WINDOW,     14 - B FACTOR')

        IWANTETC = 0    ! HIDDEN FOURIER OUTPUT OPTION

C       HIDDEN PAD TYPE OPTION, DEFAULT IS TYPE 2
        IPADTYPE = 2    ! PAD WITH BORDER AVERAGE (LEGACY PAD TYPE)
        IF ( INDEX(FCHAR,'NP') > 0)  THEN
C          NO PADDING
           IPADTYPE = 0    ! NO PADDING
        ENDIF

        CALL RDPRI3S(IOPT,IWANTETC,IPADTYPE,NOT_USED,
     &               'FILTER TYPE (1-10,13,14)',IRTFLG)
        IF (IRTFLG. NE. 0) GOTO 999
        
        IF (IOPT < 1 .OR. IOPT > 14) THEN
           CALL ERRT(102,'ILLEGAL VALUE FOR FILTER TYPE',IOPT)
           GOTO 1000
        ELSEIF (NZ > 1 .AND. IOPT == 13 ) THEN
           CALL ERRT(101,'OPTION NOT IMPLEMENTED FOR VOLUMES',IOPT)
           GOTO 1000
        ENDIF
         
        WANTFOU  = (IWANTETC == 1)  ! FOURIER OUTPUT ONLY
        WANTPLOT = (IWANTETC == 2)  ! TRANSFER PLOT TO TERMINAL 
        WANTMAGS = (IWANTETC == 3)  ! UNIMPLEMENTED

C       IPADTYPE: 0 == NONE,  1== ZEROPAD, 2==BORDERPAD, 3==AVG PAD
        IF ( IPADTYPE == 1) THEN
           WRITE(NOUT,*) ' Padded with zeroes'
        ELSEIF ( IPADTYPE == 2) THEN
           WRITE(NOUT,*) ' Padded with image/volume border average'
        ELSEIF ( IPADTYPE == 3) THEN
           WRITE(NOUT,*) ' Padded with image/volume average'
        ELSEIF (IPADTYPE < 0 .OR. IPADTYPE > 3 ) THEN
           CALL ERRT(102,'ILLEGAL VALUE FOR PAD TYPE',IPADTYPE)
           GOTO 1000
        ENDIF

        PARM2 = 0.0
        PARM3 = 0.0
        BFPS  = 0.0    ! ARRAY OP

        IF (IOPT == 5 .OR. IOPT == 6)  THEN
C          FERMI DISTRIBUTION FILTER ****************************

           PARM1 = 0.25
           CALL RDPRM1S(PARM1,NOT_USED,
     &        'FILTER RADIUS (IN FREQUENCY OR PIXEL UNITS)',IRTFLG)
           IF (IRTFLG .NE. 0) RETURN

           IF (PARM1 < 0.0 .OR. PARM1 > 1.0) 
     &         PARM1 = PARM1 / NX     ! RADIUS INPUT

           CALL RDPRM1S(PARM3,NOT_USED,
     &                     'TEMPERATURE (0=CUTOFF)',IRTFLG)

C          EXPONENTIAL FOR HIGH-PASS OPTION
           IF (IOPT == 6) PARM3 = -PARM3
 
        ELSEIF (IOPT == 7  .OR. IOPT == 8) THEN
C          BUTTERWORTH  FILTER ********************************

           NMAX = 4
           CALL RDPRA(
     &        'LOWER & UPPER LIMITING FREQ. (IN FREQ OR PIXEL UNITS)',
     &        NMAX,0,.FALSE.,BFPS,NGOT,IRTFLG)
           IF (IRTFLG .NE. 0) RETURN

           IF (BFPS(1) > 1.0) THEN
C             RADIUS INPUT
              PARM1 = BFPS(1) / NX
              PARM2 = BFPS(2) / NX
           ELSE
C             FREQUENCY INPUT
              PARM1 = BFPS(1)
              PARM2 = BFPS(2)
           ENDIF

           IF (BFPS(3) == 0.0 .AND. BFPS(4) == 0.0) THEN
C             BUTTERWORTH CIRCULAR FILTER

              ORD   = 2.0 * ALOG10(EPS / SQRT(AA**2 - 1.0) )

              ORD   = ORD   / ALOG10(PARM1 / PARM2)
              PARM1 = PARM1 / EPS**(2. / ORD)

              PARM3 = ORD

              WRITE(NOUT,*)
     &         ' BUTTERWORTH CIRCULAR FILTER, ORD: ',ORD

           ELSE
C             BUTTERWORTH ELLIPTIC FILTER
C             LOW-PASS  IOPT=11,  HIGH-PASS IOPT=12

              IOPT = IOPT + 4
              IF (NZ > 1 ) THEN
                 CALL ERRT(101,
     &              'OPTION NOT IMPLEMENTED FOR VOLUMES',IOPT)
                 GOTO 1000
              ENDIF

              ORD   = 2.0 * ALOG10(EPS / SQRT(AA**2 - 1.0) )
              WRITE(NOUT,*)
     &         ' BUTTERWORTH ELIPTICAL FILTER, ORD: ',ORD
           ENDIF

        ELSEIF ( IOPT == 9  .OR. IOPT == 10)  THEN
C          RAISED COSINE FILTER ********************************

           PARM1 = 0.25
           PARM2 = -9999999
           CALL RDPRM2S(PARM1,PARM2,NOT_USED,
     &       'LOWER & UPPER LIMITING FREQ. (IN FREQ OR PIXEL UNITS)',
     &        IRTFLG)
           IF (IRTFLG .NE. 0) RETURN

           IF (PARM1 < 0.0 .OR. PARM1 > 1.0) 
     &         PARM1 = PARM1 / NX     ! RADIUS INPUT

           IF (PARM2 == -9999999) THEN
              ! SAME AS PARM1
              PARM2 = PARM1

           ELSEIF  (PARM2 < 0.0 .OR. PARM2 > 1.0) THEN
              ! RADIUS INPUT
              PARM2 = PARM2 / NY   
           ENDIF

        ELSEIF (IOPT == 14)  THEN
C          B FACTOR FILTER  ************************************

           WRITE(NOUT,*)
     &         ' NORMALIZES AMPLITUDES BY A "B" TEMPERATURE FACTOR'
           WRITE(NOUT,*)' AMP = AMP*D*(EXP(B*F**2))'

           PARM1 = -200
           CALL RDPRM1S(PARM1, NOT_USED,'B FACTOR (PIXEL**2)',   IRTFLG)
           IF (IRTFLG .NE. 0) RETURN

           PARM2 = 1.0
           CALL RDPRM1S(PARM2, NOT_USED,'D MULTIPLIER', IRTFLG)
           IF (IRTFLG .NE. 0) RETURN

           CALL RDPRM1S(PARM3, NOT_USED,'FREQUENCY CUTOFF',  IRTFLG)
           IF (IRTFLG .NE. 0) RETURN
           IF (PARM3 < 0.0 .OR. PARM3 > 0.5) THEN
              WRITE(NOUT,'(A)') '  Allowed Cutoff Range: 0 .. 0.5'
           ENDIF

           PARM3 = PARM3**2
         

        ELSE
C          ALL OTHER FILTERS *************************************
C          LOW-PASS,  HIGH-PASS,  GAUSS.LOW-PASS,  GAUSS.HIGH-PASS
C          RAISED SINC WINDOW 

           PARM1T = 0.25
           PARM2T = -9999999
           CALL RDPRM2S(PARM1T,PARM2T,NOT_USED,
     &        'FILTER RADIUS (IN FREQUENCY OR PIXEL UNITS)',IRTFLG)
           IF (IRTFLG .NE. 0) RETURN

           PARM1 = PARM1T
           IF (PARM1T < 0.0 .OR. PARM1T > 1.0) THEN
              PARM1 = PARM1 / NX     ! RADIUS INPUT
              WRITE(NOUT,'(A,F8.4)') '  Frequency: ',PARM1
           ENDIF

           IF (PARM2T == -9999999) THEN
              ! DEFAULTS PARM2 SAME AS PARM1
              PARM2 = PARM1

           ELSEIF  (PARM2T < 0.0 .OR. PARM2T > 1.0) THEN
C             RADIUS INPUT FOR PARM2
              PARM2 = PARM2T / NY   
           ENDIF

        ENDIF

        IF ( INDEX(FCHAR,'NP') > 0)  THEN
C          NO PADDING
           IPADTYPE = 0    ! NO PADDING
           N2X      = NX
           N2Y      = NY
           N2Z      = NZ

        ELSE
C          2x PADDING
           N2X = 2 * NX
           IF (NY > 1)  THEN
              N2Y = 2 * NY
           ELSE
              N2Y = 1
           ENDIF
           IF (NZ > 1)  THEN
              N2Z = 2 * NZ
           ELSE
              N2Z = 1
           ENDIF
        ENDIF

        LSD = N2X + 2 - MOD(N2X,2)
         
        ALLOCATE (BB(LSD,N2Y,N2Z), STAT=IRTFLG)           
        IF (IRTFLG .NE. 0) THEN 
           CALL ERRT(46,'FOUR_FQ; BB',LSD*N2Y*N2Z)
           GOTO 999
        ENDIF

        IF (IPADTYPE == 0) THEN

C          NO PADDING AT ALL, EXCEPT FOR FFT PAD NEEDED IN BUFFER
           PADVAL = 0

C          LOAD IMAGE/VOLUME INTO FFT PADDED BUFFER
           CALL REDNPADVOL(LUN1,PADVAL, 
     &                  NX, NY, NZ, LSD,N2Y,N2Z,
     &                  BB,IRTFLG)
           IF (IRTFLG .NE. 0) GOTO 999 

        ELSEIF (IPADTYPE == 1) THEN
C          USE ZERO AS PADDING VALUE
           PADVAL = 0.0

C          LOAD IMAGE/VOLUME INTO FFT PADDED BUFFER
           CALL REDNPADVOL(LUN1,PADVAL, 
     &                  NX, NY, NZ, LSD,N2Y,N2Z,
     &                  BB,IRTFLG)
           IF (IRTFLG .NE. 0) GOTO 999 

        ELSEIF (IPADTYPE == 3) THEN
C          USE AVE FROM IMAGE AS PADDING VALUE
           PADVAL = AVET

C          LOAD IMAGE/VOLUME INTO FFT PADDED BUFFER
           CALL REDNPADVOL(LUN1,PADVAL, 
     &                  NX, NY, NZ, LSD,N2Y,N2Z,
     &                  BB,IRTFLG)
           IF (IRTFLG .NE. 0) GOTO 999 
 
        ELSEIF (IPADTYPE == 2) THEN
C          USE AVERAGE OF BORDER VALUES AS PADDING VALUE

C          LOAD IMAGE/VOLUME INTO FFT PADDED BUFFER
           CALL READV(LUN1,BB, LSD,N2Y, NX,NY,NZ)

C          DETERMINE PADDING VALUE & PAD IMAGE/VOLUME
           IF (IFORM == 1) THEN
              PADVAL = 
     &          (SUM(BB(1:NX,1,1))   + SUM(BB(1:NX,NY,1)) +
     &           SUM(BB(1,2:NY-1,1)) + SUM(BB(NX,2:NY-1,1)) ) / 
     &           REAL(2*(NX+NY)-4)

C             PAD IMAGE
c$omp         parallel do private(j)
	      DO J=1,N2Y
	         BB(NX+1:N2X,J,1) = PADVAL
	      ENDDO

c$omp         parallel do private(j)
	      DO J=NY+1,N2Y
	         BB(1:NX,J,1) = PADVAL
	      ENDDO

           ELSE
              PADVAL =
     &          (SUM(BB(1:NX,1:NY,1))     + SUM(BB(1:NX,1:NY,NZ))   +
     &           SUM(BB(1:NX,1,2:NZ-1))   + SUM(BB(1:NX,NY,2:NZ-1)) +
     &           SUM(BB(1,2:NY-1,2:NZ-1)) + SUM(BB(NX,2:NY-1,2:NZ-1)))
     &         / REAL( 4 * (NX+NY+NZ) - 16)

C             PAD VOLUME
c$omp         parallel do private(k)
	      DO K = 1,NZ
 	         BB(NX+1:N2X, 1:NY,     K) = PADVAL
 	         BB(1:N2X,    NY+1:N2Y, K) = PADVAL
              ENDDO

c$omp         parallel do private(k)
	      DO K=NZ+1,N2Z
	         BB(1:N2X, 1:N2Y, K) = PADVAL
	      ENDDO
	   ENDIF

        ENDIF

        WRITE(NOUT,*) '  Pad value:',padval

C       FORWARD FFT, FFT PADDED
        INV = 1
        CALL FMRS(BB,N2X,N2Y,N2Z, 0.0D0, .TRUE.,.TRUE.,INV,IRTFLG)
        IF (INV == 0) THEN
           IRTFLG = 1
           GOTO 999
        ENDIF

        IF (IFORM == 1)  THEN
C          IMAGE
           WRITE(NOUT,"(A,I0,A,I0)")
     &                '  Dimensions used: ',N2X,' x ',N2Y

           CALL FQ2(IOPT, PARM1,PARM2,PARM3,BFPS, BB, 
     &              LSD,N2X,N2Y, NX,NY, IWANTETC,IRTFLG)
        ELSE
C          VOLUME
           WRITE(NOUT,"(A,I0,A,I0,A,I0)") 
     &           '  Dimensions used: ',N2X,' x ',N2Y,' x ',N2Z

           CALL FQ3(IOPT, PARM1,PARM2,PARM3,BFPS, BB, 
     &              LSD,N2X,N2Y,N2Z, NX,NY,NZ, IWANTETC,IRTFLG)
        ENDIF

C       OPEN OUTPUT FILE
        MAXIM = 0
        ITYPE = IFORM

        IF (WANTFOU) THEN
           IF (IFORM == 1)  THEN
C             NON-FOURIER IMAGE
              ITYPE = -11
              IF (MOD(NX,2) == 0)   ITYPE = -12
           ELSEIF (IFORM == 3)  THEN
C             NON-FOURIER VOLUME
              ITYPE = -21
              IF (MOD(NX,2) == 0)  ITYPE = -22
           ENDIF

           CALL OPFILEC(LUN1,.FALSE.,FILNAM,LUN2,'U',ITYPE,N2X,N2Y,N2Z,
     &                  MAXIM,' ',.TRUE.,IRTFLG)
           IF (IRTFLG. NE. 0) GOTO 999

C          STORE FILTERED FFT AND EXIT WITHOUT FURTHER OUTPUT
           CALL WRTVOL(LUN2,N2X,N2Y,1,N2Z,BB,IRTFLG) 
           GOTO 999

        ENDIF

C       OPEN REAL SPACE FILTERED OUTPUT FILE
        CALL OPFILEC(LUN1,.FALSE.,FILNAM,LUN2,'U',ITYPE,NX,NY,NZ,
     &               MAXIM,' ',.FALSE.,IRTFLG)
        IF (IRTFLG. NE. 0) GOTO 999


C       INVERSE FFT,  POSSIBLY PADDED
        INV = -1         ! INVERSE FFT
        CALL FMRS(BB, N2X,N2Y,N2Z, 0.0D0, .TRUE.,.TRUE.,INV,IRTFLG)
        IF (INV == 0) THEN
           CALL ERRT(101,'USING FFTW',NE)
           GOTO 999 
        ENDIF

        !write(6,*) ' sum3:',sum(bb(1:nx, 1:ny, 1))

C       STORE FILTERED IMAGE, CAN NOT USE: WRTVOL
        IRECT = 1
        DO K=1,NZ
           DO J=1,NY
 	      CALL WRTLIN(LUN2,BB(1,J,K),NX,IRECT)
              IRECT = IRECT + 1
           ENDDO
	ENDDO

999     IF (ALLOCATED(BB)) DEALLOCATE(BB)

        CLOSE(LUN1)
        CLOSE(LUN2)
       
        END



C++*********************************************************************
C
C FQ2.F                                         12/22/94  
C                RDPRAF REMOVED                 DEC 2005 ARDEAN LEITH 
C                COSINE FILTER                  JUL 2012 G. KISHCHENKO 
C                INCORE WITHOUT LUNS            OCT 2012 ARDEAN LEITH 
C                FREQ + PIXELS                  NOV 2012 G. KISHCHENKO 
C                PARM2 BUG                      DEC 2012 ARDEAN LEITH 
C                FREQ UNIT CUTOFF = 1           AUG 2013 ARDEAN LEITH 
C                RAISED SINC                    FEB 2014 ARDEAN LEITH 
C                FROM FQ_Q                      NOV 2014 ARDEAN LEITH 
C        
C **********************************************************************
C=*                                                                    *
C=* This file is part of:   SPIDER - Modular Image Processing System.  *
C=* SPIDER System Authors:  Joachim Frank & ArDean Leith               *
C=* Copyright 1985-2018, Health Research Inc.,                         *
C=* Riverview Center, 150 Broadway, Suite 560, Menands, NY 12204.      *
C=* Email: spider@@wadsworth.org                                        *
C=*                                                                    *
C=* SPIDER is free software; you can redistribute it and/or            *
C=* modify it under the terms of the GNU General Public License as     *
C=* published by the Free Software Foundation; either version 2 of the *
C=* License, or (at your option) any later version.                    *
C=*                                                                    *
C=* SPIDER is distributed in the hope that it will be useful,          *
C=* but WITHOUT ANY WARRANTY; without even the implied warranty of     *
C=* merchantability or fitness for a particular purpose.  See the GNU  *
C=* General Public License for more details.                           *
C=* You should have received a copy of the GNU General Public License  *
C=* along with this program. If not, see <http://www.gnu.org/licenses> *
C=*                                                                    *
C **********************************************************************
C
C FQ2(IOPT,PARM1,PARM2,PARM3,BFPS,B, LSD,N2X,N2Y, NX,NY, 
C     IWANTETC,IRTFLG)
C
C PURPOSE: QUICK FILTERING OF REAL-SPACE IMAGE FILE BY FFT
C
C PARAMETERS:
C        IOPT          TYPE OF FILTER
C        PARM1..       FILTER PARAMETERS
C        BFPS          FILTER PARAMETERS
C        B             BUFFER 
C        LSD           X DIMENSION OF FOURIER FILE
C        NX,NY         DIMENSIONS OF REAL-SPACE FILE
C        N2X,N2Y       DIMENSIONS OF PADDED FILE
C        IWANTETC      OPTIONAL OUTPUTS
C        IRTFLG        ERROR FLAG
C
C23456789012345678901234567890123456789012345678901234567890123456789012  
C--*******************************************************************

        SUBROUTINE FQ2(IOPT, PARM1,PARM2,PARM3,BFPS, 
     &                  B, LSD,N2X,N2Y, NX,NY, IWANTETC,IRTFLG)
        
        IMPLICIT NONE
        INCLUDE 'CMBLOCK.INC'

        INTEGER            :: IOPT      
        REAL               :: PARM1,PARM2,PARM3
        REAL               :: BFPS(4)
        REAL               :: B(LSD,N2Y)
        INTEGER            :: LSD,N2X,N2Y
        INTEGER            :: NX,NY,IWANTETC,IRTFLG

        REAL               :: ZEROTERM
        REAL               :: ORD,PARM1SQ,PARM2SQ,SQRT2M1

        REAL               :: TR,TRA
        REAL               :: XD2SQ,YD2SQ,FSQDP,FSQ,FSQD4
        REAL               :: F,F2,FPE,FSE,ORDT,PARMT,EXPCORR,FN
        INTEGER            :: J,I,IX,IY, NR2, N
          
        REAL, PARAMETER    :: PI  = 3.14159265358979323846
        REAL, PARAMETER    :: EPS = 0.882

        REAL               :: TRPLOT_TR(LSD),TRPLOT_F(LSD)

        integer            :: IT
        real               :: xd2sqdp1sqinv,xd2sqdp1sq

        XD2SQ   = FLOAT(N2X/2)**2

        NR2     = N2Y / 2
        YD2SQ   = FLOAT(NR2)**2

        ORD     = PARM3       ! FOR BUTTERWORTH FILTER
        PARM1SQ = PARM1**2
        PARM2SQ = PARM2**2

        SQRT2M1 = (SQRT(2.0)-1)

C       KEEP ZERO TERM FOR HIGH PASS OPTIONS
        ZEROTERM = B(1,1)
            
        !xd2sqdp1sq    =   xd2sq/parm1sq
        !xd2sqdp1sqinv = 1/xd2sq/parm1sq
                    
        !write(6,*) ' exp(-.697):      ',        exp(-0.697)
        !write(6,*) ' sqrt(0.03105):   ',        sqrt(0.03105)

        !write(6,*) ' p1,p2,p3:        ',        parm1,parm2,parm3
        !write(6,*) ' p1sq,p2sq:       ',        parm1sq,parm2sq
        !write(6,*) ' nx,xd2sq,n2x:    ',        nx,xd2sq,n2x
        !write(6,*) ' xd2sqdp1sqinv,zeroterm: ', xd2sqdp1sqinv,zeroterm
        !write(6,*) ' '

        !write(6,*)
!     &     '  i   j  it  ix   iy    f     fsq   fsqdp   tr'


c$omp  parallel do private(j,i,iy,ix,it,f,f2,fpe,fse,ordt,parmt,
c$omp&                     fsq,fsqdp,fsqd4,expcorr,tr)
        DO J=1,N2Y

           IY = (J-1)
           IF (IY > NR2) IY = IY - N2Y


           DO I=1,LSD,2

              IX    = (I-1) / 2

              FSQ   = (FLOAT(IX*IX)/XD2SQ +
     &                 FLOAT(IY*IY)/YD2SQ)

              FSQDP = (FLOAT(IX*IX)/XD2SQ/PARM1SQ +
     &                 FLOAT(IY*IY)/YD2SQ/PARM2SQ)

              F     = SQRT(FSQ) / 2.0

              IF (IWANTETC == 2  .AND. J == 1) THEN
                IT           = (I -1)/2 + 1   ! 1,1,2
                TRPLOT_F(IT) = F
 !              write(6,'(A,5i5,2f7.2)') ' ij,it,ixy,f,fsq:',
 !    &                                   i,j,it,ix,iy,f,fsq,
              ENDIF


              IF (IOPT == 1) THEN
C                LOWPASS *************************************

                 TR = 1.0

                 IF (0.25 * FSQDP > 1.0) THEN

                    TR        = 0.0
                    B(I,  J)  = TR
                    B(I+1,J)  = TR
                 ENDIF

              ELSEIF (IOPT == 2) THEN   
C                HIGH PASS ***********************************

                 TR = 1.0

                 IF ((IX.NE.0 .OR. IY.NE.0) .AND. 
     &               (0.25*FSQDP) <= 1.0) THEN

                    TR       = 0.0
                    B(I,  J) = TR
                    B(I+1,J) = TR
                  ENDIF

              ELSEIF(IOPT == 3)  THEN
C                GAUSSIAN LOW PASS ***************************

                 TRA = 0.125 * FSQDP
                 TR  = 0.0

                 IF (TRA < 16.0)  THEN
                    TR       = EXP(-TRA)
                    B(I,  J) = B(I,  J) * TR
                    B(I+1,J) = B(I+1,J) * TR
                 ELSE
                    B(I,  J) = TR
                    B(I+1,J) = TR
                 ENDIF
           !write(6,'(5i4,6f7.2)')i,j,it,ix,iy,f,fsq,fsqdp,tempr2

              ELSEIF (IOPT==4)  THEN    
C                GAUSSIAN HIGH PASS **************************

                 IF (IX .NE. 0 .OR. IY .NE. 0)  THEN
                    TRA = 0.125 * FSQDP
                    TR  = 1.0

                    IF (TRA < 16.0)  THEN
                       TR       = 1.0 - EXP(-TRA)
                       B(I,  J) = B(I,  J) * TR
                       B(I+1,J) = B(I+1,J) * TR
                   ENDIF
                 ENDIF

              ELSEIF (IOPT == 5 .OR. IOPT == 6)  THEN
C                FERMI DISTRIBUTION FILTER *******************
              
                 TR        = (0.5 * SQRT(FSQ) - PARM1) / PARM3

                 TR        = MIN(MAX(TR,-10.0), 10.0)
                 TR        = (1.0/(1.0 + EXP(TR)))

                 B(I,  J)  = B(I,  J) * TR
                 B(I+1,J)  = B(I+1,J) * TR

              ELSEIF (IOPT == 7) THEN
C                BUTTERWORTH LOWPASS FILTER ******************

                 TRA  = 0.5 * SQRT(FSQ)

                !tr = sqrt(1.0 / (1.0 +           (tra/parm1)**ord)) ! al jan 2018
                 TR = SQRT(1.0 / (1.0 + SQRT2M1 * (TRA/PARM1)**ORD)) 

                 B(I,J)    = B(I,  J) * TR
                 B(I+1,J)  = B(I+1,J) * TR

              ELSEIF (IOPT == 8) THEN
C                BUTTERWORTH HIGHPASS FILTER *****************
        
                 IF (IX.NE.0 .OR. IY.NE. 0) THEN
                    TRA = 0.5 * SQRT(FSQ)

                   !tr  = (1.0 - sqrt(1.0 / (1.0 +(tra/parm1)**ord)))
                    TR = (1.0 - SQRT(1.0 / 
     &                    (1.0 + SQRT2M1 *(TRA/PARM1)**ORD))) ! al jan 2018

                    B(I,  J)  = B(I,  J) * TR
                    B(I+1,J)  = B(I+1,J) * TR

                 ENDIF


              ELSEIF (IOPT == 9) THEN
C                RAISED COSINE LOWPASS FILTER ******************

                 TRA = 0.5 * SQRT(FSQ)
                 TRA = (TRA - PARM1) / (PARM2 - PARM1)

                 IF (TRA < 0) THEN
                    TR = 1
                 ELSEIF (TRA > 1) THEN
                    TR = 0
                 ELSE
                    TR = 0.5 * (1 + COS(PI*TRA))
                 ENDIF

                 B(I,  J)  = B(I,  J) * TR 
                 B(I+1,J)  = B(I+1,J) * TR 

              ELSEIF (IOPT == 10) THEN
C                RAISED COSINE HIGHPASS FILTER ******************

C                RAISED COSINE HIGHPASS FILTER ******************

                 TRA = 0.5 * SQRT(FSQ)
                 TRA = (TRA - PARM1) / (PARM2 - PARM1)

                 IF (TRA < 0) THEN
                    TR = 0
                 ELSEIF (TRA > 1) THEN
                    TR = 1
                 ELSE
                    TR = 0.5 * (1 - COS(PI*TRA))
                 ENDIF

                 B(I,  J)  = B(I,  J) * TR 
                 B(I+1,J)  = B(I+1,J) * TR 

              ELSEIF (IOPT == 11) THEN 
C                BUTTERWORTH ELLIPTIC LOWPASS FILTER *********  
C                CALCULATE EFFECTIVE FP AND FS IN A GIVEN 
C                DIRECTION ON THE PLANE

                 IF (IX.NE.0 .OR. IY.NE.0) THEN

                    FPE = ATAN2(BFPS(1)*SQRT(FLOAT(IY*IY)/YD2SQ),
     &                          BFPS(3)*SQRT(FLOAT(IX*IX)/XD2SQ))
                    FPE = SQRT((BFPS(1)*COS(FPE))**2 + 
     &                         (BFPS(3)*SIN(FPE))**2)

                    FSE = ATAN2(BFPS(2)*SQRT(FLOAT(IY*IY)/YD2SQ),
     &                          BFPS(4)*SQRT(FLOAT(IX*IX)/XD2SQ))
                    FSE = SQRT((BFPS(2)*COS(FSE))**2 + 
     &                         (BFPS(4)*SIN(FSE))**2)

                    ORDT      = ORD  /ALOG10(FPE / FSE)
                    PARMT     = FPE/ EPS**(2. / ORDT)

                    TR        = 0.5 * SQRT(FSQ)
                    TR        = SQRT(1.0 / (1.0 + (TR/PARMT)**ORDT))

                    B(I,  J)  = B(I,  J) * TR
                    B(I+1,J)  = B(I+1,J) * TR
                ENDIF

              ELSEIF (IOPT == 12) THEN
C                BUTTERWORTH ELLIPTIC HIGHPASS FILTER ********* 

                 IF (IX .NE. 0 .OR. IY.NE. 0) THEN

                    FPE = ATAN2(BFPS(1)*SQRT(FLOAT(IY*IY)/YD2SQ),
     &                          BFPS(3)*SQRT(FLOAT(IX*IX)/XD2SQ))
                    FPE = SQRT((BFPS(1)*COS(FPE))**2 +
     &                         (BFPS(3)*SIN(FPE))**2)

                    FSE = ATAN2(BFPS(2)*SQRT(FLOAT(IY*IY)/YD2SQ),
     &                          BFPS(4)*SQRT(FLOAT(IX*IX)/XD2SQ))
                    FSE = SQRT((BFPS(2)*COS(FSE))**2 + 
     &                         (BFPS(4)*SIN(FSE))**2)

                    ORDT     = ORD / ALOG10(FPE / FSE)
                    PARMT    = FPE / (EPS)**(2. / ORDT)

                    TR       = 0.5*SQRT(FSQ)
                    TR       = (1.0-SQRT(1.0/(1.0+(TR/PARMT)**ORDT)))

                    B(I,  J)  = B(I,  J) * TR
                    B(I+1,J)  = B(I+1,J) * TR

                 ENDIF

              ELSEIF (IOPT == 13) THEN
C                RAISED SINC WINDOW **************************
                 TRA = 0.5 * SQRT(FSQDP)

                 IF (TRA <= 0.0001) THEN
                    TR = 1
                 ELSEIF (TRA >= 1.0) THEN
                    TR = 0
                 ELSE
                    TR = SIN(PI*TRA) / (PI*TRA)
                 ENDIF

                 B(I,  J)  = B(I,  J) * (1 + 9 * TR)
                 B(I+1,J)  = B(I+1,J) * (1 + 9 * TR)

                !TRPLOT_TR(it) = (1 + 9 * tempr2)

             ELSEIF (IOPT == 14) THEN
C                B FACTOR FILTER **************************

                 FSQD4  = FSQ * 0.25
                 TR     = 1.0

                 IF (FSQD4 < PARM3)  THEN
                    TR       = EXP(FSQD4 * PARM1)

                    B(I,  J) = B(I,  J) * PARM2 * TR
                    B(I+1,J) = B(I+1,J) * PARM2 * TR

                 ENDIF
              ENDIF

              IF (IWANTETC == 2 .AND. J == 1) THEN
                 TRPLOT_TR(IT) = TR
                 !write(6,'(5i4,3f7.2,f8.4)')i,j,it,ix,iy,f,fsq,fsqdp,tr
              ENDIF

           ENDDO          ! END OF: DO I=1....
        ENDDO             ! END OF: DO J=1...

        IF (IWANTETC == 2) THEN  
          DO N = 1,LSD/2
            WRITE(6,'(I5,3F12.4)') N,TRPLOT_F(N), TRPLOT_TR(N)
          ENDDO
        ENDIF

C       RESTORE ZERO TERM FOR HIGH PASS OPTIONS
        IF (IOPT == 2 .OR. IOPT == 4 .OR. 
     &      IOPT == 6 .OR. IOPT == 8)     B(1,1) = ZEROTERM

        !write(6,*) ' sum2:',sum(b(1:n2x, 1:n2y))

        IRTFLG = 0

        END








C++*********************************************************************
C
C FQ_3.F                                        12/22/94  
C                RDPRAF REMOVED                 DEC 2005 ARDEAN LEITH 
C                COSINE FILTER                  JUL 2012 G. KISHCHENKO 
C                INCORE WITHOUT LUNS            OCT 2012 ARDEAN LEITH 
C                FREQ + PIXELS                  NOV 2012 G. KISHCHENKO 
C                PARM2 BUG                      DEC 2012 ARDEAN LEITH 
C                FREQ UNIT CUTOFF = 1           AUG 2013 ARDEAN LEITH 
C                RAISED SINC                    FEB 2014 ARDEAN LEITH 
C                FROM FQ_Q                      NOV 2014 ARDEAN LEITH 
C                VOLUME ZD2SQ FILTER BUG           MAY 2017 ARDEAN LEITH    
C        
C **********************************************************************
C=*                                                                    *
C=* This file is part of:   SPIDER - Modular Image Processing System.  *
C=* SPIDER System Authors:  Joachim Frank & ArDean Leith               *
C=* Copyright 1985-2018, Health Research Inc.,                         *
C=* Riverview Center, 150 Broadway, Suite 560, Menands, NY 12204.      *
C=* Email: spider@@wadsworth.org                                        *
C=*                                                                    *
C=* SPIDER is free software; you can redistribute it and/or            *
C=* modify it under the terms of the GNU General Public License as     *
C=* published by the Free Software Foundation; either version 2 of the *
C=* License, or (at your option) any later version.                    *
C=*                                                                    *
C=* SPIDER is distributed in the hope that it will be useful,          *
C=* but WITHOUT ANY WARRANTY; without even the implied warranty of     *
C=* merchantability or fitness for a particular purpose.  See the GNU  *
C=* General Public License for more details.                           *
C=* You should have received a copy of the GNU General Public License  *
C=* along with this program. If not, see <http://www.gnu.org/licenses> *
C=*                                                                    *
C **********************************************************************
C
C FQ_3(IOPT,PARM1,PARM2,PARM3,BFPS, B, LSD,N2X,N2Y, NX,NY, 
C      IWANTETC,IRTFLG)
C
C PURPOSE: QUICK FILTERING OF REAL-SPACE IMAGE FILE BY FFT
C
C PARAMETERS:
C        IOPT          TYPE OF FILTER
C        PARM1..       FILTER PARAMETERS
C        BFPS          FILTER PARAMETERS
C        B             BUFFER 
C        LSD           X DIMENSION OF FOURIER FILE
C        NX,NY,NZ      DIMENSIONS OF REAL-SPACE FILE
C        N2X,N2Y,N2Z   DIMENSIONS OF PADDED FILE
C        IWANTETC      OPTIONAL OUTPUTS
C        IRTFLG        ERROR FLAG
C
C23456789012345678901234567890123456789012345678901234567890123456789012  
C--*******************************************************************

        SUBROUTINE FQ3(IOPT, PARM1,PARM2,PARM3,BFPS, 
     &                  B, LSD,N2X,N2Y,N2Z, NX,NY,NZ, IWANTETC,IRTFLG)
        
        IMPLICIT NONE
        INCLUDE 'CMBLOCK.INC'

        INTEGER            :: IOPT       
        REAL               :: PARM1,PARM2,PARM3
        REAL               :: BFPS(4)
        REAL               :: B(LSD,N2Y,N2Z)
        INTEGER            :: LSD,N2X,N2Y,N2Z
        INTEGER            :: NX,NY,NZ,IWANTETC,IRTFLG

        REAL               :: ORD,PARM1SQ,PARM2SQ,SQRT2M1

        REAL               :: XD2SQ,YD2SQ,ZD2SQ,FSQDP,FSQD4
        REAL               :: F,F2,FPE,FSE,ORDT,PARMT,FSQ,EXPCORR
        REAL               :: ZEROTERM
        INTEGER            :: K,J,I, IX,IY,IZ, NR2,NL2
        
        REAL, PARAMETER    :: PI  = 3.14159265358979323846
        REAL, PARAMETER    :: EPS = 0.882

        NR2     = N2Y / 2
        NL2     = N2Z / 2

        XD2SQ   = FLOAT(N2X/2)**2
        YD2SQ   = FLOAT(NR2)  **2
        ZD2SQ   = FLOAT(NL2)  **2

        ORD     = PARM3
        PARM1SQ = PARM1**2
        PARM2SQ = PARM2**2
      
        SQRT2M1 = (SQRT(2.0)-1)


        IF (IOPT == 11 .OR. IOPT == 12) THEN 
C          BUTTERWORTH ELLIPTIC LOWPASS FILTER *********       
C          BUTTERWORTH ELLIPTIC HIGHPASS FILTER *********      
           CALL ERRT(101,
     &        'OPTION NOT IMPLEMENTED FOR VOLUMES',IOPT)
           RETURN
        ENDIF

C       KEEP ZERO TERM FOR HIGH PASS OPTIONS
        ZEROTERM = B(1,1,1)

c$omp   parallel do private(i,j,k,ix,iy,iz,f,f2,fpe,fse,ordt,parmt,
c$omp&                      fsq,fsqdp,fsqd4,expcorr)
      
        DO K=1,N2Z

           IZ = (K-1)
           IF (IZ > NR2) IZ = IZ - N2Z

           DO J=1,N2Y
              IY = (J-1)
              IF (IY > NR2) IY = IY - N2Y

              DO I=1,LSD,2
                 IX = (I-1) / 2
                 FSQDP = (FLOAT(IX*IX)/XD2SQ/PARM1SQ +
     &                    FLOAT(IY*IY)/YD2SQ/PARM2SQ +
     &                    FLOAT(IZ*IZ)/ZD2SQ/PARM2SQ)

                 FSQ   = (FLOAT(IX*IX)/XD2SQ +
     &                    FLOAT(IY*IY)/YD2SQ +
     &                    FLOAT(IZ*IZ)/ZD2SQ)

                 IF (IOPT == 1) THEN
C                   LOWPASS *************************************
                    IF (0.25 * FSQDP > 1.0) THEN

                       B(I,  J,K) = 0.0
                       B(I+1,J,K) = 0.0
                    ENDIF

                 ELSEIF (IOPT == 2) THEN        
C                   HIGH PASS ***********************************
                    IF ( (IX.NE.0 .OR. IY .NE.0 .OR. IZ .NE. 0) .AND.
     &                 0.25 * FSQDP <= 1.0) THEN

                       B(I,  J,K) = 0.0
                       B(I+1,J,K) = 0.0
                    ENDIF

                 ELSEIF(IOPT == 3)  THEN
C                   GAUSSIAN LOW PASS ***************************
                    F = 0.125 * FSQDP

                    IF (F < 16.0)  THEN
                       F          = EXP(-F)
                       B(I,  J,K) = B(I,  J,K) * F
                       B(I+1,J,K) = B(I+1,J,K) * F
                    ELSE
                       B(I,  J,K) = 0.0
                       B(I+1,J,K) = 0.0
                    ENDIF

                 ELSEIF (IOPT==4)  THEN 
C                   GAUSSIAN HIGH PASS **************************

                    IF (IX .NE. 0 .OR. IY .NE. 0 .OR. IZ .NE. 0)THEN
                       F = 0.125 * FSQDP

                       IF (F < 16.0)  THEN
                          F          = 1.0 - EXP(-F)
                          B(I,  J,K) = B(I,  J,K) * F
                          B(I+1,J,K) = B(I+1,J,K) * F
                       ENDIF
                    ENDIF

                 ELSEIF (IOPT == 5 .OR. IOPT == 6)  THEN
C                   FERMI DISTRIBUTION FILTER *******************
              
                    F = (0.5 * SQRT(FSQ)-PARM1) / PARM3

                    F          = MIN(MAX(F,-10.0), 10.0)
                    F          = 1.0 / (1.0 + EXP(F))

                    B(I,  J,K) = B(I,  J,K) * F
                    B(I+1,J,K) = B(I+1,J,K) * F

                 ELSEIF (IOPT == 7) THEN
C                   BUTTERWORTH LOWPASS FILTER ******************

                    F          = 0.5 * SQRT(FSQ)

                    F          = SQRT(1.0 / 
     &                           (1.0 + SQRT2M1 * (F / PARM1)**ORD) )

                    B(I,  J,K) = B(I,  J,K) * F
                    B(I+1,J,K) = B(I+1,J,K) * F

                 ELSEIF (IOPT == 8) THEN
C                   BUTTERWORTH HIGHPASS FILTER *****************
        
                    IF (IX.NE.0 .OR. IY.NE. 0 .OR. IZ.NE. 0) THEN
                       F = 0.5 * SQRT(FSQ)
   
                       F = 1.0 - SQRT(1.0 / 
     &                          (1.0 + SQRT2M1 * (F / PARM1)**ORD))

                       B(I,  J,K) = B(I,  J,K) * F
                       B(I+1,J,K) = B(I+1,J,K) * F
                    ENDIF


                 ELSEIF (IOPT == 9) THEN
C                   RAISED COSINE LOWPASS FILTER ******************

                    F = 0.5 * SQRT(FSQ)

C                   F = (F-FP)    / (FS-FP)
                    F = (F-PARM1) / (PARM2 - PARM1)

                    IF (F < 0) THEN
                       F2 = 1
                    ELSEIF (F > 1) THEN
                       F2 = 0
                    ELSE
                       F2 = 0.5 * (1 + COS(PI*F))
                    ENDIF

                    B(I,  J,K) = B(I,  J,K) * F2
                    B(I+1,J,K) = B(I+1,J,K) * F2

                 ELSEIF (IOPT == 10) THEN
C                   RAISED COSINE HIGHPASS FILTER ******************

                    F = 0.5 * SQRT(FSQ)

                    F = (F-PARM1) / (PARM2 - PARM1)

                    IF (F < 0) THEN
                       F2 = 0
                    ELSEIF (F > 1) THEN
                       F2 = 1
                    ELSE
                       F2 = 0.5 * ( 1 - COS(PI * F))
                    ENDIF

                    B(I,  J,K) = B(I,  J,K) * F2
                    B(I+1,J,K) = B(I+1,J,K) * F2

                 ELSEIF (IOPT == 13) THEN
C                   RAISED SINC WINDOW **************************

                    F = 0.5 * SQRT(FSQDP)

                    IF (F <= 0.0001) THEN
                       F2 = 1
                    ELSEIF (F >= 1.0) THEN
                       F2 = 0
                    ELSE
                       F2 = SIN(PI * F) / (PI * F)
                    ENDIF
   
                    B(I,  J,K) = B(I,  J,K) * (1 + 9 * F2)
                    B(I+1,J,K) = B(I+1,J,K) * (1 + 9 * F2)
   
                 ELSEIF (IOPT == 14) THEN
C                   B FACTOR FILTER *****************************

                    FSQD4 = FSQ * 0.25
      
                    IF (FSQD4 < PARM3)  THEN
                       EXPCORR    = EXP(F * PARM1)

                       B(I,J,K)   = B(I,J,K)  * PARM2 * EXPCORR
                       B(I+1,J,K) = B(I+1,J,K)* PARM2 * EXPCORR
                    ENDIF

                 ENDIF
              ENDDO
           ENDDO
        ENDDO

C       RESTORE ZERO TERM FOR HIGH PASS OPTIONS
        IF (IOPT == 2 .OR. IOPT == 4 .OR. 
     &      IOPT == 6 .OR. IOPT == 8) 
     &     B(1,1,1) = ZEROTERM

        IRTFLG = 0

        END




@


1.19
log
@email_health_dept
@
text
@d21 1
a21 1
C=* Email: spider@@health.ny.gov                                        *
d517 1
a517 1
C=* Email: spider@@health.ny.gov                                        *
d903 1
a903 1
C=* Email: spider@@health.ny.gov                                        *
@


1.18
log
@hidden plot option and pad type options
@
text
@d21 1
a21 1
C=* Email: spider@@wadsworth.org                                        *
d517 1
a517 1
C=* Email: spider@@wadsworth.org                                        *
d903 1
a903 1
C=* Email: spider@@wadsworth.org                                        *
@


1.17
log
@sqrt2m1 in butterworth, cosmetics
@
text
@d13 1
d45 2
a46 2
C        WAY BACK BEFOR SPIDER 17.0 AND MAYBE FOREVER.  I SUGGEST
C        NOT USING IT??
d50 1
a50 1
C        ERRORS IF PERSON ENTERS MORE THAN ONE VALUE ON THE INPUT
d64 3
d88 2
a89 2
        INTEGER                :: IWANTFOU,NLETF,ITYPE
        LOGICAL                :: WANTFOU
d127 10
a136 2
        IWANTFOU = 0    ! HIDDEN FOURIER OUTPUT OPTION
        CALL RDPRI2S(IOPT,IWANTFOU,NOT_USED,
d143 3
d147 4
d152 9
a160 2
       IF (NZ > 1 .AND. IOPT == 13 ) THEN
           CALL ERRT(101,'OPTION NOT IMPLEMENTED FOR VOLUMES',IOPT)
a162 2
         
        WANTFOU = (IWANTFOU == 1)
a306 4

C       IPADTYPE: 0 == NONE,  1== ZEROPAD, 2==BORDERPAD, 3==AVG PAD
        IPADTYPE = 2    ! PAD WITH ZEROES

a336 1

d339 1
a339 1
C          NO PADDING AT ALL, EXCEPT FOR FFT PAD IN BUFFER
d414 1
a414 1
        !write(6,*) ' pad:',padval
d430 1
a430 1
     &              LSD,N2X,N2Y, NX,NY, IRTFLG)
d437 1
a437 1
     &              LSD,N2X,N2Y,N2Z, NX,NY,NZ, IRTFLG)
d459 1
a459 1
C          STORE FILTERED FFT
d465 1
d481 1
a481 1
C       STORE FILTERED IMAGE
d533 2
a534 1
C FQ2(IOPT,PARM1,PARM2,PARM3,BFPS,B, LSD,N2X,N2Y, NX,NY, IRTFLG)
d546 2
d553 1
a553 1
     &                  B, LSD,N2X,N2Y, NX,NY, IRTFLG)
d563 1
a563 1
        INTEGER            :: NX,NY,IRTFLG
d568 1
d570 3
a572 3
        REAL               :: F,F2,FPE,FSE,ORDT,PARMT,EXPCORR
        INTEGER            :: J,I,IX,IY, NR2
        
d576 4
a579 3
        real       :: bsavi(lsd),bsavv(lsd),bsavf(lsd)
        integer    :: it
        real       :: xd2sqdp1sqinv,xd2sqdp1sq
d597 3
d605 4
a609 1
        !write(6,*) ' sum1:',sum(b(1:n2x, 1:n2y)),zeroterm
d612 1
a612 1
c$omp&                     fsq,fsqdp,fsqd4,expcorr)
d622 1
d629 9
a637 4
              !it        = (i -1)/2 + 1    ! 1,1,2
              !f         = float(ix)/n2x + float(iy)/n2y
              !bsavf(it) = f
              !write(6,*) ' it,ix,iy,f:',it,ix,iy,f
d642 2
a643 1
                 !bsavv(it) =  1.0
d646 3
a648 4
                    B(I,  J)  = 0.0
                    B(I+1,J)  = 0.0

                   !bsavv(it) = 0.0
d654 2
a655 2
                 !bsavv(it) =  1.0
 
d659 4
a662 5
                    B(I,  J)  = 0.0
                    B(I+1,J)  = 0.0
 
                   !bsavv(it) = 0.0
                 ENDIF
d667 2
a668 3
                 F = 0.125 * FSQDP

                 !bsavi(it) = F
d670 4
a673 5
                 IF (F < 16.0)  THEN
                    F         = EXP(-F)
                    B(I,  J)  = B(I,  J) * F
                    B(I+1,J)  = B(I+1,J) * F
                   !bsavv(it) = F
d675 2
a676 3
                    B(I,  J)  = 0.0
                    B(I+1,J)  = 0.0
                   !bsavv(it) = 0.0
d678 1
d684 2
a685 4
                    F = 0.125 * FSQDP

                   !bsavv(it) = 1.0
                   !bsavi(it) = F
d687 5
a691 7
                    IF (F < 16.0)  THEN
                       F         = 1.0 - EXP(-F)
                       B(I,  J)  = B(I,  J) * F
                       B(I+1,J)  = B(I+1,J) * F

                      !bsavv(it) = F
                    ENDIF
d697 1
a697 4
                 F         = (0.5 * SQRT(FSQ) - PARM1) / PARM3

                 F         = MIN(MAX(F,-10.0), 10.0)
                 F         = (1.0/(1.0 + EXP(F)))
d699 2
a700 2
                 B(I,  J)  = B(I,  J) * F
                 B(I+1,J)  = B(I+1,J) * F
d702 2
a703 2
                 !bsavi(it) = (0.5 * sqrt(fsq) - parm1) / parm3
                 !bsavv(it) = f
d708 1
a708 1
                 F = 0.5 * SQRT(FSQ)
d710 2
a711 2
                !F = SQRT(1.0 / (1.0 +           (F/PARM1)**ORD)) ! al jan 2018
                 F = SQRT(1.0 / (1.0 + SQRT2M1 * (F/PARM1)**ORD)) 
d713 2
a714 5
                 B(I,J)    = B(I,  J) * F
                 B(I+1,J)  = B(I+1,J) * F

                 !bsavi(it) = 0.5 * sqrt(fsq)
                 !bsavv(it) = f
a718 2
                 !bsavi(it) = 0

d720 1
a720 1
                    F = 0.5 * SQRT(FSQ)
d722 3
a724 3
                   !F  = (1.0 - SQRT(1.0 / (1.0 +(F/PARM1)**ORD)))
                    F  = (1.0 - SQRT(1.0 / 
     &                    (1.0 + SQRT2M1 *(F/PARM1)**ORD))) ! al jan 2018
d726 2
a727 2
                    B(I,  J)  = B(I,  J) * F
                    B(I+1,J)  = B(I+1,J) * F
a728 2
                   !bsavi(it) = 0.5 * sqrt(fsq)
                   !bsavv(it) = f
d735 2
a736 3
                 F = 0.5 * SQRT(FSQ)
 
                 F = (F - PARM1) / (PARM2 - PARM1)
d738 4
a741 4
                 IF (F < 0) THEN
                    F2 = 1
                 ELSEIF (F > 1) THEN
                    F2 = 0
d743 1
a743 1
                    F2 = 0.5 * (1 + COS(PI*F))
d746 2
a747 3
                 B(I,  J)  = B(I,  J) * F2
                 B(I+1,J)  = B(I+1,J) * F2
                 !bsavv(it) = F2
d752 1
a752 1
                 F = 0.5 * SQRT(FSQ)
d754 2
a755 1
                 F = (F - PARM1) / (PARM2 - PARM1)
d757 4
a760 4
                 IF (F < 0) THEN
                    F2 = 0
                 ELSEIF (F > 1) THEN
                    F2 = 1
d762 1
a762 1
                    F2 = 0.5 * (1 - COS(PI*F))
d765 2
a766 3
                 B(I,  J)  = B(I,  J) * F2
                 B(I+1,J)  = B(I+1,J) * F2
                 !bsavv(it) = F2
d788 2
a789 2
                    F         = 0.5*SQRT(FSQ)
                    F         = SQRT(1.0 / (1.0 + (F/PARMT)**ORDT))
d791 2
a792 3
                    B(I,  J)  = B(I,  J) * F
                    B(I+1,J)  = B(I+1,J) * F
                    !bsavv(it) = F
d813 2
a814 2
                    F        = 0.5*SQRT(FSQ)
                    F        = (1.0-SQRT(1.0/(1.0+(F/PARMT)**ORDT)))
d816 2
a817 2
                    B(I,  J)  = B(I,  J) * F
                    B(I+1,J)  = B(I+1,J) * F
a818 1
                    !bsavv(it) = F
d823 1
a823 1
                 F = 0.5 * SQRT(FSQDP)
d825 4
a828 4
                 IF (F <= 0.0001) THEN
                    F2 = 1
                 ELSEIF (F >= 1.0) THEN
                    F2 = 0
d830 1
a830 1
                    F2 = SIN(PI*F) / (PI*F)
d833 2
a834 2
                 B(I,  J)  = B(I,  J) * (1 + 9 * F2)
                 B(I+1,J)  = B(I+1,J) * (1 + 9 * F2)
d836 1
a836 1
                !bsavv(it) = (1 + 9 * F2)
d841 2
a842 4
                 FSQD4     = FSQ * 0.25

                 !bsavi(it) = fsqd4
                 !bsavv(it) = 1.0
d845 1
a845 1
                    EXPCORR  = EXP(FSQD4 * PARM1)
d847 2
a848 3
                    B(I,  J)  = B(I,  J) * PARM2 * EXPCORR
                    B(I+1,J)  = B(I+1,J) * PARM2 * EXPCORR
                   !bsavv(it) = PARM2 * EXPCORR
a851 1
           ENDDO
d853 4
a856 9
#ifdef NEVER
           if (j ==1) then
             do it = 1,33
               write(6,888) bsavi(it), bsavf(it), bsavv(it)
888            format (f12.4, f12.4, f12.4)
             enddo
             stop
           endif
#endif
d858 8
a865 1
        ENDDO
d919 2
a920 1
C FQ_3(IOPT,PARM1,PARM2,PARM3,BFPS, B, LSD,N2X,N2Y, NX,NY, IRTFLG)
d932 2
d939 1
a939 1
     &                  B, LSD,N2X,N2Y,N2Z, NX,NY,NZ, IRTFLG)
d949 1
a949 1
        INTEGER            :: NX,NY,NZ,IRTFLG
d964 3
a966 3
        XD2SQ      = FLOAT(N2X/2)**2
        YD2SQ      = FLOAT(NR2)  **2
        ZD2SQ      = FLOAT(NL2)  **2
@


1.16
log
@speeded up substitutions,  simplified,  butterworth poor note
@
text
@d11 2
a12 1
C             SIMPLIFIED                           JAN 18  ARDEAN LEITH    
d123 1
a123 1
        IWANTFOU = 0
d142 1
a142 1
        BFPS  = 0.0
d153 1
a153 1
     &         PARM1 = 0.5 * PARM1 / (NX/2)     ! RADIUS INPUT
a169 2
           ORD = 2.0 * ALOG10(EPS / SQRT(AA**2 - 1.0) )

d183 9
a191 2
              PARM3 = ORD   / ALOG10(PARM1 / PARM2)
              PARM1 = PARM1 / EPS**(2. / PARM3)
d203 4
d220 1
a220 1
     &         PARM1 = 0.5 * PARM1 / (NX/2)     ! RADIUS INPUT
d228 1
a228 1
              PARM2 = 0.5 * PARM2 / (NY/2)   
d268 1
a268 1
              PARM1 = 0.5 * PARM1 / (NX/2)     ! RADIUS INPUT
d278 1
a278 1
              PARM2 = 0.5 * PARM2T / (NY/2)   
d495 1
a495 1
C=* Copyright 1985-2014, Health Research Inc.,                         *
d543 1
a543 1
        REAL               :: ORD,PARM1SQ,PARM2SQ
d565 2
d580 1
a580 1
c$omp  parallel do private(j,i,iy,ix,f,f2,fpe,fse,ordt,parmt,
d587 1
d597 2
a598 2
              it        = (i -1)/2 + 1    ! 1,1,2
              f         = float(ix)/n2x + float(iy)/n2y
d600 1
d611 1
a611 1
                    !bsavv(it) = 0.0
d625 1
a625 1
                    !bsavv(it) = 0.0
d639 1
a639 1
                    !bsavv(it) = F
d643 1
a643 1
                    !bsavv(it) = 0.0
d652 2
a653 2
                    !bsavv(it) = 1.0
                    !bsavi(it) = F
d660 1
a660 1
                       !bsavv(it) = F
d681 1
a681 1
                 F         = 0.5 * SQRT(FSQ)
d683 2
a684 1
                 F         = SQRT(1.0 / (1.0 + (F/PARM1)**ORD))
d700 3
a702 1
                    F = (1.0 - SQRT(1.0 / (1.0+(F/PARM1)**ORD)))
d707 2
a708 2
                    !bsavi(it) = 0.5 * sqrt(fsq)
                    !bsavv(it) = f
d715 1
a715 2
                 F         = 0.5 * SQRT(FSQ)
                 !bsavi(it) = F
d734 1
a734 2
                 F         = 0.5 * SQRT(FSQ)
                 !bsavi(it) = F
d767 1
a767 1
                    ORDT     = ORD  /ALOG10(FPE / FSE)
d820 1
a820 1
                 !bsavv(it) = (1 + 9 * F2)
d835 1
a835 1
                    !bsavv(it) = PARM2 * EXPCORR
d934 1
a934 1
        REAL               :: ORD,PARM1SQ,PARM2SQ
d955 2
d1050 2
a1051 1
                    F          = SQRT(1.0/ (1.0 + (F / PARM1)**ORD) )
d1062 2
a1063 1
                       F = 1.0 - SQRT(1.0/ (1.0 + (F / PARM1)**ORD))
d1075 1
a1075 1
C                   F = (F-FP) / (FS-FP)
a1147 8


C  B FACTOR FOR 64X64 IMAGE (INCREASES AMPLITUDES NEAR ORIGIN)
C    XD2SQ = (NX/2)*2 = 32
C
C    IX     FSQ      B*FSQ
C     1     1/1024   B/1024
C    64     1/16     B/16
@


1.15
log
@improved comments and explanations and prompts
@
text
@d11 1
d41 5
d55 2
a56 2
C        'FF' (ffilts.f)     SETS X1 TO: (NX  / 2)**2 BUT
C        'FQ' (four_fq.f)    SETS X1 TO: (NXF / 2)**2 WHERE
d184 1
a184 1
              PARM3 = ORD / ALOG10(PARM1 / PARM2)
a198 2
           !write(6,*) 'ord,parm1:',parm3,parm1

d535 2
a536 2
        REAL               :: X1,Y1
        REAL               :: F,F2,FPE,FSE,ORDT,PARMT,FSQ,EXPCORR
d542 6
d549 1
a549 2
        X1      = FLOAT(N2X/2)**2
        Y1      = FLOAT(NR2)  **2
a553 1
      
d557 8
d569 1
a569 1
c$omp&                     fsq,expcorr)
d577 10
a586 1
              IX = (I-1) / 2
d591 5
a595 2
                 IF (0.25 * (FLOAT(IX*IX)/X1/PARM1SQ +
     &                       FLOAT(IY*IY)/Y1/PARM2SQ) > 1.0) THEN
d597 1
a597 2
                    B(I,  J) = 0.0
                    B(I+1,J) = 0.0
d603 4
a606 3
                 IF ( (IX.NE.0 .OR. IY.NE.0) .AND.
     &                0.25 * (FLOAT(IX*IX)/X1/PARM1SQ + 
     &                        FLOAT(IY*IY)/Y1/PARM2SQ) <= 1.0) THEN
d608 4
a611 2
                    B(I,  J) = 0.0
                    B(I+1,J) = 0.0
d617 3
a619 2
                 F = 0.125 * (FLOAT(IX*IX)/X1/PARM1SQ +
     &                        FLOAT(IY*IY)/Y1/PARM2SQ)
d622 4
a625 3
                    F        = EXP(-F)
                    B(I,  J) = B(I,  J) * F
                    B(I+1,J) = B(I+1,J) * F
d627 3
a629 2
                    B(I,  J) = 0.0
                    B(I+1,J) = 0.0
d636 4
a639 2
                    F = 0.125 * (FLOAT(IX*IX)/X1/PARM1SQ +
     &                           FLOAT(IY*IY)/Y1/PARM2SQ)
d642 5
a646 3
                       F        = 1.0 - EXP(-F)
                       B(I,  J) = B(I,  J) * F
                       B(I+1,J) = B(I+1,J) * F
d653 4
a656 2
                 F = (0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                           FLOAT(IY*IY)/Y1) - PARM1) / PARM3
d658 2
a659 2
                 F        = AMIN1(AMAX1(F,-10.0), 10.0)
                 F        = (1.0/(1.0 + EXP(F)))
d661 2
a662 2
                 B(I,  J) = B(I,  J) * F
                 B(I+1,J) = B(I+1,J) * F
d667 1
a667 2
                 F        = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                                 FLOAT(IY*IY)/Y1)
d669 1
a669 1
                 F        = SQRT(1.0 / (1.0 + (F/PARM1)**ORD))
d671 5
a675 2
                 B(I,J)   = B(I,  J) * F
                 B(I+1,J) = B(I+1,J) * F
d680 2
d683 1
a683 2
                    F = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                             FLOAT(IY*IY)/Y1)
d687 5
a691 2
                    B(I,  J) = B(I,  J) * F
                    B(I+1,J) = B(I+1,J) * F
d698 3
a700 3
                 F = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                          FLOAT(IY*IY)/Y1)

d711 3
a713 2
                 B(I,  J) = B(I,  J) * F2
                 B(I+1,J) = B(I+1,J) * F2
d718 2
a719 2
                 F = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                          FLOAT(IY*IY)/Y1)
d731 3
a733 2
                 B(I,  J) = B(I,  J) * F2
                 B(I+1,J) = B(I+1,J) * F2
d742 2
a743 2
                    FPE = ATAN2(BFPS(1)*SQRT(FLOAT(IY*IY)/Y1),
     &                          BFPS(3)*SQRT(FLOAT(IX*IX)/X1))
d747 2
a748 2
                    FSE = ATAN2(BFPS(2)*SQRT(FLOAT(IY*IY)/Y1),
     &                          BFPS(4)*SQRT(FLOAT(IX*IX)/X1))
d753 1
a753 1
                    PARMT    = FPE/ EPS**(2. / ORDT)
d755 2
a756 2
                    F        = 0.5*SQRT(FLOAT(IX*IX)/X1+FLOAT(IY*IY)/Y1)
                    F        = SQRT(1.0 / (1.0 + (F/PARMT)**ORDT))
d758 4
a761 3
                    B(I,  J) = B(I,  J) * F
                    B(I+1,J) = B(I+1,J) * F
                 ENDIF
d768 2
a769 2
                    FPE = ATAN2(BFPS(1)*SQRT(FLOAT(IY*IY)/Y1),
     &                          BFPS(3)*SQRT(FLOAT(IX*IX)/X1))
d773 2
a774 2
                    FSE = ATAN2(BFPS(2)*SQRT(FLOAT(IY*IY)/Y1),
     &                          BFPS(4)*SQRT(FLOAT(IX*IX)/X1))
d781 1
a781 1
                    F        = 0.5*SQRT(FLOAT(IX*IX)/X1+FLOAT(IY*IY)/Y1)
d784 4
a787 2
                    B(I,  J) = B(I,  J) * F
                    B(I+1,J) = B(I+1,J) * F
d792 1
a792 2
                 F = 0.5 * SQRT(FLOAT(IX*IX)/X1/PARM1SQ +
     &                          FLOAT(IY*IY)/Y1/PARM2SQ)
d802 2
a803 2
                 B(I,  J) = B(I,  J) * (1 + 9 * F2)
                 B(I+1,J) = B(I+1,J) * (1 + 9 * F2)
d805 3
a807 1
              ELSEIF (IOPT == 14) THEN
d810 7
a816 2
                 FSQ = (FLOAT(IX*IX) / X1 + 
     &                  FLOAT(IY*IY) / Y1) * 0.25
d818 3
a820 2
                 IF (FSQ < PARM3)  THEN
                    EXPCORR  = EXP(FSQ * PARM1)
a821 2
                    B(I,  J) = B(I,  J) * PARM2 * EXPCORR
                    B(I+1,J) = B(I+1,J) * PARM2 * EXPCORR
a822 1

d825 11
d866 1
a866 1
C                VOLUME Z1 FILTER BUG           MAY 2017 ARDEAN LEITH    
d872 1
a872 1
C=* Copyright 1985-2017, Health Research Inc.,                         *
d921 1
a921 1
        REAL               :: X1,Y1,Z1
d932 3
a934 3
        X1      = FLOAT(N2X/2)**2
        Y1      = FLOAT(NR2)  **2
        Z1      = FLOAT(NL2)  **2
d953 1
a953 1
c$omp&                      fsq,expcorr)
d966 7
d976 1
a976 3
                    IF (0.25 * (FLOAT(IX*IX)/X1/PARM1SQ +
     &                          FLOAT(IY*IY)/Y1/PARM2SQ +
     &                          FLOAT(IZ*IZ)/Z1/PARM2SQ) > 1.0) THEN
d985 1
a985 3
     &                 0.25 * (FLOAT(IX*IX)/X1/PARM1SQ + 
     &                         FLOAT(IY*IY)/Y1/PARM2SQ +
     &                         FLOAT(IZ*IZ)/Z1/PARM2SQ) <= 1.0) THEN
d993 1
a993 3
                    F = 0.125 * (FLOAT(IX*IX)/X1/PARM1SQ +
     &                           FLOAT(IY*IY)/Y1/PARM2SQ +
     &                           FLOAT(IZ*IZ)/Z1/PARM2SQ)
d996 1
a996 1
                       F           = EXP(-F)
d1008 1
a1008 3
                       F = 0.125 * (FLOAT(IX*IX)/X1/PARM1SQ +
     &                              FLOAT(IY*IY)/Y1/PARM2SQ +
     &                              FLOAT(IZ*IZ)/Z1/PARM2SQ)
d1020 1
a1020 3
                    F = (0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                              FLOAT(IY*IY)/Y1 +
     &                              FLOAT(IZ*IZ)/Z1)-PARM1) / PARM3
d1022 2
a1023 2
                    F        = AMIN1(AMAX1(F,-10.0), 10.0)
                    F        = 1.0 / (1.0 + EXP(F))
d1031 1
a1031 3
                    F        = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                                    FLOAT(IY*IY)/Y1 +
     &                                    FLOAT(IZ*IZ)/Z1)
d1033 1
a1033 1
                    F           = SQRT(1.0/ (1.0 + (F / PARM1)**ORD) )
d1042 1
a1042 3
                       F = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                                FLOAT(IY*IY)/Y1 +
     &                                FLOAT(IZ*IZ)/Z1)
d1054 1
a1054 3
                    F = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                             FLOAT(IY*IY)/Y1 +
     &                             FLOAT(IZ*IZ)/Z1)
d1073 1
a1073 3
                    F = 0.5 * SQRT(FLOAT(IX*IX)/X1 +
     &                             FLOAT(IY*IY)/Y1 +
     &                             FLOAT(IZ*IZ)/Z1)
d1091 1
a1091 3
                    F = 0.5 * SQRT(FLOAT(IX*IX)/X1/PARM1SQ +
     &                             FLOAT(IY*IY)/Y1/PARM2SQ +
     &                             FLOAT(IZ*IZ)/Z1/PARM2SQ)
d1105 1
a1105 1
C                   B FACTOR FILTER **************************
d1107 1
a1107 3
                    FSQ = (FLOAT(IX*IX) / X1 + 
     &                     FLOAT(IY*IY) / Y1 +
     &                     FLOAT(IZ*IZ) / Z1) * 0.25
d1109 2
a1110 2
                    IF (FSQ < PARM3)  THEN
                       EXPCORR    = EXP(FSQ * PARM1)
d1132 1
a1132 1
C    X1 = (NX/2)*2 = 32
@


1.14
log
@cosmetic
@
text
@d36 3
a38 3
C PURPOSE:  APPLIES FOURIER FILTERS TO 2-D OR 3-D REAL PICTURES
C            'FQ Q'   : QUICK FILTERING (IN CORE, 2-D OR 3-D)
C            'FQ QNP' : QUICK FILTERING (IN CORE, 2-D OR 3-D) NO PAD
d49 2
a50 2
C        'FF' (ffilts.f)            SETS X1 TO: (NX  / 2)**2 BUT
C        'FQ' (four_fq.f or fq_q.f) SETS X1 TO: (NXF / 2)**2 WHERE
d117 2
a118 1
        CALL RDPRI2S(IOPT,IWANTFOU,NOT_USED,'FILTER TYPE (1-14)',IRTFLG)
d222 1
a222 1
           WRITE(NOUT,*)' AMP = AMP*D*(EXP(BF**2))'
d225 1
a225 1
           CALL RDPRM1S(PARM1, NOT_USED,'B FACTOR',   IRTFLG)
d234 3
@


1.13
log
@VOLUME Z1 FILTER BUG
@
text
@d16 1
a16 1
C=* Copyright 1985-2017  Health Research Inc.,                         *
d221 1
a221 1
           WRITE(NOUT,*)' AMP = AMP*D*(EXP(Bs**2))'
d223 1
d227 1
a227 1
           PARM2 = 0.5
@


1.12
log
@INDEX(FCHAR,'NP') > 0
@
text
@d10 1
d16 1
a16 1
C=* Copyright 1985-2015  Health Research Inc.,                         *
d796 1
d802 1
a802 1
C=* Copyright 1985-2014, Health Research Inc.,                         *
d864 1
a864 1
        Y1      = FLOAT(NL2)  **2
@


1.11
log
@VOLUME IOPT 12 & 13 TRAP for ifort
@
text
@d267 1
a267 1
        IF (FCHAR(4:5) == 'NP' .OR. FCHAR(5:6) == 'NP')  THEN
a783 9









d1080 2
@


1.10
log
@ehco parm1 in freq
@
text
@d4 6
a9 5
C                   OPFILEC                       FEB 03 ARDEAN LEITH    
C                   COS                           JUL 12 G. KISHCHENKO    
C                   FQ Q PARAMS                   OCT 12 ARDEAN LEITH    
C                   RAISED SINC                   OCT 13 ARDEAN LEITH    
C                   CREATED FROM FOUR1A           NOV 14 ARDEAN LEITH    
d15 1
a15 1
C=* Copyright 1985-2014  Health Research Inc.,                         *
d878 8
a1035 13
                 ELSEIF (IOPT == 11) THEN 
C                   BUTTERWORTH ELLIPTIC LOWPASS FILTER *********       
                    CALL ERRT(101,
     &                 'OPTION NOT IMPLEMENTED FOR VOLUMES',IOPT)
                    RETURN

                 ELSEIF (IOPT == 12) THEN
C                   BUTTERWORTH ELLIPTIC HIGHPASS FILTER *********      
                    CALL ERRT(101,
     &                 'OPTION NOT IMPLEMENTED FOR VOLUMES',IOPT)
                    RETURN

 
@


1.9
log
@echo formatting
@
text
@d246 4
a249 2
           IF (PARM1T < 0.0 .OR. PARM1T > 1.0) 
     &         PARM1 = 0.5 * PARM1 / (NX/2)     ! RADIUS INPUT
@


1.8
log
@fourier output support
note about nx vs n2x for x1 definition
@
text
@d385 1
a385 1
     &                '  DIMENSIONS USED: ',N2X,' x ',N2Y
d392 1
a392 1
     &           '  DIMENSIONS USED: ',N2X,' x ',N2Y,' x ',N2Z
@


1.7
log
@FSQ >= PARM3  --> FSQ < PARM3  (bug)
@
text
@d46 8
a53 1
c
d63 1
a63 1
        CHARACTER (LEN=MAXNAM)  :: FILNAM
d65 1
a65 1
        REAL, ALLOCATABLE       :: BB(:,:,:)
d67 11
a77 8
        INTEGER                 :: N2X,N2Y,N2Z,LSD
        INTEGER                 :: NX,NY,NZ
        INTEGER                 :: MAXIM,IOPT,IRTFLG,NOT_USED
        INTEGER                 :: IDUM,NE,IPADTYPE
        INTEGER                 :: NMAX,NGOT,INV,I,J,K,IRECT
        REAL                    :: ORD,FP,FS,PARM1T,PARM2T,AVET
        REAL                    :: PARM1,PARM2,PARM3,PADVAL
        REAL                    :: BFPS(4)
d79 2
a80 2
        REAL, PARAMETER         :: EPS = 0.882
        REAL, PARAMETER         :: AA  = 10.624
d82 2
a83 2
        INTEGER, PARAMETER      :: LUN1 = 21
        INTEGER, PARAMETER      :: LUN2 = 22
d102 1
a102 4
C       OPEN REAL SPACE OUTPUT FILE
        MAXIM = 0
        CALL OPFILEC(LUN1,.TRUE.,FILNAM,LUN2,'U',IFORM,NX,NY,NZ,
     &               MAXIM,'OUTPUT',.FALSE.,IRTFLG)
a103 1

d114 2
a115 1
        CALL RDPRI1S(IOPT,NOT_USED,'FILTER TYPE (1-14)',IRTFLG)
d127 2
a128 1

d219 1
a219 1
           WRITE(NOUT,*)' AMP = AMP*D(EXP(Bs**2))'
d225 1
a225 1
           CALL RDPRM1S(PARM2, NOT_USED,'D CONSTANT', IRTFLG)
d374 1
a374 1
C       FORWARD FFT, 2xFFT PADDED
d398 31
a428 1
C       INVERSE FFT, 2X PADDED
d1085 6
a1090 1

@


1.6
log
@without variable speed up
@
text
@d75 1
a75 1
C       OPEN REAL SPACE INPUT FILE
d78 1
a78 1
     &             MAXIM,'INPUT',.FALSE.,IRTFLG)
d83 2
a84 1
           CALL ERRT(101,'OPERATION WORKS ON REAL INPUT',IDUM)
d508 1
d513 1
d522 1
a522 1
                    B(I,J)   = 0.0
d533 1
a533 1
                    B(I,J)   = 0.0
d545 1
a545 1
                    B(I,J)   = B(I,  J) * F
d548 1
a548 1
                    B(I,J)   = 0.0
d561 2
a562 2
                       B(I,J)   = B(I,J)  *F
                       B(I+1,J) = B(I+1,J)*F
d575 2
a576 2
                 B(I,J)   = B(I,J)  * F
                 B(I+1,J) = B(I+1,J)* F
d586 1
a586 1
                 B(I,J)   = B(I,J)   * F
d598 1
a598 1
                    B(I,J)   = B(I,  J) * F
d619 1
a619 1
                 B(I,J)   = B(I,  J) * F2
d638 1
a638 1
                 B(I,J)   = B(I,J)   * F2
d664 1
a664 1
                    B(I,J)   = B(I,  J) * F
d689 1
a689 1
                    B(I,J)   = B(I,  J) * F
d706 1
a706 1
                 B(I,J)   = B(I,J)   * (1 + 9 * F2)
d715 1
a715 1
                 IF (FSQ >= PARM3)  THEN
d718 2
a719 2
                    B(I,J)   = B(I,J)  * PARM2 * EXPCORR
                    B(I+1,J) = B(I+1,J)* PARM2 * EXPCORR
d1025 1
a1025 1
                    IF (FSQ >= PARM3)  THEN
@


1.5
log
@speeded up using precalculated variables,
time is actually dominated by fft so not worth changing
@
text
@d43 4
a74 4
        real               :: tm1,tm2,etime
	real ::  tarray(2) 


a388 5
	write(6,*) ' Starting reverse fft: ',n2x,n2y,n2z
        tarray = 0
	tm1    = etime(tarray)


a396 4
	tm2 = etime(tarray)
	WRITE(6,*) ' FFT Time: ',tm2-tm1,'   Times: ',tm2,tm1
        CALL FLUSHRESULTS

d486 1
a486 8
      
        REAL               :: DIVBYP1,  DIVBYP2
        REAL               :: X1DIVBYP1,Y1DIVBYP2
        REAL               :: YSQY1DIVBYP2,tm1,tm2,etime
	REAL ::  TARRAY(2) 



a497 5
        DIVBYP1     = 1.0 / PARM1SQ
        DIVBYP2     = 1.0 / PARM2SQ

        X1DIVBYP1 = .25 / X1 / PARM1SQ
        Y1DIVBYP2 = .25 / Y1 / PARM2SQ
d502 1
d504 1
a504 58
        SELECT CASE(IOPT)

        CASE (1)    ! LOW PASS *************************************
C          Can simplify using conditional array subscripts? al nov 2014

        TARRAY = 0
	TM1 = ETIME(TARRAY)

c$omp      parallel do private(j,iy,ysqy1divbyp2,i,ix)
           DO J=1,N2Y
              IY = (J-1)
              IF (IY > NR2) IY = IY - N2Y

              YSQY1DIVBYP2 = FLOAT(IY*IY) * Y1DIVBYP2

              DO I=1,LSD,2
                 IX = (I-1) / 2

                 IF ((FLOAT(IX*IX) * X1DIVBYP1  + 
     &                YSQY1DIVBYP2 ) > 1.0) THEN

                    B(I,   J) = 0.0
                    B(I+1, J) = 0.0
                 ENDIF
              ENDDO
           ENDDO

           GOTO 9999

        CASE (2)    ! HIGH PASS *************************************

c$omp      parallel do private(j,i,iy,ix,ysqy1divbyp2)
           DO J=1,N2Y
              IY = (J-1)
              IF (IY > NR2) IY = IY - N2Y

              YSQY1DIVBYP2 = FLOAT(IY*IY) * Y1DIVBYP2

              DO I=1,LSD,2
                 IX = (I-1) / 2

                 IF ((FLOAT(IX*IX) * X1DIVBYP1  + 
     &                YSQY1DIVBYP2 ) <= 1.0) THEN

                    B(I,  J) = 0.0
                    B(I+1,J) = 0.0
                 ENDIF
              ENDDO
           ENDDO
           GOTO 9999

        END SELECT


        TARRAY = 0
	TM1 = ETIME(TARRAY)

c$omp   parallel do private(j,i,iy,ix,f,f2,fpe,fse,ordt,parmt,
d724 2
a725 2
9999    IF (IOPT == 2 .OR. IOPT == 4 .OR. 
     &      IOPT == 6 .OR. IOPT == 8)   B(1,1) = ZEROTERM
d727 1
a727 4
	TM2 = ETIME(TARRAY)
	WRITE(6,*) ' TIMES: ',TM2,TM1
	WRITE(6,*) ' FILTER TIME: ',TM2-TM1
        CALL FLUSHRESULTS
d1034 4
a1037 6
9999    IF (IOPT == 2 .OR. IOPT == 4 .OR. 
     &      IOPT == 6 .OR. IOPT == 8) THEN
C          RESTORE ZERO TERM FOR HIGH PASS OPTIONS

           B(1,1,1) = ZEROTERM
        ENDIF
@


1.4
log
@cosmetic
@
text
@d71 4
d389 5
d402 4
d495 8
a502 1
        
d514 5
a522 1
        !write(6,*) ' sum1:',sum(b(1:n2x, 1:n2y)),zeroterm
d524 58
a581 1
c$omp  parallel do private(j,i,iy,ix,f,f2,fpe,fse,ordt,parmt,
d801 2
a802 2
        IF (IOPT == 2 .OR. IOPT == 4 .OR. 
     &      IOPT == 6 .OR. IOPT == 8)     B(1,1) = ZEROTERM
d804 4
a807 1
        !write(6,*) ' sum2:',sum(b(1:n2x, 1:n2y))
d1114 6
a1119 4
C       RESTORE ZERO TERM FOR HIGH PASS OPTIONS
        IF (IOPT == 2 .OR. IOPT == 4 .OR. 
     &      IOPT == 6 .OR. IOPT == 8) 
     &     B(1,1,1) = ZEROTERM
@


1.3
log
@cosmetic
@
text
@d224 1
a224 1
C          RAISED SINC WINDOW,    B FACTOR 
@


1.2
log
@cosmetic
@
text
@a100 1
     &   ' 11 - BUTTER. ELLIP LOW-PASS, 12 - BUTTER. ELLIP HIGH-PASS',/,
@


1.1
log
@Initial revision
@
text
@d98 1
a98 1
     &   '  5 - FERMI                    6 - FERMI'             ,/,
d122 18
a139 1
        IF (IOPT == 7  .OR. IOPT == 8) THEN
a220 7
        ELSEIF (IOPT == 5 .OR. IOPT == 6)  THEN
C          FERMI DISTRIBUTION FILTER ****************************

           PARM1 = 0.25
           CALL RDPRM1S(PARM1,NOT_USED,
     &        'FILTER RADIUS (IN FREQUENCY OR PIXEL UNITS)',IRTFLG)
           IF (IRTFLG .NE. 0) RETURN
a221 9
           IF (PARM1 < 0.0 .OR. PARM1T > 1.0) 
     &         PARM1 = 0.5 * PARM1 / (NX/2)     ! RADIUS INPUT

           CALL RDPRM1S(PARM3,NOT_USED,
     &                     'TEMPERATURE (0=CUTOFF)',IRTFLG)

C          EXPONENTIAL FOR HIGH-PASS OPTION
           IF (IOPT == 6) PARM3 = -PARM3
 
d564 1
a564 1
     &                           FLOAT(IY*IY)/Y1)-PARM1) / PARM3
@

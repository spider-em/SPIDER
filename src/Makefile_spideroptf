# 
# PURPOSE: Makefile to create profiling executable for GNU/Linux SPIDER 
#          using FFTW on Opteron 64
#
# USAGE:   make -f Makefile_spideroptpf
#
# USING:   nVidia HPC compiler (formerly Portland Group)
#          Non-native mode byte ordering on:  AMD Opteron GNU/Linux 64 bit OS
#          FFTW must be configured with: --enable-float --enable-type-prefix
#
# NOTE:    You may ignore any undefined QFFLAGS, QLFLAGS & SUFFIX
#
# nVidia HPC compile/link flags
# -O2             : Invokes level 2 optimization (-O3 causes some run time problems with PGI compiler on SPIDER code)
# -mp             : Invokes multi processor support
# -fast           : Selects an appropriate set of optimization flags usually including -O2 -Munroll -Mnoframe
# -mcmodel=medium : Allows use of >2GB data area
# -Bstatic        : Static link

SHELL    = /bin/sh

# Location of PGI Fortran (now nVidia HPC) compiler
COMP    = /opt/nvidia/hpc_sdk/Linux_x86_64/25.7/compilers/bin/nvfortran

PGM      = spider

WHICH    = linux_mp_ryzen4_dynamic_noieee

EXE      = $(PGM)_$(WHICH)$(SUFFIX)

FFLAGS  = -Mpreprocess -tp znver4 -fast -mp -mcmodel=medium -Kieee -Minfo=accel,lre,par,stdpar -byteswapio -DSP_MP -DSP_LIBFFTW3 -c

# Link with multi processor support
LF  = -tp znver4 -fast -mp -mcmodel=medium $(QLFLAGS)

# FFTW library location for  pgi7.1 static
FFTWLIBDIR   = ../fftw/fftw-3.3.10/lib

LIB    = $(EXE).a

AFLAGS = r

# Link with FFTW static libraries with threads and with math library
LINKLIBS  = -Bstatic -L$(FFTWLIBDIR) -lfftw3f -lfftw3f_threads -mp -lm
.PRECIOUS : ../bin/$(EXE) $(LIB) 

include Makefile.inc

include Makebody.inc

clean:
	rm -f *.mod *.MOD *.a

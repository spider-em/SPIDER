<head>
<title>SPIDER: WV P (Window averaging - over Patches)</title>
   <link rel='stylesheet' href='niceman.css' type='text/css' />
   <link rel='stylesheet' type='text/css' href='../buttons.css' />

</head>

<body>
<!-- Begin Buttons -->
<table>
<tr>
  <td><a href="../spider.html"                 id="spider">    </a></td>
  <td><a href="../user_doc.html"               id="work">      </a></td>
  <td><a href="../operations_doc.html"         id="index">     </a></td>
  <td><a href="../documents.html"              id="help">      </a></td>
  <td><a href="../faq.html"                    id="faq">       </a></td>
  <td><a href="../documents.html#2D"           id="techs">     </a></td>
  <td><a href="../techs/recon1a/Docs/mr1.html" id="recon">     </a></td>
  <td><a href="../formats.html"                id="menu">      </a></td>
  <td><a href="../installation.html"           id="install">   </a></td>
  <td><a href="../release.html"                id="new">       </a></td>
  <td><a href="https://spider-em.github.io/Web" id="web"> </a></td> 
</tr>
</table>
<br><hr>
<!-- End Buttons -->

<h2>WV P - Window averaging - over Patches</h2>
<em>(3/2/89)</em><br />
<p>
<dl><dt><strong>PURPOSE</strong>
<p>
<dd>Correlation averaging of crystalline lattices:
[This operation assumes that the first step of correlation
averaging has been completed: use of 'CC' (compute
cross-correlation) and 'PK C' (peak search with center-of-gravity
option) to obtain a ranked list of peak coordinates
indicating the locations of the repeats of the unit cell.]
Partition large raw file into regular patches. Window out
areas from raw file, according to X,Y coordinates in peak
search document file, and sum these separately according to
their patch location. An average is created for each patch.
The resulting stack of "patch averages" is stored in 3-D
format in a single output file. The individual averages
may be retrieved by the operation 'PS Z' (Pick Slice in Z
direction).
Reference: see J. Frank, W. Chiu, and L. Degn,
<I>Ultramicroscopy</I>26 (1988) 345-360.
</dl>
<p>
<dl><dt><strong>SEE ALSO</strong>
<p>
<dd><table><tr><td><a href="wv.html"><strong>WV</strong></a></td><td> [Window averaging]</td></tr>
<tr><td><a href="wvs.html"><strong>WV S</strong></a></td><td> [Window averaging - Sequential document search]</td></tr>
</table></dl>
<p>
<dl><dt><strong>USAGE</strong></dt>
<p>
<dd>.OPERATION: WV P<br />
<p>
<dd>.SCANNED DATA FILE: RAW001<br />
[Enter the name of the large data file to be used as input]
<p>
.AVERAGE FILE: AVE001<br />
[Enter the name of the file where the stack of averages is
to be kept. The file will be opened with a 3-D data format,
where NX, NYW are the dimensions of the data window, to
be specified in the next query, and NZ is the number of
patches to be specified below]
<p>
.WINDOW DIMS NX,NY: 64,64<br />
[Enter the dimensions of the data window to be selected at
each peak location (= dimensions of the average created for
each patch)]
<p>
.PATCH DIMENSIONS: 200,200<br />
[Enter the size of the patch. In order not to loose data
close to the edges of the patch, the following relationship
should be observed in both dimensions:
PATCH SIZE = INCREMENT + WINDOW SIZE]
<p>
.NUMBER OF PATCHES, GENERATE PATCHES?(0/1): 100,1<br />
[Enter the total number, NPATCH, of patches to be used, and
select the way the patches are specified:
GENERATE PATCHES=0: patch coordinates are supplied for NPATCH
patches;
GENERATE PATCHES=1: patch coordinates are generated by the
program based on a regular grid.]
<p>
Option '0':
In this case, NPATCH pairs of numbers must be supplied:
<p>
.INTEGER CORNER COOS OF PATCHES: 10,20 310,20 540,50<br />
540,490 ...
[In each pair, the first number is interpreted as the x
coordinate, the second as y coordinate. The pairs of
numbers may be entered in free format, on consecutive lines
if necessary. The choice of patch positions can be totally
arbitrary.
<p>
Option '1':
In this case, NPATCH pairs of coordinates are generated by
the program according to the INCREMENT specification:
<p>
.STARTING COOS: 10,50<br />
[give the x,y coordinates of the first patch]
<p>
.INCREMENTS X,Y: 136,136<br />
[give the patch position increments in x and y direction.
Beginning with the STARTING COOS, a regular rectangular
grid is created which defines the patches. Patches are
counted from left to right, top to bottom, in the way a
book is read. This means that the average of the top
left patch will be the first slice in the AVERAGE FILE,
the average of the bottom right patch will be stored as
the last slice.]
<p>
<p>
The NUMBER OF PATCHES USED will be printed out, followed
by a list of patch coordinates to be used.
Note that for the GENERATE PATCHES=1 option, the NUMBER
OF PATCHES USED may be different from the NUMBER OF PATCHES
specified earlier, because it is calculated from the
STARTING COOS and INCREMENT coordinates.
<p>
<p>
.DOCUMENT FILE: DOC001<br />
[Enter the name of the document file containing the peak
coordinates. The document file must contain the peak
values in the following sequence: KEY, X, Y, HEIGHT.
In this way they are created by operation 'PK C']
<p>
The following message appears:
<p>
** NUMBER OF PEAKS IN DOCUMENT FILE &lt;NPEAK>
<p>
where &lt;NPEAK&gt; is the number of peaks retrieved from the
Document file. [This number may be different from the
the total number of peaks stored by 'PK C' in the file,
because the peak information is read back into core
using an in-core unsave routine which is currently
limited to 1000 keys.]
<p>
.PEAK VALUES (FROM, TO): 0., 1.4<br />
[this allows the absolute range of peak heights to be
limited. Peaks with values outside this range will be
excluded.]
<p>
.RANGE OF RANKS IN PERCENT (FROM,TO; 100=BEST): 60,100<br />
[enter the rank range, in terms of percentage of total
number of peaks, of peaks to be used. A specification
of 0,0 will cause all peaks to be accepted within the
PEAK VALUES window. It will also cause rank sorting
by decreasing size to be skipped, which will not be
noticed unless the document file was prepared by a
non-standard method (i.e., not by 'PK C').]
<p>
The following message appears:
<p>
** &lt;NPK&gt; PEAKS BETWEEN &lt;THL&gt; AND &lt;THH&gt; READ IN
<p>
where &lt;NPK&gt; is the number of peaks in the absolute value
range (&lt;THL&gt;,THH&gt;) specified above.
<p>
.X-OFFSET, Y-OFFSET: 100,500<br />
[this allows the use of a raw data file that is a portion
of the original file for which the peak list has been
generated. If both are identical, specify 0,0]
<p>
.SCALE FACTOR: 2.<br />
[if the CCF is based on a reduced version of the original
raw data file, the geometric scaling factor has to be
used to re-scale coordinates of the peak positions to the
actual coordinates of the unit cell repeats in the raw
data file. If both CCF and raw data file are on the same
scale, use 1.]
<p>
<p>
Next, the following messages appear: <BR>
<p>
** NUMBER OF PEAKS AFTER COO CHECK = &lt;NPKCK>
<p>
where &lt;NPKCK&gt; is the number of peaks left after the
outside margin of the raw data field has been taken into
account;<BR>
<p>
** NUMBER OF PEAKS WITHIN RANK RANGE = &lt;NPKR><BR>
<p>
where &lt;NPKR&gt; is the number of peaks left after the
additional rank limitation has been applied.
<p>
<p>
.NO. OF PEAKS TO USE, DUMP? (0=NO; 1=YES; 2=FULL): 800,0<br />
[of the &lt;NPKR&gt; peaks left, the highest NPEAK peaks may
be selected. If no selection is requested, specify a
number that is large enough; e.g. the original number
of peaks. The DUMP option is only used for special
debugging purposes. Do not use it, because the amount
of print output may be staggering!]
<p>
At the end of the program run, the following information
is given:<BR>
<p>
** DIMENSION OF CCF WINDOW USED: &lt;NXC&gt;, &lt;NYC&gt; <br />
<p>
where &lt;NXC&gt;, &lt;NYC&gt; are the X and Y dimensions of the
raw data field after edge exclusion;<BR>
<p>
** NUMBER OF WINDOWS IN EACH PATCH<BR>
20 19 20 21 ...
<p>
This number is not necessarily constant because the crystal
grid and the patchwork grid normally "beat" each other.
Another reason would be the existence of poor areas within
the field, which would cause a drop in the number of good
peaks found.
The numbers of windows are printed out for completeness,
because they give an account for changes of statistics
from one patch to the next.
<p>
</dl>
<p>
<dl><dt><strong>SUBROUTINES</strong>
<p>
<dd><a href="../../src/winave2.f">WINAVE2</a>, <a href="../../src/narea.f">NAREA</a></dl>
<p>
<dl><dt><strong>CALLER</strong>
<p>
<dd><a href="../../src/util2.f">UTIL2</a> 
</dl>
</body>
</html>
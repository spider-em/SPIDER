<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8">
   <title>Random-conical tilt reconstruction</title>
</head>

<body lang="en-US" dir="ltr">

<i><p align="right">(Updated 2012 Nov 21)</p></i>

<center><p>
  <font size="5"><b>Random conical tilt reconstruction</b></font>
  <br>Adapted from the 2007 SPIDER Workshop tutorial
  </p>
</center>

<hr />

<b><p>Outline</p></b>
<ul>
	<li>General notes                 </li>
	<li>Quick-start guide             </li>
	<li>Getting started               </li>
	<li>Procedure                     </li>
	<li>Miscellaneous procedure files </li>
	<li>References                    </li>
</ul>

<hr />

<b><p>General notes</p></b>

<ul>
	<li>Sequential operations are numbered. Options are lettered.</li>
	<li>Data extension assumed to be <b>.dat</b>. Adjust accordingly.</li>
	<li>List of inputs and outputs in description is not exhaustive.</li>
</ul>

<hr />

<b><p>Quick-start guide</p></b>
<ol>
	<li>tar -xvf procedures.tar</li>
	<li>spider rct/dat @makeparams (or copy <b>params.dat</b>)</li>
	<li>(optional) tar -xvf $DATA.tar</li>
	<li>mkfilenums.py filenums.dat $MICROGRAPHS*</li>
	<li>(for non-SPIDER format micrographs) spider rct/dat @convert</li>
	<li>spider rct/dat @shrinkmics</li>
	<li>cd Micrographs/ ; montagefromdoc.py ../filenums.dat</li>
	<li>spider rct/dat @micpair</li>
	<li>(required for JWEB) spider rct/dat @padmics</li>
	<li>pick tilt pairs in JWEB or WEB</li>
	<li>spider rct/dat @makesomenoise (or copy <b>noise.dat</b>) </li>
	<li>spider rct/dat @windowparticles</li>
	<li>(for negative stain) Do both of:</li>
		<ol type=a>
			<li>spider rct/dat @highpass-untilted</li>
			<li>spider rct/dat @highpass-tilted</li>
		</ol>
	<li>montagefromdoc.py listparticles.dat Zerodegr/Winrot/unt*</li>
	<li>(if necessary) spider rct/dat @removebad</li>
	<li>montagefromdoc.py listparticles.dat Tilted/Winrot/tilt*</li>
	<li>(if necessary) spider rct/dat @removebad</li>
	<li>(slow) spider rct/dat @pairwise</li>
	<li>(optional) To reorient average, do both of:</li>
		<ol type=a>
			<li>spider rct/dat @reorientavg</li>
			<li>spider rct/dat @sumalign</li>
		</ol>
<!--</ol>
<OL START=13>-->
	<li>spider rct/dat @filtershrink</li>
	<li>spider rct/dat @ca-pca</li>
	<li>Classify.  (Ward's method shown here.  For other options, see below.)</li>
	<ol type=a>
		<li>spider rct/dat @hierarchical</li>
		<li>spider rct/dat @binarytree</li>
		<li>cd Zerodegr/Tree ; ../../tree.py labeled0001.dat 4 selclasses.dat</li>
	</ol>
	<li>Iterate:</li> 
		<ol type=a>
			<li>spider rct/dat @multirefalign (subsequently @multirefalign-descend)</li> 
			<li>spider rct/dat @filtershrink</li> 
			<li>spider rct/dat @classifybyview</li>
			<li>verifybyview.py</li> 
		</ol>
	<li>spider rct/dat @combinegoodclasses</li> 
	<li>spider rct/dat @viewaverages</li> 
	<li>spider rct/dat @centertilt</li>
	<li>spider rct/dat @storeangles</li>
	<li>(optional) spider rct/dat @d6symmetry</li>
	<li>spider rct/dat @bpclass</li>
	<li>spider rct/dat @volfilt</li>
	<li>(if multiple orientations) Do both of: </li>
		<ol type=a>
			<li>spider rct/dat @volalignprj</li>
			<li>spider rct/dat @mergevols</li>
		</ol>
	<li>spider rct/dat @prepare-prjmatch</li>
</ol>

<hr />

<b><p>Getting started</p></b>

<ul>
   <li>Create a new directory, and change to that directory before 
       unpackaging the procedure-file tarball.                                   </li>

   <li>Micrographs should be placed in the <b>Micrographs/</b> directory.  
       They needn't be in SPIDER format, but you'll then need to run
       <a href="convert.rct">convert.rct</a> for the conversion. </li>

   <li>The SPIRE libraries are required for various Python scripts, such as
       <a href="mkfilenums.py">mkfilenums.py</a> and <a href="tree.py">tree.py</a>. 
       These steps can be substituted with SPIRE-independent analogs. 
       Installation instructions for SPIRE can be found 
       <a href="../../../../spiredoc/download.html">here</a>.</li>

<!-- 	<li></li> -->
</ul>

<hr />

<b><p>Procedure</p></b>

<ul>

<li><p>Prepare directory</p></li>
   <ul>
      <li>Access the latest 
          <a href="../tar_archive/archive.html">procedures archive</a> 
          and unpackage it by typing:
          <pre>tar -xvf procedures.tar</pre>
          This command will unpackage the files in the currect directory, 
          so create a new directory if so desired.</li>
   </ul>

<li><p>Prepare parameter doc file</p></li>
   <ul>
      <li>PROCEDURE FILE: <a href="makeparams.rct">makeparams.rct</a> </li>
      <li>OUTPUTS: <b>params</b> </li>
      <li>Otherwise, you can copy a <b>params</b> file from elsewhere.<BR>
          An example file called <b>bak-params</b> is present in the tarball.</li>
      <li>The following parameters (described <a href="../../..//techs/recon/params.html">
          here</a>) are used from the <b>params</b> file:</li>
      <ul>
         <li><b>1</b> -- zip flag -- if set to 1, then will be uncompressed using gunzip</li>
            <ul><li>used by convert.rct</li></ul>
         <li><b>2</b> -- format flag -- 0 corresponds to SPIDER, 3 to Z/I TIFF, etc. -- see 
            <a href="../../..//techs/recon/params.html">
            complete description</a> for additional formats</li>
            <ul><li>used by convert.rct</li></ul>
         <li><b>5</b> -- pixel size -- in Angstroms</li>
            <ul><li>used by shrinkmics.rct</li></ul>
         <li><b>17</b> -- window size -- in pixels </li>
            <ul><li>used by many procedure files</li></ul>
         <li><b>18</b> -- particle diameter -- in pixels</li>
            <ul><li>used by pairwise.rct </li></ul>
         <!-- <li><b>NUMBER</b> -- FLAG -- DESCRIPTION</li>
              <ul><li>used by PROCEDURE</li></ul> -->
              </ul>
   </ul>

<li><p><i>(optional)</i> Copy sample data.</p></li>
   <ul>
      <li>Access the <a href="../tar_archive/data20060817.tar">data archive</a>
          and unpackage it by typing:   </li>
	  <pre>tar -xvf data20060817.tar</pre>
      <li>This command will create a directory called <b>Micrographs/</b>, 
			containing phantom micrographs, and a directory called <b>TP1/</b>,
			containing the files used to generate the micrographs.</li>
   </ul>

<li><p>Generate a list of micrographs.</p></li>
   <ul>
      <li>PYTHON SCRIPT: <a href="mkfilenums.py">mkfilenums.py</a> </li>
      <li>To make a list of TIFF files, for example, the syntax would be: </li>
          <pre>mkfilenums.py filenums.dat Micrographs/zeiss*.tif</pre>
      <li>This Python script requires the Spiderutils library from SPIRE. 
          If SPIRE is not installed, you can generate <b>filenums</b> using other means, 
          such as by manually entering the filenumbers using 
          <a href="../../..//man/doccreate.html">
          'DOC CREATE'</a> in SPIDER. </li>
   </ul>

<li><p><i>(optional)</i> If the micrographs are not already in SPIDER format, convert them.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="convert.rct">convert.rct</a> </li>
		<li>SUBROUTINE: <a href="convert_p.rct">convert_p.rct</a> </li>
		<li>INPUTS: <b>filenums</b>, <b>Micrographs/mic****</b> </li>
		<li>Downstream procedure files will expect files called <b>Micrographs/mic****</b>. 
			Keeping that convention will minimize the number of changes you'll need to make.</li>
		<li>If the micrographs are in Z/I TIFF format, 
			<a href="http://www.wadsworth.org/spider_doc/spider/download/zi2spi.c">zi2spi</a> 
			will be needed. If it is not installed on your system, the compilation instructions 
			are described at the top of the source code.</li>
		<li>TO DO: add conversion flag for MRC files</li>
	</ul>

<li><p>Shrink the micrographs for particle-picking.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="shrinkmics.rct">shrinkmics.rct</a> </li>
		<li>INPUTS: <b>filenums</b>, <b>Micrographs/mic****</b> </li>
		<li>INPUTS: <b>Micrographs/sm-mic****</b> </li>
		<li>Choose the reduction factor such that the micrgraph fits on the screen, 
			or that the particles are visible.  
			These downsampled micrographs will be used to pick tilt pairs.</li>
		<li>The filtration step is slow, so 
			by setting <i>[filter-radius]=0</i>, you can skip this step. </li>
	</ul>

<li><p>Screen micrographs.</p></li>
	<ul>
		<li>Micrographs can be screened using various display programs.
			To use montagefromdoc.py, from <b>Micrographs/</b>
			(there is a pre-existing <b>.montagefromdoc</b> file there), type:
			<pre>montagefromdoc.py ../filenums.dat sm-mic*</pre>
			The output should also be <b>filenums</b>.</li>
		<li>If you wish to remove micrographs by editing <b>filenums</b>
			(instead of with montagefromdoc.py),
			renumber it to have consecutive keys, using 
			<a href="../../..//man/docren.html">
			'DOC REN'</a>. (The input and output can have the same name.) </li>
	</ul>

<li><p>Establish pairings between micrographs</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="micpair.rct">micpair.rct</a> </li>
		<li>INPUTS: <b>filenums</b> </li>
		<li>OUTPUTS: <b>docmicpairs</b> </li>
		<li>This procedure file presumes that the tilted-specimen micrograph precedes the untilted-specimen micrograph.
			Check the output to confirm that the pairings make sense.</li>
	</ul>

<li><p>Resize micrographs (Required for JWEB, not required for X-Window WEB)</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="padmics.rct">padmics.rct</a> </li>
		<li>INPUTS: <b>docmicpairs</b>, <b>Micrographs/sm-mic****</b> </li>
		<li>OUTPUTS: <b>Micrographs/jweb-mic{***[untilted]}</b>, <b>Micrographs/jweb-mic{***[untilted]}_tilted</b> </li>
		<li>JWEB has a "feature" that requires the tilt pair to have the same dimensions. 
			This procedure file pads the micrographs to the same size. 
			Another feature is that JWEB expects the tilted micrograph to be second, 
			even though it is typically collected first at the microscope.</li>
	</ul>

<li><p>Pick tilt pairs (for JWEB, differences for X-Window WEB noted below)</p></li>
	<ul>
	    <li>INPUTS: <b>Micrographs/jweb-mic{***[untilted]}</b>, <b>Micrographs/jweb-mic{***[untilted]}_tilted</b>
	    <p></p></li>
	</ul>
	<OL type='A'>
	    <li>If using JWEB: </li>
		<ol>
			<li>From the <b>Micrographs/</b> directory, open JWEB. </li>
			<li>Go to <i>File -> Open -> Image Series</i> and select a pair of micrographs. 
			    Adjust the contrast as convenient. 
			    Do <U>NOT</U> resize the micrographs using <i>Edit</i> &gt; <i>Resize</i>, 
			    for ease of use with the procedure files below.</li>
			<li>Click on the <i>Markers/Tilt Pair</i> tab.</li>
			<li>In the <i>Marker File Number</i> field, enter the number of the untilted micrograph.</li>
			<li>Click on the <i>Show/Edit Marker</i> button, which will display the images.</li>
			<li>Select a particle from the untilted micrograph, and 
				the corresponding particle from the tilted micrograph.
				Repeat this for at least four particles, 
				separated as far as possible in the micrograph, 
				ideally in the four corners, but the farther apart the better. 
				<BR><i>HINT:</i> The middle mouse button will erase a pair of points 
				if you make a mistake, or if JWEB becomes confused..
				<BR><i>HINT:</i> Since the numbering is to the right of the marker, 
				it may be easier to proceed from right to left.</li>
			<li>Click on buttons <i>Save Marker Files</i> and <i>Determine Theta</i>, 
				which will determine the magnitude of the tilt angle between the micrographs.</li>
			<li>Click on the <i>Fit Angles</i> button.
				This will determine the direction of the tilt axis.</li>
			<li>Click on the <i>Draw Fitted Locations</i> button.
				This will slightly adjust the locations of the fitted coordinates according to the fitting above, 
				but does not affect the coordinates selected with the mouse.</li>
			<li>Click on the <i>Save Angles</i> button.</li>
			<li>Now, when you select a particle in the untilted image, 
				JWEB will send the cursor to the corresponding location in the tilted image.</li>
			<li>Select more particles from the tilt pair. 
				(For the sample micrograph, there are 76 pairs.  Select all of them.)</li>
			<li>To save the new values, re-click the five buttons: <i>Save Marker Files</i>, <i>Determine Theta</i>, 
				<i>Fit Angles</i>, <i>Draw Fitted Locations</i>, and <i>Save Angles</i>.</li>
		</ol>
	    <li>If using X-Window WEB: </li>
		<ol>
		    <li>From the menu, select <i>COMMANDS</i> &gt; <i>Tilted Particles</i>, 
		        and select first the untilted-specimen image (which is normally collected second) 
		        and then the tilted-specimen image.  </li>
		    <li>In the <i>Particle doc</i> popup window, under <i>Doc file number</i>, 
		        enter the number of the untilted micrograph and click <i>ACCEPT</i>.</li>
		    <li>Select a particle from the untilted micrograph, and 
			the corresponding particle from the tilted micrograph.
			Repeat this for at least four particles, 
			separated as far as possible in the micrograph, 
			ideally in the four corners, but the farther apart the better.</li>
		    <li>Click the middle button to open the <i>Particle picking menu_popup</i>.</li>
		    <li>Click on <i>Determine tilt axis angles</i>, <i>Draw fitted locations</i>, 
		        and <i>Save angles in doc file</i>.</li>
		    <li>Now, when you select a particle in the untilted image, 
			WEB will send the cursor to the corresponding location in the tilted image.</li>
		    <li>Select more particles from the tilt pair. 
			(For the sample micrograph, there are 76 pairs.  Select all of them.)</li>
		    <li>To save the new values, re-click the three buttons: <i>Determine tilt axis angles</i>, 
		        <i>Draw fitted locations</i>, and <i>Save angles in doc file</i>.</li>
		    <li>Differences between JWEB and X-Window WEB:</li>
			<ul>
			    <li>X-Window WEB does not require the pair of micrographs to be the same size, 
				so the step <a href="padmics.rct">padmics.rct</a> is unnecessary. </li>
			    <li><U>WARNING</U>: If you entered a number under <i>Image reduction factor</i>
				(after setting the reduction factor in <i>OPTIONS</i> &gt; <i>Image</i>)
				do <U>NOT</U> set the parameter <i>[decimation-factor]</i> below in 
				<a href="windowparticles.rct">windowparticles.rct</a>. 
				Using both parameters will be redundant.</li>
			    <li>There is no <i>Save Marker Files</i> button.
				Coordinates are saved continuously.</li>
			    <li><i>Determine Theta</i> and <i>Fit Angles</i> are merged into one button: 
				<i>Determine tilt axis angles</i>.</li>
			</ul>
		</ol>
	</ol>
	<ul>
	    <li><i>HINT:</i> Save the coordinates frequently. 
		JWEB gets confused from time to time, 
		and the main console window will show which particles have it confused. 
		Delete those particles (using the middle mouse button), and re-pick them, as necessary.</li>
	    <li><i>HINT:</i> If, while picking pairs, the fitted locations stray from the correct location 
		(which could be the case if earlier fittings were done using a limited area, or 
		if the support film deviates from flatness), 
		it may help to re-do the fitting (summarized under the previous bullet).</li>
	    <li><i>HINT:</i> If you close a pair or micrographs and re-open them
		(with the appropriate <i>Marker File Number</i>), 
	    you can resume from where you left off.</li>
	</ul>

<li><p>Obtain a noise image for normalization.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="makesomenoise.rct">makesomenoise.rct</a> </li>
		<li>INPUTS: a micrograph </li>
		<li>OUTPUTS: <b>noise</b>, <b>tmpnoise/noi***</b> </li>
		<li>Subsequent windowed images will be normalized against the output noise file.
			If you have a pre-existing noise file, copy it to <b>noise.dat</b></li>
		<li>One noise file will be chosen at random by the procedure file.
			You can also look at the noise images in the <b>tmpnoise/</b> directory
			and copy one that looks even "noisier" to <b>noise.dat</b>
			(in the top-level directory).</li>
	</ul>

<li><p>Window particles from tilted and untilted micrographs.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="windowparticles.rct">windowparticles.rct</a> </li>
		<li>PARAMETER: <i>[decimation-factor]</i> -- If you used the output of 
		    <a href="shrinkmics.rct">shrinkmics.rct</a> and/or 
		    <a href="padmics.rct">padmics.rct</a>, use that value here. 
		    If you used the full-sized micrographs, use the value used under 
		    <i>Edit</i> &gt; <i>Resize</i> (for JWEB) or 
		    <i>Image reduction factor</i> (for X-Window WEB). 
		    Ultimately, this parameter needs to be the factor between 
		    the full-sized micrograph and the version used for particle-selection.</li>
		<li>INPUTS: <b>params</b>, <b>docmicpairs</b>, <b>noise</b>,
			<b>Micrographs/mic****</b>, <b>Micrographs/dcu****</b>, <b>Micrographs/dct****</b></li>
		<li>OUTPUTS: <b>listparticles</b>,
			<b>Zerodegr/Winrot/unt*****</b>, <b>Tilted/Winrot/tilt*****</b> </li>
	</ul>

<li><p>(Recommended for stained images) High-pass filter windowed images</p>
    
    <p>For negatively-stained images, it is often the case that the puddle of stain surrounding the particles 
    dominates the classification (although maybe not the case for deep-stained specimens).  
    In this case, it may be helpful to high-pass filter the images using a filter radius 
    larger than the size of your particle.  If the filter radius is too fine however, 
    the aligning power of the images will be lost.  You may need to tweak the radii.</p> 
    
    <p>If you are unsure whether to do this step, feel free to skip it, 
    but look at the reconstituted images when you run <a href="ca-pca.rct">ca-pca.rct</a> 
    in order to see if the stain is the predominant source of variation. </p> </li>
	<ol>
	    <li>PROCEDURE FILE: <a href="highpass-untilted.rct">highpass-untilted.rct</a></li>
	    <ul>
		<li>INPUTS: <b>Zerodegr/Winrot/unt*****</b> (directory renamed to <b>Unhighpass</b></li>
		<li>OUTPUTS: <b>Zerodegr/Winrot/unt*****</b> </li>
	    </ul>
	    <li>PROCEDURE FILE: <a href="highpass-tilted.rct">highpass-tilted.rct</a></li>
	    <ul>
		<li>INPUTS: <b>Tilted/Winrot/tilt*****</b> (directory renamed to <b>Unhighpass</b></li>
		<li>OUTPUTS: <b>Tilted/Winrot/tilt*****</b> </li>
	    </ul>
	</ol>

<li><p>Screen the windowed images for defects (micrograph edges, dust, etc.).</p></li>
	<ul>
		<li>Screen the untilted--specimen windowed images by running
		<a href="../../..//techs/verify/VerifyDocs/montagefromdoc.htm">
		montagefromdoc.py</a>, using the following command:
			<pre>montagefromdoc.py listparticles.dat Zerodegr/Winrot/unt*</pre>
		Use <b>notgood</b> as the output doc filename.<BR></li>
		<li>Only click on the bad images.
			For the untilted-specimen images, the particle-selection need not be stringent. 
			There will be additional rounds of selection downstream.</li>
		<li>If particles are rejected, run: <a href="removebad.rct">removebad.rct</a> </li>
		<ul>
		    <li>INPUTS: <b>listparticles</b> (will be backed up by <a href="backup.rct">backup.rct</a>), <b>notgood</b> </li>
		</ul>
		<li>Now screen the tilted images for defects:</li>
			<pre>montagefromdoc.py listparticles.dat Tilted/Winrot/tilt*</pre>
		<li>Only click on the bad images.
			For the tilted images, this will be the only opportunity to weed out bad particles --
			such as dust, edges, double-particles, etc. -- so be more stringent here.</li>
		<li>If tilted particles are rejected, re-run <a href="removebad.rct">removebad.rct</a></li>
	</ul>

<li><p>Align the untilted-specimen particles using reference-free alignment.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="pairwise.rct">pairwise.rct</a> </li>
		<li>INPUTS: <b>listparticles</b>, <b>Zerodegr/Winrot/unt*****</b> </li>
		<li>OUTPUTS: <b>Zerodegr/Pairwise/rfreeavg001</b>, <b>Zerodegr/Aligned/cenu*****</b>, 
			<b>Zerodegr/Pairwise/docpairalign</b>, many others </li>
		<li>This procedure file first aligns pairs of images, averages them, 
			then aligns the average of pairs, etc.
			The first level ("depth") will be slow, 
			and each subsequent level will be faster.</li>
	</ul>

<li><p><i>(optional)</i> Attempt to align average along coordinate axes</p></li>
	<ol>
	    <li>Align average along coordinate axes
		<ul>
		    <li>PROCEDURE FILE: <a href="reorientavg.rct">reorientavg.rct</a> </li>
		    <li>INPUTS: <b>Zerodegr/Pairwise/rfreeavg001</b> </li>
		    <li>OUTPUTS: <b>Zerodegr/Pairwise/dsolalign</b>, <b>Zerodegr/Pairwise/malign</b> </li>
		    <li>This procedure file aligns the average to a mirrored version of itself, 
			    in an attempt to orient the major axis of the particle along the coordinate axes.
			    There will be two solutions, along <i>x</i> or along <i>y</i>. 
			    It is arbitrary which one to choose.  
			    If you wish to reorient the particles to either of these averages, 
			    note which solution to use (1 or 2), and run the next procedure file, 
			    <a href="sumalign.rct">sumalign.rct</a>.</li>
		</ul>

	    <li>Combine alignments of individual particles with reoriented average</li>
		<ul>
			<li>PROCEDURE FILE: <a href="sumalign.rct">sumalign.rct</a> </li>
			<li>PARAMETER: solution 1 or 2 (see description below) </li>
			<li>INPUTS: <b>Zerodegr/Winrot/unt*****</b>, <b>Zerodegr/Pairwise/dsolalign</b>, 
				<b>Zerodegr/Pairwise/docpairalign</b> </li>
			<li>OUTPUTS: <b>Zerodegr/Pairwise/dalu001</b>, <b>Zerodegr/Aligned/cenu*****</b>, 
				<b>Zerodegr/Pairwise/avgu001</b> </li>
			<li>If you wish to apply the alignments of the average from
				<a href="reorientavg.rct">reorientavg.rct</a>, then run this procedure file.  
				Note which solution you would like to apply (1 or 2). 
				Typically, in one solution the major axis is along <i>x</i>.
				and in the other it is along <i>y</i>.
				It is arbitrary which solution to use.</li>
		</ul>
	</ol>

<li><p>Filter the aligned, untilted particles.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="filtershrink.rct">filtershrink.rct</a> </li>
		<li>PARAMETERS: reduction factor, low-pass filter parameters </li>
		<li>INPUT: <b>Zerodegr/Aligned/cenu*****</b></li>
		<li>OUTPUT: <b>Zerodegr/Filtered/flt*****</b> </li>
		<li>Remember to change the input filename if you ran <a href="sumalign.rct">sumalign.rct</a>. </li>
		<li>The filtered images produced will be used for multivariate data analysis and classification.
			To look at the filtered untilted particles, type: </li>
			<pre>montagefromdoc.py listparticles.dat Zerodegr/Filtered/flt*</pre>
	</ul>

<li><p>Run correspondence analysis (CA) or principal component analysis (PCA) on filtered images.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="ca-pca.rct">ca-pca.rct</a> </li>
		<li>PARAMETERS: </li>
			<ul>
				<li><i>flag for CA (1), PCA (2), or iterative PCA (3)</i> --
					One method or another sometimes crashes due to "numerical inaccuracy."
						I, subjectively, try CA first, then iterative PCA, then PCA last.</li>
				<li><i>number of factors to calculate</i> --
					If after you run this procedure file, 
					all of the eigenimages look meaningful,
					increase this parameter and re-run.</li>
			</ul>
		<li>INPUT: <b>Zerodegr/Filtered/flt*****</b> </li>
		<li>OUTPUT: <b>Zerodegr/MSA/cas_***</b>, <b>Zerodegr/MSA/reconstituted***</b>, others </li>
		<li>The commands to generate the PostScript eigenvalue histogram requires the SPIRE Python libraries.
		    Installation instructions for SPIRE can be found 
		    <a href="../../../../spiredoc/download.html#FullInstall">here</a>.</li>
		<li>For negatively-stained samples, when looking at the reconstituted images, 
		    if it appears that the stain distribution is the greatest source of variation, 
		    go back to the high-pass filtration step above.</li>
	</ul>

<li><p>Classify images. Chose one of:</p></li>
	<ol type=a>
		<li>K-means clasification. </li>
		<ul>
			<li>PROCEDURE FILE: <a href="kmeans.rct">kmeans.rct</a> </li>
			<li>PARAMETERS:</li>
				<ul>
					<li><i>desired number of classes</i> --
						Too small a number, and dissimilar particles will be grouped together, 
						and too large a number, and the class averages will be noisy. 
						I typically use a number that doesn't produce classes 
						whose montage doesn't fit on the screen, i.e., 
						one class per 50 to 75 particles.</li>
					<li><i>number of factors to use</i> --
						choose this number based on the appearance of the eigenimages 
						and the strength of the factors (based on the histogram). 
						Use of the weaker factors will probably not make a big difference though.</li>
				</ul>
			<li>INPUTS: <b>Zerodegr/MSA/cas_***</b>, <b>Zerodegr/Filtered/flt*****</b> </li>
			<li>OUTPUTS: <b>classavg***</b>, <b>docclass****</b>, others </li>
		</ul>

		<li>Hierarchical classification, using Ward's method. </li>
		<ol>
			<li>Run classification. </li>
			<ul>
				<li>PROCEDURE FILE: <a href="hierarchical.rct">hierarchical.rct</a> </li>
				<li>PARAMETER: <i>number of factors to use</i> --
					choose this number based on the appearance of the eigenimages 
					and the strength of the factors (based on the histogram). 
					Use of the weaker factors will probably not make a big difference though.</li>
				<li>INPUTS: <b>Zerodegr/MSA/cas_***</b> </li>
				<li>OUTPUTS: <b>docdendro</b> </li>
			</ul>

			<li>Generate class averages. Choose one of:</li>
			<ol type=a>
				<li>Generate binary tree using tree.py</li>
				<ul>
					<li>PROCEDURE FILE: <a href="binarytree.rct">binarytree.rct</a> </li>
					<li>SUBROUTINES: averagenode.rct, update_lut.rct </li>
					<li>PARAMETER: <i>ending depth</i> --
						For the depth that you specify here, there will be up to 2^<i>depth</i> averages generated. 
						For high values, the averages may be too noisy to be useful. 
						It is better to make too many and display fewer in the next step.</li>
					<li>INPUT: <b>docdendro</b> </li>
					<li>OUTPUTS: <b>avgnode***</b>, <b>labeled***</b> </li>
					<li>NOTE: The format of SPIDER's dendrogram doc file changed in version 17.13. 
						Previous the top two branches had height 1, whereas now, it's 100. 
						If this procedure file crashes, check this parameter.</li>
					<li>To view the binary tree, run <A HREF="tree.py">tree.py</A>. It requires 
						<A HREF="../../..//python/spipylib/code/Spiderutils.html">
						Spiderutils.py</A> from the 
						<A HREF="../../../../spiredoc/packages.html">
						SPIRE</A> installation. Options for the program are described 
						<a href="../../..//techs/MSA/index.htm">
						here</a>. Briefly, an example of the syntax is:
						<pre>cd Zerodegr/Tree ; tree.py labeled0001.dat 4 selclasses.dat</pre>
						Save the selection file with <i>CTRL-s</i>.<p></p></li>
				</ul>

				<li>Generate binary tree as (large) SPIDER image</li>
				<ul>
					<li>Alternatively, you can run <a href="tree.rct">tree.rct</a>,
						which creates a large image in SPIDER format. 
						Be aware that the image becomes unwieldy for large trees. 
						If you choose this option, you may wish to copy the file to another format
						and view it in a dedicated image-viewer.</li>
				</ul>

				<li>Simple class averages</li>
				<ul>
					<li>This option is equivalent to the bottom row in the binary tree above, 
						or the display in WEB, and similar to simple K-means.</li>
					<li>PROCEDURE FILE: <a href="classavg.rct">classavg.rct</a> </li>
					<li>PARAMETER: <i>desired number of classes</i></li>
					<ul>
					</ul>
						<li>Too small a number, and dissimilar particles will be grouped together, 
							and too large a number, and the class averages will be noisy. 
							I typically use a number that produces no classes 
							whose montage doesn't fit on the screen, i.e., 
							one class per 50 to 75 particles.</li>
						<li>If you're going to run <a href="binarytree.rct">binarytree.rct</a>
							next, the necessary class averages will be generated there.  
							So, it doesn't matter how many classes you request here.</li>
					<li>INPUTS: <b>Zerodegr/Hierarchical/docdendro</b>
					    (other classification options write <b>docdendro</b> in different locations)</li>
					<li>OUTPUTS: <b>classavg***</b>, <b>docclass****</b>, <b>listclasses</b>, others </li>
				</ul>
			</ol>
		</ol>

		<li>Clustering using Diday's method. </li>
		<ol>
			<li>Run classification. </li>
			<ul>
				<li>PROCEDURE FILE: <a href="cluster.rct">cluster.rct</a> </li>
				<li>PARAMETER: <i>number of factors to use</i> --
					choose this number based on the appearance of the eigenimages 
					and the strength of the factors (based on the histogram). 
					Use of the weaker factors will probably not make a big difference though.</li>
				<li>INPUTS: <b>Zerodegr/MSA/cas_***</b> </li>
				<li>OUTPUTS: <b>docdendro</b> </li>
			</ul>

			<li>Generate class averages. </li>
			<ul>
				<li>PROCEDURE FILE: <a href="classavg.rct">classavg.rct</a> </li>
				<li>PARAMETER: <i>desired number of classes</i> --
						Too small a number, and dissimilar particles will be grouped together, 
						and too large a number, and the class averages will be noisy. 
						I typically use a number that produces no classes 
						whose montage doesn't fit on the screen, i.e., 
						one class per 50 to 75 particles.</li>
				<li>INPUTS: <b>docdendro</b> </li>
				<li>OUTPUTS: <b>classavg***</b>, <b>docclass****</b>, <b>listclasses</b>, others </li>
				<li>I haven't been able to make this compatible with 
					<a href="binarytree.rct">binarytree.rct</a>,
					so for now, it's functionally equivalent to K-means.</li>
			</ul>
		</ol>

	</ol>

<li><p>Select unique classes.</p></li>
	<ul>
		<li>The classes selected will be used for multireference alignment. 
			It isn't vital to verify indivudual particles yet.
			This step will depend on which classification method you used, 
			i.e., hierarchical, K-means, or Diday's.
			The <b>.verifybyview</b> file included in the tarball 
			<li>Included in the tarball is a starting <b>.verifybyview</b> file to use. 
				If not using 
				<a href="../../..//techs/verify/VerifyDocs/interface.htm">
				verifybyview.py</a>, call the output class-selection doc file <b>selclasses</b>.</li>
		<ol type=a>
			<li>To view+select the averages from K-means, type:</li>
				<pre>verifybyview.py Zerodegr/Kmeans/listclasses.dat</pre>
			<li>To view+select the averages from hierarchical classification, use one of the following:
				<pre>verifybyview.py Zerodegr/Hierarchical/listclasses.dat</pre>
				
				<U>OR</U> (if you ran <a href="binarytree.rct">binarytree.rct</a>):</li>
				<pre>cd Zerodegr/Tree ; tree.py labeled0001.dat 5 selclasses.dat</pre>
			<li>To view+select the averages from Diday's method, type:</li>
				<pre>verifybyview.py Zerodegr/Cluster/listclasses.dat</pre>
		</ol>
		<li>For verifybyview.py, the filenames at the initial dialog are:</li>
			<ul>
				<li><b>listclasses</b> -- can be specified on the command line </li>
				<li><b>classavg***</b> -- class-average template </li>
			</ul>
		Subsequent filenames are:
			<ul>
				<li><b>Zerodegr/Filtered/flt*****</b> -- particle template </li>
				<li><b>selclasses</b> -- list of selected classes </li>
				<li><b>byhand***</b> -- selected particles in a given class</li>
			</ul>
	</ul>

<li><p>Run multireference alignment.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="multirefalign.rct">multirefalign.rct</a> </li>
		<li>PARAMETERS, notable ones include: </li>
		  <ul>
		    <li><i>[cg-option]</i> -- if this is set to 1 (the default), 
		        center of gravity for each reference is computed using 
		        <a href="../../..//man/cgph.html">'CG PH'</a>. 
		        Using negative-stain data, this option may not work well.  
		        You can look at the <b>Zerodegr/Multiref/ref***</b> files while the 
		        (slow) multi-reference alignment is running to check.</li>
		    <li><i>[mirror-option]</i> -- if this is set to 0 (the default), 
		        experimental images are NOT compared to mirrored references.  
		        (I couldn't find an obvious real-life case where particles were flipped by exactly 180 degrees, 
		        but a pseudo-two-fold in the grid plane caused some confusion. 
		        Using phantom data, checking mirrored references seems to work, 
		        for what it's worth.)  In the worst-case scenario --
		        if this parameter is kept at 0, but you do have 180-degree-flipped particles -- 
		        the flipped particles will simply form a distinct class, and
		        separate reconstructions are computed downstream for each class.
		        </li>
		  </ul>
		<li>INPUTS: <b>selclasses</b>, <b>docclass****</b>, 
			<b>Zerodegr/Aligned/cenu*****</b>, <b>Zerodegr/Winrot/unt*****</b> </li>
		<li>OUTPUTS: <b>Zerodegr/Multiref/ref***</b>, <b>Zerodegr/Multiref/docalign</b>, 
			<b>Zerodegr/Multiref/selview***</b>, <b>Zerodegr/Aligned/cenu*****</b>, 
			<b>Zerodegr/Multiref/viewavg***</b></li>
		<li>This procedure file takes the class averages selected in the previous step, 
			re-centers them, and uses these for multireference alignment.</li>
		<li>Be sure that the label <i>[old_class_dir]</i> the procedure file 
			corresponds to the method use to select classes.
			For example, by default this label is set to <b>Zerodegr/Tree</b>,
			the location of the outputs of <a href="binarytree.rct">binarytree.rct</a>.</li>
	</ul>

<li><p>Re-filter aligned images.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="filtershrink.rct">filtershrink.rct</a> </li>
		<li>PARAMETERS: reduction factor, low-pass filter parameters </li>
		<li>INPUT: <b>Zerodegr/Aligned/cenu*****</b></li>
		<li>OUTPUT: <b>Zerodegr/Filtered/flt*****</b> </li>
	</ul>

<li><p>Classify the particles assigned to each reference.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="classifybyview.rct">classifybyview.rct</a> </li>
		<li>PARAMETERS:</li>
			<ul>
				<li>reduction factor</li>
				<li>flag for CA (1), PCA (2), or IPCA (3)</li>
				<li>number of factors to use</li>
			</ul>
		<li>INPUTS: <b>Zerodegr/Multiref/listrefs</b>, <b>Zerodegr/Multiref/ref***</b>, 
			<b>Zerodegr/Multiref/selview***</b>, <b>Zerodegr/Filtered/flt*****</b> </li>
		<li>OUTPUTS: <b>Zerodegr/Multiref/View***/listclasses</b>, 
			<b>Zerodegr/Multiref/View***/classavg***</b>, 
			<b>Zerodegr/Multiref/View***/docclass***</b> </li>
		<li>This procedure file performs a separate classification 
			for the particles assigned to each reference.
	</ul>

<li><p>Check the classification results.</p></li>
	<ul>
		<li>Check the classes with the following command:</li>
			<pre>verifybyview.py Zerodegr/Multiref/View001/listclasses.dat</pre>
			The initial filenames are:
				<ul>
					<li><b>listclasses</b> -- specified on the command line </li>
					<li><b>classavg***</b> -- class-average template </li>
				</ul>
			Subsequent filenames are:
				<ul>
					<li><b>Zerodegr/Filtered/flt*****</b> -- particle template </li>
					<li><b>selclasses</b> -- list of selected classes </li>
					<li><b>byhand***</b> -- selected particles in a given class </li>
				</ul>
		<li>If all of the class averages under a particular reference look the same, 
			proceed to the next solid bullet ("Verify individual particles from last iteration of multireference alignment.").</li>
		<li>If there are homogeneous subsets under a particular reference, 
			then select them in verifybyview.py, using right-click. 
			Don't forget to save the good-class list for each view, 
			under <i>File -&gt; Save selection</i>.
		<li>There is no need to select similar-looking class averages, 
			which would then be used as separate references, but 
			if there are important variations, it might be useful to include both.
		<li>Re-run the last three steps, <i>i.e.</i>:</li>
			<ol>
				<li><a href="multirefalign-descend.rct">multirefalign-descend.rct</a> 
					-- a copy of <a href="multirefalign.rct">multirefalign.rct</a>
					The following filenames/parameters are changed:</li>
					<ul>
						<li>Input <i>OLD_CLASS_DIR</i> is now the previous 
							multireference alignment directory, e.g., <b>Multiref</b></li>
						<li>Output <i>MULTIREF_DIR</i> is now the new directory, 
							for example <b>Multiref2</b></li>
						<li>The parameter <i>[subdir-flag]</i> set to <i>1</i> will serve as a flag 
							to look in the <b>View***</b> subdirectories for the class averages
							for subsequent runs.</li>
					</ul>
				<li><a href="filtershrink.rct">filtershrink.rct</a></li>
				<li><a href="classifybyview.rct">classifybyview.rct</a> -- 
				    Input <i>CLASS_DIR</i> is now the new 
				    multireference alignment directory, <i>e.g.</i>, <b>Multiref2</b></li>
			</ol>
		<li>Repeat these three steps as many times as necessary,
			changing directory names as necessary,
			to obtain relatively homogeneous populations per view. 
			A procedure file <a href="multirefalign3.rct">multirefalign3.rct</a> is included, which is 
			literally identical to <a href="multirefalign-descend.rct">multirefalign-descend.rct</a> 
			except for the input and output directory names.  </li>
	</ul>

<li><p>Verify individual particles from last iteration of multireference alignment.</p></li>
	<ul>
		<li>Type the following (assuming you performed 2 rounds of multi-reference alignment):</li>
			<pre>verifybyview.py Zerodegr/Multiref2/View001/listclasses.dat</pre> 
		<li>INPUTS: <b>listclasses</b>, <b>classavg***</b>, <b>docclass***</b>, <b>Zerodegr/Filtered/flt*****</b> </li>
		<li>OUTPUTS: <b>selclasses</b>, <b>byhand***</b> </li>
		<li>At this point, we will keep only good particles.
			Exclude particles that do not resemble the class average.
			Indivudal particles are sorted from best correlation to worst.
			A more thorough description of 
			<a href="../../..//techs/verify/VerifyDocs/interface.htm">
				verifybyview.py can be found here</a></li>
		<li>In the example above, 
			I assume two iterations of classification and multireference alignment.
			If more or fewer iterations were needed,
			change the corresponding multireference-alignment directory name above.</li>
		<li><i>HINT:</i> Don't forget to save the good-class list in verifybyview.py. 
			It is located in the class-average window under <i>File/SaveSelection</i>. 
			The keyboard shortcut, alternatively, is <i>ALT-s</i>. </li>
	</ul>

<li><p>Combine selected particles from classes.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="combinegoodclasses.rct">combinegoodclasses.rct</a> </li>
		<li>INPUTS (assuming again that you performed 2 rounds of multi-reference alignment): </li>
			<ul>
				<li><b>Zerodegr/Multiref2/listrefs</b> </li>
				<li><b>Zerodegr/Multiref2/View***/selclasses</b> </li>
				<li><b>Zerodegr/Multiref2/View***/byhand***</b> (or <b>Zerodegr/Multiref2/View***/docclass****)</b> </li>
			</ul>
		<li>OUTPUTS: <b>Zerodegr/Multiref2/View***/goodsel</b> </li>
		<li>This procedure files creates one list of particles for each reference view.</li>
		<li>In the example above, 
			I assume two iterations of classification and multireference alignment.
			If more or fewer iterations were needed,
			change the corresponding multireference-alignment directory name above.</li>
		<li><i>HINT:</i> It may be useful to re-classify only the good particles, 
			if, for example, there's an asymmetry present that is washed out by the bad particles.  
			In that case, re-run classifyview using <b>goodsel***</b> instead of <b>selview***</b>.
			Change the output filenames, so that they don't overwrite previous classification output, 
			e.g., add <i>good</i> to the beginning of the filenames. 
			If you find a new class, using the names of the new doc files, re-run
			<a href="multirefalign-descend.rct">multirefalign-descend.rct</a>. 
			It may be useful to classify the bad particles too.</li>
	</ul>

<li><p>Average selected images</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="viewaverages.rct">viewaverages.rct</a></li>
		<li>SUBROUTINE: <a href="viewaverage1.rct">viewaverage1.rct</a></li>
		<li>INPUTS: <b>Zerodegr/Aligned/cenu*****</b>, <b>Zerodegr/Multiref2/goodsel***</b>    
		    (assuming again that you performed 2 rounds of multi-reference alignment)</li>
		<li>OUTPUTS: <b>goodavg***</b>, <b>goodvar***</b> </li>
	</ul>

<li><p>Center tilted-specimen particles.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="centertilt.rct">centertilt.rct</a> </li>
		<li>PARAMETERS: center-of-gravity option (see NOTE below), 
		    filter parameters (see NOTE below)</li>
		<li>INPUT: <b>Tilted/Winrot/tilt*****</b> </li>
		<li>OUTPUTS: <b>Tilted/Aligned/cent*****</b>, <b>Tilted/dalt001</b>, 
			<b>Tilted/avgt001</b> </li>
		<li>This step is straightforward relative to the alignment of the untilted particles. 
			All we are doing here is centering the tilted particles.
			For the three Euler angles needed for backprojection, 
			one is derived from the rotation angle of the untilted images, 
			and the other two are determined by the geometry of the tilt pair.</li>
		<li>To look at the centered tilted particles, type: </li>
			<pre>montagefromdoc.py listparticles.dat Tilted/Aligned/cent*</pre>
		<li>If this procedure file runs slowly, you can save time by centering only the selected particles.  
			To do this, change the input <b>listparticles</b> to <b>Zerodegr/Multiref#/combinedgood</b> 
			from the appropriate directory, <i>i.e.</i>, <b>Multiref</b>, <b>Multiref2</b>, etc.</li>
		<li>NOTE: To center the average after reference-free alignment (translation only), 
		    <a href="../../..//man/cgph.html">
		    'CG PH'</a> is used as the default.  However, as noted in the documention, 
		    'CG PH' sometimes fails.  As an alternative, a section option is available, 
		    which rotates the average by 180 degrees and aligns this to the unrotated average.  
		    This option is used by setting parameter <i>[cg-option]</i> to 2.  
		    If neither option 1 nor 2 work well, setting <i>[cg-option]</i> will not 
		    attempt to center the average.  
		    Be sure to inspect the average to ensure that is is centered.</li>
		<li>NOTE: Low-pass filtration of the images seems to help the 
		<a href="../../..//man/apsa.html">
		    'AP SA'</a> command.  A strong filter is not needed; feel free to experiment.  
		    The filter is applied to temporary, intermediate images; 
		    The final, centered images will be unfiltered.
		</li>
	</ul>

<li><p>Store Euler angles.</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="storeangles.rct">storeangles.rct</a> </li>
		<li>PARAMETER: <i>[mirror-yn]</i> (see NOTE below)</li>
		<li>INPUTS: <b>docalign</b>, <b>Micrographs/dcb****</b> </li>
		<li>OUTPUTS: <b>Tilted/dang-store</b> </li>
		<li>Use the most recent aligment doc file for the untilted images, 
			e.g., <b>Zerodegr/Multiref2/docalign</b>.</li>
		<li>NOTE: Changing parameter <i>[mirror-yn]</i> will reverse the handedness of the structure. 
		    Whether this flag should be set to 0 or 1 depends on numerous variables in the data collection and processing, 
		    such as the direction in which the goniometer is rotated, how the micrographs are digitized, etc. 
		    Unfortunately, it is difficult to determine from first principles whether the handedness needs to be flipped, 
		    so the safest way to know how to set this parameter is to generate a reconstruction of a sample with known handedness.  
		    Once the data-collection/image-processing conventions are set, change them as seldom as possible, or else 
		    you may need to re-test for flips in handedness.</li>
		<li><p>This procedure file stores the three Euler angles in a doc file to use in the backprojection.
		    Assuming the direction of the tilt axes is similar in all of your tilt pairs, 
		    the displayed tilt parameters <U>SHOULD</U> be similar to each other.  
		    However, during the fitting of the angular parameters during tilt-pair picking, 
		    there is a possibility that equivalent (as far as the fitting is concerned) solutions are chosen inconsistently. </p>
		    
		    <p>For example, in the sample RCT data in the 
		    <a href="../../..//protocol_download.html">Nature Protocols download</a>, 
		    the tilt axes are approximately 0.  
		    It is possible for the fitted tilt-axis angle determined by WEB or JWEB to be 0 to -180 degrees.  
		    
		    </p>
		    </li>
	</ul>

<li><p>Compute 3D reconstructions</p>
    
    <p>This step will compute 3D reconstructions for each class, 
    as classified in the last iteration of multi-reference alignment. </p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="bpclass.rct">bpclass.rct</a> </li>
		<li>INPUTS: <b>Zerodegr/Multiref2/listrefs</b>, <b>Zerodegr/Multiref2/goodsel***</b>, 
		    <b>Tilted/dang-store</b>, <b>Tilted/Aligned/cent*****</b> </li>
		<li>OUTPUTS: <b>Volumes/vcla***</b> </li>
<!-- 		<li>details</li> -->
	</ul>

<li><p>Filter one or all 3D reconstructions</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="volfilt.rct">volfilt.rct</a> </li>
		<li>PARAMETERS:</li>
		  <ul>
		    <li><i>[single-class]</i> -- The default value of <i>0</i> will filter all class volumes. 
		        To filter a single volume, perhaps to fine-tune a specific class, 
		        enter the number of that class.</li>
		    <li><i>[header-type]</i>, <i>[header-param1]</i>, <i>[header-param2]</i> -- 
		        parameters for the Fourier filter</li>
		    <li><i>[override-yn]</i> -- if pre-existing doc file <b>docvolfilt</b> exists 
		        (more on this file below), setting this parameter to <i>1</i> 
		        will override the filter parameters above and 
		        will use the values in the docfile instead</li>
		  </ul>
		<li>INPUTS: <b>Zerodegr/Multiref2/listrefs</b>, <b>Volumes/vcla***</b> </li>
		<li>OUTPUTS: <b>Volumes/vflt***</b>, <b>Volumes/docvolfilt</b> </li>
		<li>The output doc file <b>docvolfilt</b> contains a record of 
		    the most recent filter parameters used.  
		    By setting the parameter <i>[override-yn]</i> to <i>1</i>, 
		    the filter parameters from this editable file will be used. </li>
	</ul>

<li><p>Align volumes to each other</p>
    
    <p>Skip this step if you have a single class.</p>
    
    <p>This procedure file aligns two volumes to each other.
       Choose one volume as an alignment reference, to which the rest of class volumes will be aligned.  
       After an initial alignment using a coarse search grid using 
       <a href="../../..//man/pj3q.html">'PJ 3Q'</a>,
       a finer search will be performed using
       <a href="../../..//man/or3q.html">'OR 3Q'</a>
       (which needs an initial estimate for optimal function).
    </p>
    
    <ul>
	<li>PROCEDURE FILE: <a href="volalignprj.rct">volalignprj.rct</a> </li>
	<li>SUBROUTINE: <a href="montageprj.rct">montageprj.rct</a> </li>
	<li>PARAMETERS:</li>
	  <ul>
	    <li><i>[exp-num]</i> -- the number for the experimental volume to align</li>
	    <li><i>[ref-num]</i> -- the number for the reference volume</li>
	    <li><i>[num-solns]</i> -- number of initial alignment solutions to compare 
	        -- multiple initial solutions may converge to the same refined solution</li>
	    <li><i>[dtheta]</i> -- angular increment for initial search, as in
		<a href="../../..//techs/recon/newprogs/refproj.spi">
		refproj.spi</a>.</li>
	    <li><i>[shift-range]</i>,<i>[shift-step]</i>,<i>[first-ring]</i> -- 2D search parameters for 
	        <a href="../../..//man/apsh.html">'AP SH'</a>, as in
		<a href="../../..//techs/recon/newprogs/apsh.spi">
		apsh.spi</a>.</li>
	  </ul>
	<li>INPUTS: <b>Volumes/vcla***</b> (reference and experimental volume to align) </li>
	<li>OUTPUTS:</li>
	  <ul>
	    <li><b>prj_***</b> -- re-projection stacks </li>
	    <li><b>dalv***</b> -- alignment parameters for each solution requested</li>
	    <li><b>vali***</b> -- aligned class volume</li>
	    <li><b>mproj***</b> -- comparison of reference projection versus 
	        initial and refined alignments, for each solution requested</li>
	    <li><b>list2merge</b> -- running list of aligned classes with preferred alignment solution
	        -- more below</li>
	  </ul>
    </ul>

    <p>The first row of each slice in <b>mproj***</b> shows the reference projection. 
       Each additional row corresponds to one alignment solution, from "best" to "worst." 
       The left-hand image is the re-projection following the initial, coarse alignment, and 
       the right-hand image is the re-projection following the refined alignment using 
       <a href="../../..//man/or3q.html">'OR 3Q'</a>.</p>
    
    <p>If the better alignment solution is not solution #1, then 
       edit in <b>list2merge</b> column #2, labelled <i>SOLUTIONNUM</i>.  
       If you do wish exclude the aligned class volume in the merging step altogether, 
       set this value to <i>0</i> in <b>list2merge</b>.</p>
       
    <p>The re-projections <b>prj_***</b> will illustrate the missing-cone artifact better than 
       isosurface presentations.</p>
    
<li><p><i>(optional)</i> Merged particles from aligned class volumes into one reconstruction</p></li>
    <ul>
	<li>PROCEDURE FILE: <a href="mergevols.rct">mergevols.rct</a> </li>
	<li>INPUTS: <b>dang-store</b>, <b>list2merge</b>, <b>dalv***</b>, 
	    <b>goodsel***</b>, <b>cent*****</b> </li>
	<li>OUTPUTS:</li> <b>Volumes/vali***</b>, <b>Volumes/docvolangles</b> 
	  <ul>
	    <li><b>dang-merged</b> -- combines particles' Euler angles with class-volume alignment angles </li>
	    <li><b>mergedsel</b> -- particle-selection file from merged classes </li>
	    <li><b>vtot999</b> -- merged volume </li>
	  </ul>
	</ul>

    <p>If the parameter <i>[classvols-yn]</i> is set to 1, 
       volumes for each class will be reconstructed of the form <b>vtot***</b>,
       using the merged Euler angles. 
       They should look very similar to the <b>vali***</b> reconstructions from the previous step, 
       <a href="volalignprj.rct">volalignprj.rct</a>, although 
       in this case the volume will have undergone one fewer interpolation.</p>
    
    <p>You will probably want to filter the reconstruction(s) from this step. 
       Edit <a href="volfilt.rct">volfilt.rct</a> to operate on the <b>vtot***</b> volume(s).</p>
    

<li><p>Prepare files for reference-based alignment</p></li>
	<ul>
		<li>Before running this step, download the reference-based alignment tarball and untar it by typing:
		    <pre>tar -zxvf spiproject.tar.gz</pre>
		This will create a new directory called <i>myproject</i><BR>
		If you rename that directory, remember to change the output in this ensuing procedure file accordingly.</li>
		<li>PROCEDURE FILE: <a href="prepare-prjmatch.rct">prepare-prjmatch.rct</a> </li>
		<li>INPUTS: <b>lots</b> </li>
		<li>OUTPUTS: <b>lots</b> </li>
		<li><p>This procedure file will copy information in a form that can be understood by the 
		    <a href="../../..//techs/recon/mr.html">
		    reference-based alignment protocol.</a>
		    Begin with the section entitled 
		    <a href="../../..//techs/recon/mr.html#SH">
		    "Alignment"</a> with the step 
		    <a href="../../..//techs/recon/newprogs/sel_by_group.spi">
		    sel_by_group.spi</a>. </p>
		    
		    <p>We have not (yet) implemented CTF-correction for the tilted-specimen particle images 
		    (we will be using only the tilted images), so we will be ignoring the CTF.  
		    (Adjust your expectations for the resulting reconstruction accordingly.) 
		    For the steps that present the option of accounting for the CTF or not 
		    (such as 
		    <a href="../../..//techs/recon/newprogs/apshgrp.spi">
		    apshgrp.spi</a> vs.
		    <a href="../../..//techs/recon/newprogs/apsh.spi">
		    apsh.spi</a>), use the version that does not take into account the CTF (in this example, 
		    <a href="../../..//techs/recon/newprogs/apsh.spi">
		    apsh.spi</a>).</p></li>
	</ul>

<hr />

<b><p>Miscellaneous procedure files</p></b>

<li><p>Projection onto convex sets</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="procedurelink">procedurename</a> </li>
		<li>INPUTS:         <b>input</b> </li>
		<li>OUTPUTS:        <b>output</b> </li>
		<li>details</li>
	</ul>

<!--<li><p>DESCRIPTION</p></li>
	<ul>
		<li>PROCEDURE FILE: <a href="procedurelink">procedurename</a> </li>
		<li>INPUTS: <b>input</b> </li>
		<li>OUTPUTS: <b>output</b> </li>
		<li>details</li>
	</ul>-->


</ul>

<hr />

<b><p>References</p></b>
<ol>
    <li>
        Radermacher M, Wagenknecht T, Verschoor A, Frank J. 
        (1987) Three-dimensional reconstruction from a single-exposure, random conical tilt series applied to 
        the 50S ribosomal subunit of <i>Escherichia coli</i>.
        <i>J Microsc.</i>  <b>146</b>:113-36.</li>

    <li>Shaikh TR, Gao H, Baxter WT, Asturias F, Boisset N, Leith A, and Frank J. (2008) 
        SPIDER image-processing for single-particle reconstruction of biological macromolecules from electron micrographs.
        <i>Nature Protocols</i> <b>3</b>: 1941-74.</li>

    <li>Huang T, Shaikh TR, Gupta K, Contreras-Martin LM, Grassucci RA, Van Duyne GD, Frank J, Belfort M .
        (2011) The group II intron ribonucleoprotein precursor is a large, loosely packed structure. 
        <i>Nucleic Acids Res.</i> <b>39</b>: 2845-54.</li>
</ol>

<hr />

</body>
</html>


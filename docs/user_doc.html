<html>
<head>
   <title>SPIDER: WORKING WITH SPIDER - A USER'S GUIDE</title>
   <link rel='stylesheet' href='user.css' type='text/css' />
   <link rel='stylesheet' type='text/css' href='./buttons.css' />

</head>

<body>
<!-- Begin Buttons -->
<table>
<tr>
  <td><a href="./spider.html"                 id="spider">    </a></td>
  <td><a href="./user_doc.html"               id="work">      </a></td>
  <td><a href="./operations_doc.html"         id="index">     </a></td>
  <td><a href="./documents.html"              id="help">      </a></td>
  <td><a href="./faq.html"                    id="faq">       </a></td>
  <td><a href="./documents.html#2D"           id="techs">     </a></td>
  <td><a href="./techs/recon1a/Docs/mr1.html" id="recon">     </a></td>
  <td><a href="./formats.html"                id="menu">      </a></td>
  <td><a href="./installation.html"           id="install">   </a></td>
  <td><a href="./release.html"                id="new">       </a></td>
  <td><a href="https://spider-em.github.io/Web" id="web"> </a></td> 
</tr>
</table>
<br><hr>
<!-- End Buttons -->


<p></p>
<h2 align="center">WORKING WITH SPIDER - A USER'S GUIDE</h2>

<p>This Guide covers issues relating to the syntax, conventions,
   and running of SPIDER.  It also has a section that discusses
   <a href="#procedures">procedures</a> and how to write them.</p>

<p><a href="errors.html">Error handling</a>, 
   specialized <a href="documents.html">techniques and tools</a>,
   details on <a href="formats.html">file formats</a>, and 
   <a href="installation.html">distribution and installation</a>, and
   <a href="release.html">release notes</a>
   are discussed elsewhere.</p>

<p>This guide is organized under the following headings:
<ul>
<li><a href="#interactive">Running SPIDER Interactively</a>
	<ul>
	<li><a href="#starting">Starting a Session</a></li>
	<li><a href="#cmd_line">Optional Command Line Parameters</a></li>
	<li><a href="#input_cmd">The Operation Input Status</a></li>
	<li><a href="#input_info">User-Solicited Information</a></li>
            <ul>
            <li><a href="#file_names">File Names</a></li>
            <li><a href="#file_handling">File Handling</a></li>
            <li><a href="#file_opening">File Opening</a></li>
            <li><a href="#file_image">Image File Storage</a></li>
            <li><a href="#file_inline">Inline Files</a></li>
            <li><a href="#file_stack">Image Stack Files</a></li>
            <li><a href="#file_inline_stack">Inline Stack Files</a></li>
            <li><a href="#indexed_stack">Indexed Stack Files</a></li>
            <li><a href="#params">Parameter Values</a></li>
            </ul>
	<li><a href="#completion">Completion of an Operation</a></li>
	<li><a href="#ending">Ending a SPIDER Session</a></li>
	<li><a href="#file_nonimage">Non-Image files used by SPIDER</a></li>
            <ul>
            <li><a href="#file_results">RESULTS File</a></li>
            <li><a href="#file_log">LOG File</a></li>
            <li><a href="#file_doc">Document Files</a></li>
            </ul>
	<li><a href="#variables">Variables</a>
	<li><a href="#register_variables">Register (Numerical) Variables</a>
            <ul>
            <li><a href="#registers_input">Register Variables as Input Parameters</a></li>
            <li><a href="#registers_output">Register Variables as Output Parameters</a></li>
            <li><a href="#registers_saving">Saving and Unsaving Register Variables</a></li>
            </ul>
	<li><a href="#pocketcalc">SPIDER's Pocket Calculator</a></li>
            <ul>
            <li><a href="#arithmetic">Arithmetic Operations</a>
            <li><a href="#expressions">Expressions</a>
            <li><a href="#math_functions">Mathematical Functions</a>
            </ul>

	<li><a href="#symbolic_variables">Symbolic (String) Variables)</a>

	<li><a href="#comments">Comments</a></li>
	</ul>

<li><a href="#procedures">Running SPIDER in Procedure Mode</a></li>
	<ul>
	<li><a href="#control">Procedure Control Files</a></li>
	<li><a href="#arguement">Argument Transfer</a></li>
	<li><a href="#execution">Execution Rules</a></li>
        <li><a href="#parameter">Parameter & Variable Transfer</a></li>
	<li><a href="#writing">Writing Interactive Procedures</a></li>
            <ul>
            <li><a href="#using_register">Using Register Variables in Nested Procedures</a></li>
            </ul>
	<li><a href="#loops">DO-Loops</a></li>
            <ul>
            <li><a href="#loops_filenames">Variable Filenames in DO-Loops</a></li>
            <li><a href="#loops_variables">Variable Parameter Input Inside DO-Loops</a></li>
            </ul>
	<li><a href="#proc_loops">Procedure Calls in DO-Loops</a></li>
	</ul>


<li><a href="#memory">Memory Allocation & Multiprocessors</a></li>

<li><a href="#unix">Submitting Batch Jobs on UNIX systems</a></li>
</ul> 

<hr />

<p>SPIDER can be run either interactively or in a procedure mode.
   Interactive mode means that user input on the terminal is solicited by
   messages appearing on  the  screen.  In the procedure mode, control
   input is taken from a procedure control file where it has to appear in
   exactly the same sequence as in an interactive session.</p>

<h2><a name="interactive">Running SPIDER Interactively</a></h2>

<p>We call a session the entire sequence of operations  from
   the  start  of  SPIDER  to  the  execution  of  the 
   <a href="man/en.html">EN</a> (End) operation.</p>

<a name="starting"><h3>Starting The Session</h3></a>

    	<p>Log on in your directory, then start SPIDER by typing:
            <dl>
            <dd>spider</dd>
            <dd>&nbsp;&nbsp;&nbsp;or</dd>
            <dd>spider &lt;Prj&gt;/&lt;Dat&gt;</dd>
            </dl></p>

        <p>SPIDER will then print some introductory information including:
            <dl>
            <dd>The version number and version issue date.</dd>
            </dl></p>

        <p>If the PROJECT/DATA EXTENSION is not given on the command line,
	   SPIDER will then respond with:
            <dl>
	    <dd>.ENTER PROJECT/DATA EXTENSION:
                  &lt;Prj&gt;/&lt;Dat&gt; </dd>
            </dl></p>

        <p>The  project  extension &lt;Prj&gt;  consists  of  a  three
	letter sequence, e.g, 'GLS', is used to identify procedure
	files, the LOG  file, and the RESULTS file  by attaching this
	sequence to the file names as an extension.</p>

        <p>The data extension &lt;Dat&gt; is optional.  It consists of a  three
        letter sequence, e.g., 'SCI', and is used to identify the data
        files by attaching this sequence to  data  file  names  as  an
        extension.</p>

        <p>For example, an image file specified as <i>'ACF001'</i>  during
        the  SPIDER  session will have as a full filename <i>'ACF001.SCI'</i>
        if the above data extension <i>'SCI'</i> is used.</p>

        <p>A file created as an output file of  a  SPIDER  operation
        will  have  the  &lt;Dat&gt;  extension  attached to its SPIDER file
        name.  If no data extension is given, the system uses  the  project
        extension as data extension.</p>

        <p>[Note that the new extension operation 
        <a href="man/nc.html">NC</a> (New  Code)
        may  be  used  within  the  SPIDER run to redefine the project
        extension/data extension.]</p>

        <p>If more than one SPIDER session is being run in the same
        directory, different project extensions should be used.</p>

        <p>Each input line typed by the user is echoed by SPIDER  on
        the subsequent line so that typing errors become apparent.</p>

        <p>Each line produced by SPIDER that requires input is
        preceded by a period, e.g., '.INPUT FILE:'.</p>

<a name="cmd_line"><h3><dt>Optional Command Line Parameters</dt></h3></a>

        <p>SPIDER can accept optional command line parameters
         in addition to the PROJECT/DATA EXTENSION.</p>
  
            <dl><dl>
            <dt>procedure</dt>
            <dd> Initial procedure to be run when starting SPIDER. 
                 The '@' sign is necessary.</dd>

            <dt> Result file version number</dt>
            <dd> Version number for the results file created by 
                 the SPIDER run.  This will superceed the value
                 determined by incrementing current version number.</dd>

            <dt> Variable assignments.</dt>
            <dd> Inital variable assignments when starting SPIDER.
                 These assignments will be inherited by any 
                 inital procedure. The variable names do NOT have
                 to be enclosed in '[]' on this line.</dd>
            </dl></dl></p>

            <p><dl>
            <dt>An example of a SPIDER run with optional command line 
                parameters follows:</dt>
            <dd><i> spider prj/dat @procname 17 loop=3 size=4</i></dd>
            </dl></p>

<a name="input_cmd"><h3>The Operation Input Status</h3></a>

        <p>The  system  now  asks:
            <blockquote>
            .OPERATION:
            </blockquote></p>

        <p>All available operations are specified  by two or more
        letter operations, e.g. <a href="man/li.html">LI</a>
        for Listing selected rows of an image.  A list of the operations
        and their meanings is available in the
	<a href="operations_doc.html">index of operations</a> which
        is part of this SPIDER documentation.  You may want to
        obtain a hardcopy listing and post it next to your
	terminal for reference.]</p>

<a name="input_info"><h3>User-Solicited Information</h3></a>

        <p>After an operation is entered, additional information needed
        to carry out the operation is solicited from the user.  This
        information may be grouped into the following
        categories:  (a) File information on input and output (mostly
        image) files, and  (b) Values of parameters.  These types of
        input are described in what follows.</p>

 <a name="file_names"><h4>File  Names</h4></a>

        <p>These  are  sequences of alphanumeric characters,   
        often  (but not  necessarily) of the form &lt;ABC&gt;&lt;###&gt; 
        where &lt;ABC&gt;  is any sequence of three or more
        characters  (the  prefix),  and  &lt;###&gt;  is three or more digit
        number.  If this convention is followed, files can be easily accessed
        under  control  of  SPIDER  <a href="#loops">DO-loops</a>.  The file name
        (without extension) can have  up  to  77  characters  and  the
        prefix  can  contain  directory information. For example,
        <i>../usr/myself/A12BCDE001</i> is an acceptable filename. In order to
        still support a legacy naming convention <b>do not use the letter
        'x' or 'X' within file names</b> or you may get odd substitutions. </p>

        <p>SPIDER can substitute for any portion of the file name at
	run time using a  value contained in a 
        <a href="#symbol">symbolic variable</a> or
        <a href="#registers">register variable</a>. Any text entered as part of a 
        filename which is enclosed between "{" and "}" or "[]" brackets is 
        presumed to be part of a desired substitution request.</p>

        <p>To substitute a symbolic variable value into a file 
        name, place the sequence symbol at the desired location within the
        filename.  E.g. if the the file name entered is: ABC[file_suffix],
        and the content of symbolic variable: [file_suffix] is the value
        <i>_rotated</i>, then the resulting file name is: ABC_rotated.</p>

        <p>To substitute a register variable value into a file 
        name, use the sequence {****[register_var]} where the "*" string
        denotes the number of digits for the substitution and the "[register_var]" 
        denotes the register variable whose numerical value is to be substituted 
        in place of the astericks.  E.g. if the the file name entered is: 
        ABC6{***[filenum]} and the run time content of register variable [filenum] 
        is the value: 
        <i>34</i>, then the resulting filename is: ABC6034.
        This mechanism can also be used inside a 
        <a href="#loops">DO-loop</a> to substitute 
        the current DO-loop index value into a filename.</p>

        <p>There may be any number of substitution strings within a single
	filename, e.g. the following is a valid filename: 
        /usr/dir{*[dirnum]}/abcd{****[filenum]}, if the value in [dirnum]
	only contains a single digit and the value in [filenum] has less than
	5 digits.  If the register variable value (converted to an integer) to 
        be substituted contains more digits
	than the number of astericks specified an <b>error will occur</b>.</p>

        <p>A few SPIDER operations such as <a href="man/apsh.html">AP SH</a>  
        are designed to operate on a whole series of images.  In this case
        the user is asked for a file name template in which the variant portion
        of the file name is indicated by astericks '*'.  E.g. a file name 
        template: dir/ABC****.   The user is also
        prompted for a list or (document file) containing the numbers of the
        files to be operated on.  This
        same formalism may be used in procedures.</p>

 
       <p>The full file name is the base character string  amended
        with  .&lt;Dat&gt;,  where  &lt;Dat&gt;  is the data extension specified at the
        beginning of the session.</p>

        <p>The use of the  character '*'  as  the  first  character
        (subsequent ones are ignored) of the file name terminates the
        current operation and makes the system ready to accept  a  new
        operation.   Some  operations with implied DO-loops continue to
        solicit input files until the escape character '*' is used  as
        a file name.  Examples include <a href="man/ad.html">AD</a> and  
	<a href="man/su.html">SU</a>.</p>

   <a name="file_handling"><h4>File Handling</h4></a> 
 
        <p>The file whose  name  is  typed  in  is either an input
        or an output file.</p>

        <p>Input files are assumed to exist and contain data used as
        input  to the operation.  The fact that a file is input to the
        operation does not necessarily exclude changes to the file;
        An example of an operation that alters the input file is 
        <a href="man/ppll.html">PP LL</a> (Put Lines in image from 
        doc file).</p>

        <p>Output files can be either files that already  exist, or
        files that are to be created under the name specified by the
        user.  Already existing files having the same name are
        overwritten without a warning message!</p>

        <p>The dimensions of the output file are dependent on the
        operation, and are either copied from the input file (e.g
        <a href="man/sh.html">SHift</a>, <a href="man/rt.html">RoTate</a>)
	or are solicited from the user (e.g.
        <a href="man/ip.html">InterPolate</a>, <a href="man/wi.html">WIndow</a>).</p>

<a name="file_opening"><h4>File Opening</h4></a>
  
        <p>After each input file or output file specification,  
        SPIDER will attempt to open the file.  After the file is opened, 
        a statement is written on the terminal which has the following 
        form:</p>

        <blockquote>
           <p>&lt;ABC###&gt; /&lt;Title&gt;<br>
               (&lt;T&gt;) &lt;NX&gt; &lt;NY&gt; &lt;NZ&gt; 
               CREATED &lt;Date&gt;  AT
               &lt;Time&gt; &lt;D&gt; HEADER BYTES: &lt;BYTES&gt; </p>
        </blockquote>

        <p>Where:</p>
           <blockquote>

           <dl>
           <dt>&lt;ABC###&gt;</dt>
           <dd>Is the file name.</dd>

           <dt>&lt;Title&gt;</dt>
           <dd>Is a title entered by the user with <a href="man/tt.html">TT</a>.</dd>

           <dt>&lt;T&gt;</dt>
           <dd>Is the data type code and has the following values:

              <table padding-left="12%" cellpadding="2">
              <tr><td>'O2'</td><td>Mixed radix -2D Fourier data 
                      corresponding to odd-length real image data.</td></tr>
              <tr><td>'E2'</td><td>Mixed radix -2D Fourier data 
                      corresponding to even-length real image data.</td></tr>
              <tr><td>'O3'</td><td>Mixed radix -3D Fourier data 
                      corresponding to odd-length real volume data.</td></tr>
              <tr><td>'E3'</td><td>Mixed radix -3D Fourier data corresponding 
                      to even-length real volume data.</td></tr>
              <tr><td>'R2'</td><td>2D real image data.</td></tr>
              <tr><td>'R3'</td><td>3D real volume data.</td></tr>
              <tr><td>'S2'</td><td>Stacked 2D real image data.</td></tr> 
              <tr><td>'S3'</td><td>Stacked 3D real volume data.</td></tr> 
              <tr><td>'I2'</td><td>Indexed, stacked 2D real image data.</td></tr> 
              <tr><td>'I3'</td><td>Indexed, stacked 3D real volume data.</td></tr>
              </table></p>

              <p>The data type code in the file label is used to prevent
              operations inconsistent with the data format from
              being carried out (e.g., Real data cannot be
              inversely Fourier transformed).</p>

           <dt>&lt;NX&gt;,&lt;NY&gt;,&lt;NZ&gt; </dt>
           <dd>Is the number of sampling points (columns),
                    number of rows, and number of slices in the
                    image.  In the case of Fourier transforms, 
                    the numbers correspond to those of the 
                    transformed image.</dd>

           <dt>&lt;Date&gt;,&lt;Time&gt;</dt> 
           <dd>Is the date and time of file creation.</dd>

           <dt>&lt;D&gt; </dt>
           <dd>Is the disposition of the file.  The following codes 
               are used:

               <dl> 
               <dd>'N' if file is newly created<br>
                   'O' if file is old
               </dl></dd>

            <dt>&lt;BYTES&gt;</dt>
            <dd>is the number of bytes in the SPIDER header for
                this file</dd>
        </dl>
        </blockquote>

        <p>Example --- :
           <table class="opl">
           <tr><td><a href="man/pt.html">PT</a></td><td> ; Put pixel in image</td></tr>
           <tr><td>PIC001</td> <td> ; Output file</td></tr>
           <tr><td>44,44</td>  <td> ; X and Y size</td></tr>
           <tr><td>P</td>      <td> ; Put point</td></tr>
           <tr><td>1</td>      <td> ; Number of points</td></tr>
           <tr><td>20,20</td>  <td> ; Location</td></tr>
           <tr><td>N</td>      <td> ; Do not continue</td></tr>
           </table></p> 

        <p> Gives output: <br />
        PIC001 <br />
        (R )   44   44 CREATED 08-NOV-2005 AT 12:26:40  N HEADER BYTES: 1056 </p>
 
        <p>In case of abnormal termination of the session, the  user  should
        carefully check the opening information of all files that were
        open when the program failed.  This will tell him/her  if  the
        image  format  was  correct, and if the correct image file has
        been accessed.</p>

  <a name="file_image"><h4>Image File Storage</h4></a>

        <p>The exact format in  which  images and volumes  are stored
	on disk along with their headers, and the contents of the
	headers is detailed <a href="formats.html#image">elsewhere</a>.
	The only operation that  accesses the image or volume files by
	explicit record numbers is <a href="man/li.html">LI</a>
	(List). This operation is useful for dumping image contents 
        or for debugging purposes.</p>

<a name="file_inline"><h4>Inline Files</h4></a>

        <p>Many SPIDER uses involve the creation of temporary image
        files which undergo further processing later in the
	session.  Computer access to these files is faster when they
	are kept in memory instead of being written out to disk.  A
	inline file is referred to as:  <i>_#</i>.  Where <i>_#</i>
	is one to three underscore symbol(s) followed by one or two
	digits.  Any such file is stored in memory as an "inline file".
	Ninety-nine inline files are available and they can hold any size
	image. An example of a filename that denotes an inline file
	number <i>2</i> is: <i>_2</i>.</p>

<a name="file_stack"><h4>Image Stacks</h4></a>

     <p>Multiple images can be stored within a single SPIDER "stack
     file".  A stack file differs from a SPIDER volume in that each
     image keeps its own full header. A stacked image is referred to
     as:  &lt;ABC&gt;@&lt;###&gt; where &lt;ABC&gt; is a
     sequence of alphanumeric characters and &lt;###&gt; is a sequence
     of digits. The digits after the '@' symbol represent the image
     number within a stack.  Stacked images can be used anywhere a
     normal SPIDER file name would be used.  An example of a filename
     that denotes image number <i>4056</i> inside stack file
     <i>fil001</i> is: <i>fil001@4056</i>.</p>

<a name="file_inline_stack"><h4>Inline Stack Files</h4></a>

     <p>Inline stack files are available and should be useful on 
     machines with large physical memory. An inline stacked image is 
     referred  to as: &lt;_#&gt;@&lt;###&gt;.  Where &lt;_#&gt; is 
     one to three underscore symbol(s) followed by a one or two digits 
     and <i>###</i> is a sequence of digits. The digits afer the '@'
     symbol represent the image number within a stack.
      Inline stacked images can be used anywhere a normal
     SPIDER file name would be used.  In this case, the first
     time a particular inline stack is referenced you will be asked for
     the total number of images in the stack. Alternatively, a stack can
     be created using the <a href="./man/ms.html">MS</a>  (Make Stack) 
     operation.
     An example of a filename that denotes image number <i>4056</i>
     inside inline stack number two is: <i>_2@4056</i>.</p>

<a name="indexed_stack"><h4>Indexed Stack Files</h4></a>

     <p>Both disk based and inline stack files are available with
     an index and may be  used like normal SPIDER stack files. An
     indexed stack may be useful if you have a sparsely populated large
     stack.  In an indexed stack there is an extra set of records 
     following the overall header that stores the indices.  Unlike a
     normal stack there is no space wasted for a missing image in
     the stack.  For indexed stacks the first
     time a particular indexed stack is referenced you will be asked for
     the maximum number of any image in the index.  For indexed inline
     stacks this number is usually different
     from the maximum number of images that can be held in the stack.
     An indexed stack 
     can only be created using the <a href="./man/msi.html">MS I</a> or
     <a href="./man/cpi.html">CP I</a> operations.</p>

<a name="params"><h4>Parameter Values</h4></a> 
 
        <p>Values of parameters solicited by an operation can be real, 
        integer, or alphanumeric.  Alphanumeric parameters are  used  to  
        specify options (e.g., (S)ine or (C)osine).</p>

        <p>Real and integer parameters are read in without
        formatting  rules;  they can be at any place on the line,
        separated by commas or any number of blanks, and spread  out
        over any number of (non-blank) lines.  They are checked for
        correct type and possible typing errors.  Such errors and type
        inconsistencies result in an error message:</p>

             <p><dl>      
             <dd>.BAD INPUT PARAMETER(S).  RE-ENTER:</dd>
             </dl></p>

        <p>The user then has to re-enter the entire line containing the
        error.  For example, in <a href="man/ip.html">IP</a> (InterPolate), 
	the user enters the dimensions of the output file:</p>

             <p><dl>     
             <dd>41 50.0</dd>
             </dl></p>
    
        where only integer input is allowed.  After the error message,
        the user has to re-enter:</p>
             <p><dl>              
             <dd>41 50</dd>
             </dl></p>

<a name="completion"><h3>Completion of an Operation</h3></a>

        <p>After successful completion of the operation, the  system
        returns to the  operation input status, by printing  the
        solicitation message '.OPERATION:' on the screen.</p>

<a name="ending"><h3>Ending a SPIDER Session</h3></a>

        <p>If you want to terminate the session, you sign  off  with
        the  <a href="man/en.html">EN</a> operation. 
	SPIDER then responds with the terminal message:
               <dl>  
               <dd>**** SPIDER NORMAL STOP</dd>             
               </dl></p>

<a name="file_nonimage"><h3>Non-Image files used by SPIDER</h3></a>

        <p>SPIDER produces  two  files  as  a  result  of  the  user
        session:  the <a href="#file_results">RESULTS</a> file and the 
	<a href="#file_log">LOG</a> file. For some operations SPIDER 
        also produces and/or uses <a href="#file_doc">document files</a>.</p>

<a name="file_results"><h4>RESULTS file</h4></a>  

        <p>During an interactive  session,  any  listings  generated
        that are too lengthy to be listed at the terminal are written
        instead to the RESULTS file, RESULTS.&lt;Prj&gt;.&lt;Version&gt;. 
        Where &lt;Version&gt; is a sequential version number applied
        by SPIDER to differentiate successive runs within a directory. 
        This file also
        contains the protocol of any procedure started interactively.</p>

        <p>During a procedure session, the  RESULTS  file  contains  the
        protocol of the operation sequence executed, as well as lists
        generated by it in their logical order.</p>

        <p>The <a href="./man/md.html">'MD'</a> operation with 'VB OFF' 
        with option: <i>Verbose Off</i> can be used to decrease the amount of output
        from DO-loops, file opening, and from the 'SD' and 'UD IC' operations.
        This can decrease the length of RESULTS files by thousands of 
        lines in long procedures.</p>

        <p>The <a href="./man/myfl.html">'MY FL'</a> operation can be used 
        to force a write from any accumulation in the systems output buffer 
        to the RESULTS file.</p>

<a name="file_log"><h4>LOG file</h4></a>
 
        <p>The  LOG  file, LOG.&lt;Prj&gt;, is a complete record of
        everything that has been typed in by the user during an
        interactive session.  It is sometimes useful as a record  of
        the session.</p>

<a name="file_doc"><h4>Document files</h4></a>

        <p>Document files are keyed, <a href="docfile.html">formatted</a>, 
        sequential files  created  by
        executing  the  <a href="man/sd.html">SD</a> operation and certain 
        additional operations.  Document files are used to  permanently
        store  the  contents  of  a  group  of  register variables (e.g., shift
        coordinates, angles, etc.) as  realized  in  different  images
        (specified  by  keys).  Any subsequent SPIDER run can retrieve
        these variable values by their keys.</p>

        <p>Document files are also used for communication between Web
        and SPIDER.  For example the "Particle Picking" operation in Web
        creates a set of document files used by certain operations in
        SPIDER.</p>

	<p>Document files may also be used to switch  on  and  off  the
	execution  of procedure files, or include/exclude images of  a
	series  from processing depending on the result of previous
	operations. </p>

<a name="variables"><h3>Variables</h3></a>
 
        <p>Two types of variables are available in SPIDER. 
         <a href="#register_variables">Register (numerical) Variables</a> 
         can contain any floating point value. 
         <a href="#symbolic_variables">Symbolic (String) Variables</a> are strings of
         characters.  
         Both types of variables are denoted with '[]' brackets. You should
         <b>not</b> simultaneously use the same variable name for both a 
         symbolic variable 
         and a register variable within a single procedure.  Variable names can 
         contain alphanumeric characters plus
         '_' and '-'.  Variable names should start with a alphabetic letter not
         a digit.  Other special characters including a blank
         may work but are not supported and may cease to work in the
         future. Names are case-sensitive.</p>

<a name="register_variables"><h4>Register Variables</h4></a>

        <p><i>Register variables</i> are used for storing and transferring 
        numerical values during a SPIDER session. Internally they are stored as 
        double precison values.  Register variables now have user specifed names. 
        These variables are denoted with '[]' brackets e.g. [pi].  <small>For
        backward compatibility we still allow the use of the numerical register
        notations (e.g. X11) present in older releases of SPIDER, but we recommend that
        you switch to this newer convention.</small>    
        The number of register variables may be increased using the 
        <a href="man/md.html">MD</a> operation with option "SET VARS". 
        However the number of usable register variables in SPIDER is 
        also limited by the combined length of all the defined variable names 
        and this limit can only be increased by recompiling SPIDER.  However 
        the amount is quite generous.</p>

        <p>Register variables may appear in 
        <a href="#arithmetic">arithmetic expressions</a>, and
	<a href="#math_functions">mathematical functions</a>.</p>

        <p>A register variable can be created in five ways:</p>

	<p><ol>
           <li>By being explicitly set equal to a value or a value from an 
               arithmetic expression, e.g. 
               <i> <a href="man/var.html">[var]</a> = 34.0</i>.   </li>

           <li>As output resulting from an operation, e.g.
               <i> <a href="man/var.html">UD IC</a> 10,[var]</i>.   </li>

           <li>When used as an index in a <a href="#loops">do-loop</a>, e.g. 
               <i> <a href="man/do.html">DO</a> [var]=1,10</i>.   </li>

           <li>Using the <a href="man/rr.html">RR</a> operation, e.g.
               <i> <a href="man/rr.html">RR</a> [var]</i>.   </li>

           <li>When received as a <a href="#argument">procedure argument</a> from
               a calling procedure. </li>

	</ol></p>

        <p>Example --- 1:</p>

        <p>When SPIDER  asks  '.OPERATION:', the user may explicity create and set
           a register variable:</p>

             <p><table class="opl">
             <tr><td> <a href="man/var.html">[pi] = 3.14159</a> </td></tr>
             </table></p>

        <p>Register variable <i>pi</i> will then  take on  the  value:  3.14159. 
        To examine  the  contents  of a variable, the user need only type
        the name of the variable he/she wishes to examine.  
        E.g. enter: [pi] at the operation prompt and the value of variable
        [pi], 3.14159, will be printed on the terminal or in the RESULTS file.</p>

        <p>Example --- 2:</p>

        <p>Some operations can create and set a register variable:</p>

             <p><table class="opl">
             <tr><td><a href="man/fs.html">FS</a> [max]</td> 
                 <td> ; Read image maximum into variable [max]</td></tr>
             <tr><td>FIL008</td> <td> ; File name</td></tr>
             </table></p>


        <p>Example --- 3:</p>

        <p>A '<a href="man/do.html">DO Loop</a> can create and set a register variable:</p>

             <p><table class="opl">
             <tr><td><a href="man/rr.html">DO</a> [img]=1,100</td> 
                 <td> ; Loop to set [img] from 1...100</td></tr>
             </table></p>


        <p>Example --- 4:</p>

        <p><a href="man/rr.html">RR</a> can create and set a register variable:</p>

             <p><table class="opl">
             <tr><td><a href="man/rr.html">RR</a> [pi]</td> 
                 <td> ; Read variable</td></tr>
             <tr><td>3.14159</td> <td> ; Variable value</td></tr>
             </table></p>

        <p><small>Older releases of SPIDER used numerical system registers called 
        x0...x100 for storing register variables. These system registers
        were denoted by the appearance of the 'x' or 'X' followed by digits. For
        backward compatibility we still allow the use of the numerical system
        register notation present in older releases of SPIDER, but we suggest  
        that you switch to this newer convention with named register variables.  
        Registers: X0...X10 contained special values.
        X0 contained the most recent content of the DO-loop index (updated
        after each execution of the <a href="man/enddo.html">ENDDO</a> or
        <a href="man/lb.html">LB</a># statement). 
        Register: X9 held an Error flag (0 if no error occurred and 1 if an 
        error occured in the most recent operation).
        You will still see numerical system registers in use in many procedures 
        distributed with SPIDER.  The values of all the numerical system register 
        variables could be saved and retrieved using the 'SR' operation.  
        The 'SR' operation is no longer available in SPIDER.
        </small>.</p>     


 <a name="registers_input"><h4>Register variables (or Arithmetic Expressions) as 
             Input Parameters</h4></a>

	<p>Register variables or arithmetic 
        <a href="#expressions">expressions</a>  containing register variables 
        may be used wherever integer or floating point values
	are solicited by operations.</p>

        <p>Example --- 1:
           <table class="opl"></p>

       <p><tr><td>[size]=33</td>     <td> ; Create register variable</td></tr>
           <tr><td><a href="man/mo.html">MO</a></td><td> ; Create model image</td></tr>
           <tr><td>PIC002</td>        <td> ; Output file</td></tr>
           <tr><td>[size], [size]</td><td> ; Image x and y size</td></tr></tr>
           <tr><td>T</td>             <td> ; Sine wave image</td></tr>
	</table></p> 

        <p>Here the contents of register variable: [size] are interpreted as
	   X and Y size of image.</p>

        <p>Example --- 2:</p>
           <table class="opl">
           <tr><td>[offset]=29</td>                 <td> ; Create register variable</td></tr>
           <tr><td><a href="man/sh.html">SH</a></td><td> ; Shift image</td></tr>
           <tr><td>PIC002</td>                      <td> ; Input file</td></tr>
           <tr><td>PIC003</td>                      <td> ; Output file</td></tr>
           <tr><td> ([size]-[offset]), SQR([size]-2)</td><td> ; Shifts </td></tr>
	</table></p> 
 
        <p>Here each arithmetic <a href="#expressions">expression</a> 
        is evaluated  first,
	and  the resulting  values are interpreted as components of
	a shift vector.</p>

        <p>Note that the register variable is always a floating point
        number. If read in as an integer, the closest integer value
        is used, e.g. 4 for 3.8, 3 for 3.2, -4 for -4.25, etc.</p>


   <a name="registers_output"><h4>Register Variables as Output Parameters</h4></a>

        <p>Some operations such as <a href="man/fs.html">FS</a>, and  
	<a href="man/pk.html">PK</a> allow the
        specification  on the operation line of  register variables to accept 
        output parameters. <a href="man/pk.html">PK</a> is  an  operation that 
        searches for the peak positions in a file.  It allows
        specification of output parameters on the operation line (in the  example, 
        [locx] and [locy]) where the peak coordinates are to be stored.   These 
        variables may be used by subsequent operations needing floating  point or
        integer parameter input. A minus sign may be used to invert the sign of 
        the value input from a variable.</p>

        <p>Example --- :
            <p><table class="opl">
            <tr><td><a href="man/pk.html">PK</a> [locx],[locy]</td></tr>
            <tr><td>PIC001</td>  <td> ; Input file</td></tr>
            <tr><td>1</td>       <td> ; Number of peaks to be found</td></tr>

            <tr><td> </td></tr>
            <tr><td><a href="man/sh.html">SH</a></td><td> ; Shift</td></tr>
            <tr><td>PIC001</td>         <td> ; Input file</td></tr>
            <tr><td>PIC003</td>         <td> ; Output file</td></tr>
            <tr><td>-[locx],-[locy]</td><td> ; Shifts </td></tr>
            </table></p> 

 <a name="registers_saving"><h4>Saving and Unsaving Register Variables</h4></a>

        <p>Any number of register variable values can be saved in a permanent file 
        using the <a href="man/sd.html">SD</a> (Save Document) operation. 
        A subsequent <a href="man/ud.html">UD</a> or <a href="man/udic.html">UD IC</a> 
        operation issued in a different (or the same) session, refering  to the same 
        document file, retrieves these variable values.  For details on saving
        and unsaving variables, see the <a href="man/sd.html">SD</a>,
        <a href="man/ud.html">UD</a> and <a href="man/udic.html">UD IC</a> manual 
        chapters.</p> 

 <a name="pocketcalc"><h3>SPIDER's Pocket Calculator</h3></a>

        <p>SPIDER incorporates a "pocket calculator" 
	which evaluates 
        <a href="#arithmetic">arithmetic operations</a>,
	<a href="#expressions">expressions</a>, and
	<a href="#math_functions">mathematical functions</a>.</p>

  <a name="arithmetic"><h4>Arithmetic Operations</h4></a>

	 <p>At the operation prompt in SPIDER, the user may
         type:</p>

            <p><table class="opl">
            <tr><td>2*3+5</td></tr>
            </table></p>

        <p>SPIDER will then respond with '11.0000'.</p>

	<p>Available arithmetic operations are:</p>

            <p> <table border="0">
            <tr><td> + </td><td>Addition</td></tr>       
            <tr><td> - </td><td>Subtraction</td></tr>        
            <tr><td> * </td><td>Multiplication</td></tr>       
            <tr><td> / </td><td>Division</td></tr>            
            <tr><td> ** </td><td>Exponentiation</td></tr>
            <tr><td><a href="#math_functions">Mathematical function</td><td>  </td> </tr>       	
            </table></p>

 <a name="expressions"><h4>Expressions</h4></a>

        <p>Expressions can be used within the SPIDER calculator and
        also in certain operations such as 
        <a href="man/if.html">IF</a>,  
        <a href="man/if_goto.html">IF...GOTO</a>,  
        <a href="man/if_then.html">IF... THEN</a>, and  
        <a href="man/elseif_then.html">ELSEIF... THEN</a>.</p> 
 
	<p>Expressions are evaluated from left to right with
        standard rules of precedence with one important exception:
        <b>a string of adjacent arithmetic operators are not allowed</b>. 
        In addition, the user may
        specify negative numbers and parentheses just as he/she would
        normally.  For example, if the user typed:</p>

            <p> <table class="opl">
            <tr><td>(3*(-2))*(2+6)</td></tr>
            </table></p>

        <p>SPIDER would respond with '-48.0000'.</p>

        <p>Scientific notation (i.e., 2.3E-4) is allowed.</p>

        <p>These operations may be used to manipulate register variables as well.
        For example, if the user typed the following sequence:</p>

            <p> <table class="opl">
            <tr><td>[var]=4.1</td></tr>
            <tr><td>2*[var]</td></tr>
            </table></p>

        <p>SPIDER would respond with 8.2000. </p>

        <p>In addition, the user may set a register variables equal to the
        value of an expression. For example, if the user typed:</p>

            <p> <table class="opl">
            <tr><td>[var]=9.6</td></tr>
            <tr><td>[var]=[var]+5</td></tr>
            </table></p>

        <p>SPIDER would store the value: 14.6 in [var].</p>

        <p>If the user types an expression  that  does  not  conform
        with  the syntax rules of the conversion routines, SPIDER will
        respond with:</p>

            <p><dl> 
            <dd>*** ERROR: INVALID ARITHMETIC EXPRESSION</dd>
            </dl></p>

        <p>Examples of valid expressions are:</p>

            <p> <table class="opl">
            <tr><td><dt>
            <tr><td>2*(-6)</td></tr>
            <tr><td>((3+6)*(7*3))**9.1</td></tr>
            <tr><td>[var0]=([var1]+7)*([var2]/[var2])</td></tr>
            <tr><td>[var1]=3.4e-4*6.0</td></tr>
            </table></p>

        <p>Examples of invalid expressions are:</p>

            <p> <table class="opl">
            <tr><td>[var]=(2+3</td><td> ; [Unbalanced parenthesis]</td></tr>
            <tr><td>(2+3/6))  </td><td> ; [Unbalanced parenthesis]</td></tr>    
            <tr><td>2*-6      </td><td> ; [Adjacent arithmetic operators]</td></tr>
            <tr><td>2*(-6E2)  </td><td> ; [No dot in the number]</td></tr>
            <tr><td>1 - 4     </td><td> ; [No blanks allowed inside]</td></tr>
            </table></p>

   <a name="math_functions"><h4>Mathematical functions</h4></a>

	<p>Available mathematical functions are:</p>
            <p><dl><dd>
            <table border="0")
	    <tr><td>PAD(&lt;Expression&gt;)  </td><td> Next highest power of two of expression</td></tr>	
            <tr><td>SIN(&lt;Expression&gt;)  </td><td> Sine of expression                     </td></tr>
            <tr><td>COS(&lt;Expression&gt;)  </td><td> Cosine of expression                   </td></tr>
            <tr><td>EXP(&lt;Expression&gt;)  </td><td> Exponential of expression              </td></tr>
            <tr><td>LOG(&lt;Expression&gt;)  </td><td> Logarithm (Base 10) of expression      </td></tr>
            <tr><td>LON(&lt;Expression&gt;)  </td><td> Natural log of expression              </td></tr>
            <tr><td>SQR(&lt;Expression&gt;)  </td><td> Square root of expression              </td></tr>
            <tr><td>INT(&lt;Expression&gt;)  </td><td> Truncates to integer                   </td></tr>
            <tr><td>ABS(&lt;Expression&gt;)  </td><td> Absolute value of expression           </td></tr>
            <tr><td>ATA(&lt;Expression&gt;)  </td><td> Arc tangent of expression (in degrees) </td></tr>
            <tr><td>ASI(&lt;Expression&gt;)  </td><td> Arc sine of expression (in degrees)    </td></tr>
            <tr><td>ACO(&lt;Expression&gt;)  </td><td> Arc cosine of expression (in degrees)  </td></tr>
            <tr><td>TAN(&lt;Expression&gt;)  </td><td> Tangent of expression                  </td></tr>
            <tr><td>RAN(&lt;Any variable&gt;)</td><td> Pseudo random uniform number generator in range from 0 to 1.   </td></tr>
            <tr><td>RNN(&lt;Any variable&gt;)</td><td> Pseudo random number generator, with normal distribution (0,1).</td></tr>
  	    </table></dd></dl></p>

      <p>where  &lt;Expression&gt;  stands for any   
           <a href="#expressions">valid SPIDER math expression</a>.</p>

      <p>All trigonometric functions use arguments (or give results) in degrees.</p>

      <p>Examples of valid usage:</p>

         <table class="opl")
	    <tr><td>[var] = SIN(4.5/([var]-100.))                          </td>
	    <tr><td>[var] = EXP(-400./[var1]**2)                           </td></tr>		
	    <tr><td>[var] = [var1]-SIN(45./180.*[var2])                    </td></tr>
	    <tr><td>[var] = SIN(45./180.*[var1])                           </td></tr>
	    <tr><td>[var] = [var1] - COS(LON([var2]))                      </td></tr>
 	    <tr><td>[var] = RAN([dummy])                                   </td>
                <td> ; Value of [dummy] not altered nor used for anything! </td></tr>
	    <tr><td>IF (INT([i]/2)==[i]/2) [even] = 1 	
                <td> ; Finding even/odd                                    </td></tr>
         </table></p>

 <a name="symbolic_variables"><h3>Symbolic (String) Variables</h3></a>

        <p><i>Symbolic (String) Variables</i> are denoted with '[]' brackets e.g. [filename].
        The number of symbolic variables in SPIDER is dependent upon the combined
        length of the variable names and their associated values and can only
        be increased by recompiling SPIDER.  However the amount is quite generous.
        Symbolic variables are used for storing and substituting character strings.
        Symbolic variables can be  either <i>global</i> or <i>local to a procedure</i>.
        Symbolic variables are commonly used to store file names.
        Symbolic variables can be nested so as to contain register variables or other symbolic variables.
        A symbolic variable can be created in the following ways:</p>

	<p><ol>
           <li>Explicitly <a href="man/var.html"> setting the symbolic variable </a> 
               equal to a string value.  
               <small>Older releases of SPIDER used the obsolete  
               <a href="man/frl.html">FR L</a> and <a href="man/frg.html">FR G</a>'
               operations for this purpose.  </small></li>

            <li>Using: <a href="man/fr.html">FR</a> operation which creates a
               local symbolic variable by reading the value from a calling procedure or the
               interactive session.</li>

           <li>Using: ?PROMPT?[variable] which creates a local symbolic variable by 
               reading the value from a calling procedure or the
               interactive session.</li>

           <li>When received as a <a href="#argument">procedure argument</a>.</li>
        </ol></p>

        <p>Example --- 1:</p>

            <p><table class="opl">
            <tr><td><a href="man/var.html">[filename]</a> = 'PIC001'</td><td>; Set a string variable</td> </tr>
            </table></p>

            <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            <small> This is equivalent to the obsolete sequence: </small>
            <table class="opl">
            <tr><td><small><a href="man/frl.html">FR L</a></small></td>
                <td><small>; Set a string variable</small></td></tr>
            <tr><td><small>[filename]PIC001</small></td></tr>
            </table>

        <p>Example --- 2:</p>
            <table class="opl">
            <tr<td><a href="man/var.html">[filename]</a> = 'PIC{***[filenum]}'</td>
               <td>; Set a string variable</td></tr>
            <tr><td><a href="man/var.html">[filenum]</a> = 2</td> 
                <td>; Set a register variable</td> </tr>

            <tr><td><a href="man/fi.html">FI</a></td>
                <td>; File information operation</td></tr>
            <tr><td>[filename]</td>                  
                <td>; File name</td></tr>
            </table>

        &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Where [filename] will be resolved at run time to: <i>PIC002</i></p>
        </p>

        <p>Example --- 3:</p>

            <p>
            <table class="opl">
            <tr><td>GLOBAL <a href="man/var.html">[dir]</a> = 'img' </td>               <td>; Set a global string variable</td></tr>
            <tr><td>GLOBAL <a href="man/var.html">[global_file]</a>= '[dir]/IMG055'</td><td>; Set a global string variable</td></tr>

            <tr><td>VM</td><td>; Echo current value for the global string variable</td></tr>
            <tr><td>echo [global_file]</td><td> </td><td></tr>
            </table>
          &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;At run time will output: <i>img/IMG055</i></p>
        </p>

        <p>Other uses of symbolic variables are discussed in the 
           <a href="#procedures">Procedure Mode</a> section below.</p>

 <a name="comments"><h3>Comments</h3></a>

      <p>A comment is a non-executable statement that will  simply  be
      printed out in the RESULTS file.  Comments may be inserted anywhere 
      during a SPIDER run, including on any lines that carry SPIDER
      operations and parameters, but they are usually used only in 
      SPIDER procedure files. 
      A comment is initiated with a semicolon ';' and anything appearing
      on a line after a semicolon is ignored during processing.  A comment
      has the form:</p>

           <p><blockquote>
           ; This is a comment
           </blockquote></p>

     <p>Examples ----:</p>

           <p><table class="opl">
           <tr><td><a href="man/pd.html">PD</a></td><td>; Now pad input image </td></tr> 
           <tr><td>PIC001</td>                      <td>; From previous window            </td></tr>
           <tr><td>PAD005</td>                      <td>; Output will be used for FT      </td></tr>
           <tr><td>128,128</td>                     <td>; Next power of two dimensions    </td></tr>
           <tr><td>Y</td>                           <td>; Use average for padding         </td></tr>
           <tr><td>1,1</td>                         <td>; Top left coord. arbitrary in this case</td></tr>
           </table></p>

<hr />

<h2><a name="procedures">Running SPIDER in Procedure Mode</a></h2>

   <a name="control"><h3>Procedure Files</h3></a>

        <p>Procedure files are user-created files or scripts containing
        sequences of operations and parameter values.  Procedure files
        can have any alphanumeric name up to 77 characters but the
        name must begin with a letter.  Instead of taking
        the input from the terminal, SPIDER uses the control sequence
        as it appears in the procedure file.  All output that would
        normally appear on the terminal is directed to the RESULTS
        file, and no <i>LOG</i> file is created.</p>

        <p>To invoke a procedure when SPIDER asks '.OPERATION:', 
        the  user  types an "at" sign <i>@</i> 
        followed by the name of the procedure file without its extension.</p>  

            <table class="opl">
            <tr><td>.OPERATION: @ALIGN10</td></tr>
            </table>

        <p>Procedures may be called:</p>

            <p><ol>
            <li>From another procedure.</li>
            <li>From an interactive session.</li>
            <li>At initial SPIDER startup.</li>
            </ol></p>

	<p>If a procedure is called from interactive session, when a
	'RE' operation is encountered inside a procedure, control
	will return to the terminal.  If a procedure is called from
	another procedure file, control will be passed  to the
	operation following the procedure call.</p>

       <p>Procedure files can be used in many different styles within SPIDER including:</p>

            <p><ol>
            <li>As <a href="./techs/recon1a/Docs/mr1.html">standalone processing control.</a></li>
            <li>Under control of <a href="https://github.com/spider-em/spire"> Spire </a>.</li>
            <li>In an <a href="#writing">interactive session.</a></li>
            </ol></p>


<a name="execution"><h4>Execution Rules</h4></a>
	
       <p>Some standard  procedures  are  contained  in the 
       SPIDER system's procedure directory 'spider/proc' 
       with the extension <i>'spi'</i>.  
       These procedures form the standard procedure library for SPIDER.</p>

       <p>For any procedure call, SPIDER will first scan the user's
       directory.   If  a procedure file under the given name
       is found, then this procedure is used in  the  call.
       If  no  such  procedure is found, SPIDER will attempt to
       locate the given file with a <i>.spi</i> extension in the SPIDER 
       system's procedure directory.</p>

<a name="argument"><h4>Register Variable Argument Transfer</h4></a>

        <p>To pass initial arguments from the procedure caller to the
        called procedure, the user puts the
        arguments  (if  any)  needed  by  the procedure behind the
        procedure name, enclosed in parenthesis, in the same order  as  they  
        appear  in  the
        called procedure file. Procedures may pass up to 12 
        register variable arguments if
        these  are  matched  by  a  defining  argument sequence in the
        procedure called.  The defining argument sequence must  appear
        as the first line of the called procedure, and must be of the 
        form:</p>

            <table class="opl">
            <tr><td><b>(</b>[&lt;N1&gt;],[&lt;N2&gt;],[&lt;N3&gt;],...<b>)</b></td></tr>
            </table>

        <p>Where: [&lt;N1&gt;],[&lt;N2&gt;],[&lt;N3&gt;],...  are register variables  
        appearing  in  the procedure.  
        <small> NOTE: Prior to 2004 '[]' brackets were used instead of '()'.</small> 
        The calling sequence must have the same number of
        registers, and must be of the form:</p>

            <table class="opl">
            <tr><td>@&lt;PROCNAME&gt;><b>(</b>[&lt;M1&gt;],[&lt;M2&gt;],[&lt;M3&gt;],...<b>)</b>.
            </table>

        <p>Register variable values are passed in both  directions;
        i.e., from the upper to the lower level and vice-versa.</p>

       <p>Example ---  :</p>

       <p>If the procedure <i>TEST_ARGS</i> is defined as follows:</p>
            <table class="opl">
            <tr><td>([v10],[v11],[v12])</td></tr>
            <tr><td>[v10]=[v10]*2</td></tr>
            <tr><td>[v11]=[v11]*[v12]</td></tr>
            <tr><td>[v12]=[v12]/2</td></tr>
            <tr><td><a href="man/re.html">RE</a></td></tr>
            </table>

        <p>invoking <i>TEST_ARGS</i> as follows:</p>

            <table class="opl">
            <tr><td>[v20]=1</td></tr>
            <tr><td>[v30]=5</td></tr>
            <tr><td>[v40]=-4</td></tr>
            <tr><td>@TEST_ARGS([v20],[v30],[v40])</td></tr>
            </table>

        <p>will result in the following values within the caller:</p>
            <table class="opl">
            <tr><td>[v20] = 2</td></tr>
            <tr><td>[v30] = -20</td></tr>
            <tr><td>[v40] = -2</td></tr>
            </table>

<a name="parameter"><h4>Symbolic (String) Variable Transfer to Procedures</h4></a>

        <p>There are two methods to pass symbolic variables to a called procedure.</p>

	<ol>
        <li><p>Replace the desired parameters inside the called procedure
           with  a solicitation prompt and variable name for the parameters.
           Place the variable names behind the procedure  calling statement in the 
           exact same order  as  they  will be queried  in  the 
           called procedure. Inside the called procedure
           indicate that the variables  should be obtained from the caller by placing a 
           solicitation prompt enclosed in question marks followed by a symbolic variable
           name  e.g., ?ROTATION ANGLE?[angle] in place of the variable that 
           the user wishes to read.</p>

           <p>If the procedure <i>TEST_MASTER</i> contains the following:</p>

           <p> <table class="opl">
             <tr><td>@TEST_VAR                     </td> <td> ; Procedure</td></tr>
             <tr><td>PIC002                        </td> <td> ; 1'st solicited parameter (input filename)</td></tr>
             <tr><td>30                            </td> <td> ; 2'nd solicited parameter (angle)</td></tr>
             <tr><td><a href="man/en.html">EN</a>  </td></tr></p>
           </table></p>

           <p>and procedure: <i>TEST_VAR</i> contains the following:</p>

           <p><table class="opl">
             <tr><td><a href="man/rt.html">RT</a></td> <td>; Rotate images operation</td></tr>
             <tr><td>?INPUT FILE?                </td> <td>; Solicit input  filename</td></tr>
             <tr><td>OUT007                      </td> <td>; Output filename</td></tr>
             <tr><td>?ROTATION ANGLE?[angle]     </td> <td>; Solicit rotation angle and assign 
                                                             to symbol: [angle]</td></tr>
             <tr><td><a href="man/re.html">RE</a></td></tr>
           </table></p>

	   <p>Then '.OPERATION: @TEST_MASTER will read the image PIC002, rotate it by
              30 degrees and store it in: OUT007.</p>
        </li>

        <li>
           <p>Use the <a href="man/fr.html">FR</a> operation inside the
           called procedure to create a local symbolic variable by reading its 
           value from a calling procedure.</p> 

           <p>If the procedure <i>TEST_MASTER2</i> contains the following:</p>

           <p><table class="opl">
             <tr><td>@TEST_VAR2                    </td> <td> ; Procedure</td></tr>
             <tr><td>PIC002                        </td> <td> ; 1'st solicited parameter (input filename)</td></tr>
             <tr><td>30                            </td> <td> ; 2'nd solicited parameter (angle)</td></tr>
             <tr><td><a href="man/en.html">EN</a>  </td></tr></p>
             </table></p>

           <p>and procedure: <i>TEST_VAR2</i> contains the following:</p>

           <p><table class="opl">
             <tr><td><a href="man/fr.html">FR</a></td></tr></p>
             <tr><td>?ROTATION ANGLE?[angle]     </td> <td>; Solicit rotation angle and 
                                                             assign to symbolic variable: [angle]</td></tr>

             <tr><td><a href="man/rt.html">RT</a></td> <td>; Rotate images operation</td></tr>
             <tr><td>?INPUT FILE?                </td> <td>; Solicit input  filename</td></tr>
             <tr><td>OUT007                      </td> <td>; Output filename</td></tr>
             <tr><td>[angle]                     </td> <td>; Solicit rotation angle and assign 
                                                             to symbolic variable: [angle]</td></tr>
             <tr><td><a href="man/re.html">RE</a></td></tr>
           </table></p>

	  <p>Again '.OPERATION: @TEST_MASTER2 will read the image PIC002, rotate it by
             30 degrees and store it in: OUT007.</p>
          </li>
        </ol>


 <a name="loops"><h3>DO-Loops</h3></a>

       <p>DO-Loops are control loops similar to those in FORTRAN.  
          They are initiated with the statement:</p>

           <p><blockquote>
              <a href="man/do.html">DO</a> 
                  &nbsp;&nbsp; &lt;C&gt;=&lt;M&gt;,&lt;N&gt;,&lt;O&gt;
           </blockquote></p>

      <p>and terminated with:</p>

           <p><blockquote><a href="man/enddo.html">ENDDO</a></blockquote></p>

      <p>Where:</p>

           <p><blockquote><dl>
           <dt>&lt;C&gt;</dt>
               <dd>is a <a href="#register_variables">register variable</a> 
               for the DO-loop index.</dd>
           <dt>&lt;M&gt;,&lt;N&gt;,&lt;O&gt; 
               <dd>are integers or variables defining beginning, the end of the DO-loop, 
               and the loop counting increment. 
               Successively, the index &lt;C&gt; will be assigned 
               the values &lt;M&gt;, &lt;M&gt;+&lt;O&gt, &lt;M&gt;+2*&lt;O&gt, 
               ... &lt;N&gt;.  (We advise against using  non-integers for
               these values as their definition may vary in the future.)</dd>
           </dd>
           </dl></blockquote></p>

     <p>DO-loops may be nested, but they must be distinguished by
        different index variables. Maximum nesting is depth is
        '</i>'MAXPRC'</i>'. See source file: 
          '<a href='"'../src/CMLIMIT.INC'"'>''CMLIMIT.INC'</a>' 
          for current value of '</i>'MAXPRC'</i>'. </p> 

     <p> <blockquote><small>
          Prior to SPIDER release 15.0 there was an earlier syntax for
         initiating and ending DO-Loops which is still supported but deprecated.
        <dl>
           <dt>Loops were initiated:</dt>
           <dd>
              <a href="man/do.html">DO</a> <a href="man/lb.html">LB</a>
                  &lt;L&gt;&nbsp;&nbsp; &lt;C&gt;=&lt;M&gt;,&lt;N&gt;,&lt;O&gt;
           </dd>

        <dt>and terminated with:</dt>
           <dd><a href="man/lb.html">LB</a>&lt;L&gt;</dd>

       <dt>Where:</dt>
           <dd> &lt;L&gt;&nbsp;&nbsp;
               was a one or two digit integer used for distinguishing 
               the terminating label for this DO-loop. </dd>
          </dl>
      </small></blockquote></p>

        <p>There are two basically different uses of DO-loops in an image  
        processing application:</p>

        <ol>
          <p><li> Applying the same sequence of  operations  with  the
                 same parameter values to different images,
                 distinguished by numbered file names.</li></p>

          <p><li> Applying  the  same  sequence  of  operations   with
                 different parameter values to the same image. </li></p>
        </ol>

   
<a name="loops_filenames"><h4>Variable Filenames in DO-Loops</h4></a>

     There are two conventions for entering file names containing a 
        variable numerical value:
        <ol>
        <li><p> 
          &lt;ABC&gt;{&lt;****&gt;&lt;C&gt;} &nbsp;&nbsp; E.g.:  IMG{****[filenum]} <br />
          This convention is suitable for use in self-contained procedures.</p>
        </li>
        <li><p>
            &lt;ABC&gt;&lt;****&gt;&lt;C&gt; &nbsp;&nbsp;&nbsp; E.g.:  IMG****[filenum]
            <br />
            This convention is more convenient when using 
            <a href="#template">variable filenames in interactive procedures</a>. </p>
        </li>
        </ol>
       

        Where:
            <blockquote>
            <p><dl>   
            <dt>&lt;ABC&gt;</dt>
                <dd>is a alphanumerical file prefix</dd>
            <dt>&lt;***&gt;</dt>
                <dd>denotes the number of digits to be substituted</dd>
            <dt>&lt;C&gt; </dt>
               <dd>is the DO-loop count variable defined above.</dd> 
             </dl></p></blockquote>

        <p> Example --- :</p>

         <p><table class="opl">
            <tr><td><a href="man/do.html">DO</a> [filenum]=1,4</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/mr.html">MR</a></td><td> ; Mirror operation</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; PIC{****[filenum]}          </td><td> ; Input file</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; OUT{****[filenum]}          </td><td> ; Output file</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; Y                           </td><td> ; Mirror axis</td></tr>
            <tr><td><a href="man/enddo.html">ENDDO</a>                             </td></tr>
	 </table></p>
        
 

   <a name="loops_variables"><h4>Variable Parameter Input Inside DO-Loops</h4></a>

        <p>Inside a DO-Loop, the user may either wish to enter the same
        parameter (or set of parameters) on each iteration of the loop
        or alternatively change the parameters with each iteration.</p>

        <p>As of SPIDER release 19.+, if the user wants to enter the same numerical 
        parameter(s) on each iteration of a loop the user <strong>no longer</strong> has to 
        surround the parameter(s) set with "()" parenthesis.
        If the user has confusing, legacy SPIDER procedures which require this 
        error prone capabilty then he/she can use the <a href="man/md.html">MD</a> operation
        with option: <i>() ON</i> to reactivate this legacy convention
        and require the ()'s. </p>

        <p> Current Example --- :</p>
            <p><table class="opl">
            <tr><td><a href="man/do.html">DO</a> [filenum]=1,4</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/rt.html">RT</a></td><td> ; Rotate operation</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; PIC{***[filenum]}          </td><td> ; Input file</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; OUT{****[filenum]}         </td><td> ; Output file</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; 45.                        </td><td> ; Rotation angle</td></tr>
            <tr><td><a href="man/enddo.html">ENDDO</a>                            </td></tr>
	    </table></p>
        
        <p>Here the same value  (45.) is to be used for each iteration of the loop.</p>  
 
        <p>There are various methods to change the parameter values used on 
           different iterations of the loop.  For example to successively use 
           the angles 45, 61 and 78 degrees in a <a href="man/rt.html">RT</a> 
           operation loop with the pictures PIC001, PIC002, and PIC003:</p>
 
        <p><ol>

           <li>Values may  be entered before any operation by using the
               <a href="man/rrs.html">RR S</a> operation. 

            <p><table class="opl">
            <tr><td><a href="man/do.html">DO</a>  [filenum]=1,3                  </td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/rrs.html">RR S</a> [rotang] </td><td> ; Read values</td> </tr>  
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; 45, 61, 78                </td>               <td> ; List</td>        </tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; [filenum]                 </td>               <td> ; Position within list (45,..)</td></tr>
 
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/rt.html">RT</a></td>             <td> ; Rotate operation</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; PIC{****[filenum]}          </td>             <td> ; Input file</td>      </tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; OUT{****[filenum]}          </td>             <td> ; Output file</td>     </tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; [rotang]                    </td>             <td> ; Rotation angles</td> </tr>
            <tr><td><a href="man/enddo.html">ENDDO</a>                             </td> </tr>
            </table>
            </p>
            </li>

         
            <li>Values may  be read in from a document file before any operation using the
               <a href="man/udic.html">UD IC</a> operation.</li>

            <p><table class="opl">
            <tr><td><a href="man/do.html">DO</a>  [filenum]=1,3                          </td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/udic.html">UD IC</a> [filenum], [rotang] </td><td> ; Retrieve value</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; DOC001                          </td><td> ; Document file that holds values</td></tr>
            <tr><td class="i">&nbsp; </td></tr>

            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/rt.html">RT</a></td><td> ; Rotate operation</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; PIC{****[filenum]}          </td><td> ; Input file</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; OUT{****[filenum]}          </td><td> ; Output file</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; [rotang]                   </td><td> ; Rotation angles</td></tr>
            <tr><td><a href="man/enddo.html">ENDDO</a>                                  </td></tr>
            </table>
            </p>

         </ol>

 


<a name="writing"><h4>Writing Interactive Procedures</h4></a>

        <p>Procedure files can be used in many ways within SPIDER. One such
        use is to create a interactive procedure which prompts the
        user at the terminal for relevant input when necessary.  This input
        can be customized by the procedure writer to correspond to the specific
        purpose of the procedure. To create 
        this sort of interactive procedure file the user:</p>

	    <p><ol>
            <li>Puts a solicitation message enclosed in question marks, 
               e.g., ?PICTURE TO BE ROTATED? in the procedure file 
               in place of the parameter(s) that the user
               wishes to specify at run time.</li>

            <li>Ends the precedure with a 
	       <a href="man/re.html">RE</a> operation to continue
                execution after the end of the procedure.</li>
            </ol></p>

	<p>At  execution  time, the user-specified solicitation
	messages are the only messages that will appear  on the
	terminal.</p>

      <p>Example ---  :</p>

      <p>If the procedure <i>TEST_INTER</i> is called from an
	an interactive session and contains the following: </p>

            <p><table class="opl">
            <tr><td><a href="man/ad.html">AD</a></td></tr>
            <tr><td>PIC001                      </td></tr>
            <tr><td>?PICTURE TO BE ADDED?       </td></tr>
            <tr><td>OUT001                      </td></tr>
            <tr><td>*                           </td></tr>
            <tr><td><a href="man/re.html">RE</a></td></tr>
            </table></p>

        <p>Then SPIDER will print '?PICTURE TO BE ADDED?' at the terminal and
        wait for  the user to specify the file to be added to PIC001.
        It would then add the two pictures and place the result in: OUT001, 
        and will return to interactive input.</p>
	    
        <p>Frequently, one encounters  the situation where more 
        same information is required in the procedure more than once.
        SPIDER allows the user to associate a symbolic variable with any solicitation 
        message (marked  by  a  ?...? ).  
        Later this symbolic variable can be used to instead of repeating the 
        solicitation message.</p>

      <p>Example ---  :</p>

      <p>If the procedure <i>TEST_IVAR</i> which needs to solicit the name 
        of the unaligned image twice from the user  is called from an
	an interactive session and contains the following: </p>

            <p><table class="opl">
            <tr><td>; PROCEDURE TO ALIGN IMAGE WITH REFERENCE</td></tr>
            <tr><td> </td></tr>

            <tr><td><a href="man/pd.html">PD</a></td></tr>
            <tr><td>?UNALIGNED IMAGE? [unaligned]</td><td>; Set symbolic variable</td></tr>
            <tr><td>PAD001</td>  <td> ; Output image</td></tr>
            <tr><td>66,66</td>   <td> ; Output image size</td></tr>
            <tr><td>Y</td>       <td> ; Use average for padding value</td></tr>
            <tr><td>16,16</td>   <td> ; Image location within output</td></tr>

            <tr><td><a href="man/pd.html">PD</a></td></tr>
            <tr><td>?REFERENCE IMAGE?[reference] </td></tr>
            <tr><td>PAD002</td>  <td> ; Output image</td></tr>
            <tr><td>66,66</td>   <td> ; Output image size</td></tr>
            <tr><td>Y</td>       <td> ; Use average for padding value</td></tr>
            <tr><td>16,16</td>   <td> ; Image location within output</td></tr>
            <tr><td> </td></tr>

            <tr><td><a href="man/ac.html">AC</a></td></tr>
            <tr><td>PAD001</td>  <td> ; Input image</td></tr>
            <tr><td>ALI001</td>  <td> ; Output image</td></tr>

            <tr><td><a href="man/ac.html">AC</a></td></tr>
            <tr><td>PAD002</td>  <td> ; Input image</td></tr>
            <tr><td>ALI002</td>  <td> ; Output image</td></tr>
            <tr><td> </td></tr>

            <tr><td><a href="man/or2.html">OR 2</a> [angle]</td></tr>
            <tr><td>ALI001</td> <td> ; Input image</td></tr>
            <tr><td>ALI002</td> <td> ; Reference image</td></tr>
            <tr><td>5,15</td>   <td> ; First and last ring radius</td></tr>
            <tr><td>1</td>      <td> ; Ring skip</td></tr>
            <tr><td>F</td>      <td> ; Full circle</td></tr>
            <tr><td> </td></tr>

            <tr><td><a href="man/rt.html">RT</a></td></tr>
            <tr><td>[unaligned]</td>  <td> : <b>Reuse symbolic variable that was set above</b></td></tr>
            <tr><td>?OUTPUT IMAGE?[output]</td></tr>
            <tr><td>[angle]</td></tr> 
            <tr><td> </td></tr>

            <tr><td><a href="man/re.html">RE</a></td></tr>
            </table></p>

        <p>In the interactive session the user will enter:</p>

            <p><table class="opl">
            <tr><td>.OPERATION: @TEST_IVAR</td></tr>
            <tr><td>.?UNALIGNED IMAGE?: PIC002</td></tr>
            <tr><td>.?REFERENCE IMAGE?: PIC003</td></tr>
            <tr><td>.?OUTPUT IMAGE?:    OUT009</td></tr>
            </table></p>


        <p>The second potential occurrence of ?UNALIGNED IMAGE? was  
        avoided by reusing the [unaligned] symbolic variable, which was  
        the symbolic variable assigned at the occurance of the ?UNALIGNED IMAGE? prompt.</p>

        <a name="template"></a>

        <p>Symbolic variables that represent a file name template may be modified 
        at run time by appending the value from register variable. The specified  
        digits of the filename are then replaced by new digits 
        according to the current value in the register variable.</p>

        <p>Example --- 1:</p>

        <p>If the procedure <i>TEST_NAME</i> is called from an
	an interactive session and contains the following: </p>

           <p><table class="opl">
            <tr><td> ; Procedure to list file statistics for a file series</td></tr>
            <tr><td><a href="man/fr.html">FR</a></td></tr>
            <tr><td>?ENTER IMAGE FILE TEMPLATE?[file_template]</td></tr>
            <tr><td> </td></tr>

            <tr><td><a href="man/do.html">DO</a> [filenum]=2,5</td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; <a href="man/fs.html">FS</a></td></tr>
            <tr><td class="i">&nbsp;&nbsp;&nbsp;&nbsp; [file_template][filenum]</td></tr>
            <tr><td><a href="man/enddo.html">ENDDO</a></td></tr>
            <tr><td><a href="man/re.html">RE</a></td></tr>
            </table></p>

        <p>and the user enters the following from an interactive session:</p>

            <p><table class="opl">
            <tr><td>@TEST_NAME</td></tr>
            <tr><td>PIC***</td></tr>
	    </table></p>

        <p>In the <a href="#loops">DO-loop</a>,  PIC*** will then be replaced 
           by PIC002,PIC003, ...  , PIC010.<dl>

        <p>Example --- 2:</p>

        <p>If the procedure <i>TEST_NAME2</i> is called from an
	an interactive session and contains the following: </p>

            <p><table class="opl">
            <tr><td>; Procedure to list file statistics for a file series</td></tr>
            <tr><td><a href="man/rr.html">RR</a>[filenum]
            <tr><td>?OUTPUT FILE NUMBER?</td></tr>
            <tr><td> </td><tr>

            <tr><td><a href="man/fi.html">FI</a></td></tr>
            <tr><td>PIC{***[filenum]}</td></tr>
            <tr><td><a href="man/re.html">RE</a></td></tr>
	    </table></p>

        <p>and the user enters the following from an interactive session:</p>

            <p><table class="opl">
            <tr><td>@TEST_NAME2</td></tr>
            <tr><td>5</td></tr>
	    </table></p>

        In this example, the operation <a href="man/fi.html">FI</a> 
        is applied to PIC005.<dl>

        <p>Example --- 3:</p>

        <p>If the procedure <i>TEST_NAME3</i> is called from an
	an interactive session and contains the following: </p>

            <p><table class="opl">
            <tr><td><a href="man/fr.html">FR</a></td></tr>
            <tr><td>?ENTER FILE NAME TEMPLATE? [template]</td></tr>
            <tr><td>  </td></tr>

            <tr><td><a href="man/rr.html">RR</a>[filenum]</td></tr>
            <tr><td>?PICK OUT FILE NUMBER?[filenum]</td></tr>

            <tr><td><a href="man/fs.html">FS</a></td></tr>
            <tr><td>[template][filenum}</td></tr>
            </table></p>

        <p>and the user enters the following from an interactive session:</p>

            <p><table class="opl">
            <tr><td>TEST_NAME3</td></tr>
            <tr><td>PIC***</td></tr>
            <tr><td>3</td></tr>
            </table></p>

        <p>In this example, the operation <a href="man/fs.html">FS</a> 
        is applied to PIC003.</p>


<a name="using_register"><h3>Using Register Variables in Nested Procedures</h3></a>

        <p>Normal register variables are local to a procedure and are independent the
        of register variables  within other procedures.
        Register variables can be  transferred  from a calling
        procedure to a called  procedure, using 
        <a href="#argument">argument transfer</a> or
        by using the operation: <a href="man/rr.html">RR</a>.</p>       

<hr />

<h2><a name="memory">Memory Allocation & Multiprocessors</a></h2>

    <p>Most memory intensive operations make use of run time
    allocation (and deallocation) of necessary memory.</p>

    <p>SPIDER contains Open Multiprocessing directives which can be used by 
    <i>OpenMP</i>  capable Fortran compilers.  The 
    <a href="./man/md.html">MD</a> operation with option: 'SET MP' can be used to 
    control the number of processors used during SPIDER execution on such machines. </p>

    <p>A few operations in SPIDER contain <i>MPI</i> parallelizing directives
    which can be activated by appropriate compilation.  If you are interested
    in using <i>MPI</i> please contact us for further info. 
    </p>

<hr />

<h2><a name="unix">Submitting Batch Jobs on UNIX systems</a></h2>

    <p>Unix systems have queues available for scheduling execution of
    batch jobs and methods of placing a process in the background.  Some
    old notes on this are contained in:  
    <a href="batch-unix_doc.html">batch-unix_doc.html.</a></p>

<hr /> 

<p><small>
  Source:      user_doc.html  &nbsp;&nbsp;&nbsp;  
  Last update: 27 Oct. 2018    &nbsp;&nbsp;&nbsp;
  ArDean Leith  
</small>
</p>

</body>
</html>
